<paper 0>
## Water is a radiation protection agent for ionised pyrrole

Melby Johny.1.2.3 Constant A. Schouder.-.5 Ahmed Al-Refaic. Lanhai He.l

0ss We. Hnik Sapelad, Scasta ip.L. and ocoen Kiperl.c

l Center for Free-Elciron Laser Science CFEL, Deuisches

:tronen-Synchrotron DESY, Notkestrasse 85, 22607 Hamburg, Germ:

SLID
$$
\begin{array} {l} {{a s t ~ I m a g i n g, ~ U n i v e r s i t i t ~ H a m b u r y, ~ L u r u p e r ~ C h a u s s e e e ~ 1 4 9, ~ 2 2 7 6}} \\ {{\mathrm{~ / ~ P h y s i c s, ~ U n i v e r s i t i t ~ H a m b u r y, ~ L u r u p e r ~ C h a u s s e e ~ 1 4 9, ~ 2 2 7 6 1 ~}}} \\ {{\mathrm{o f ~ C h e m i s t r y, ~ A a r h u s ~ U n i v e r i t y, ~ L a n g e l a n d s g a d e ~ 1 4 9, ~ 8 0 0 0 ~ A a}}} \\ {{\mathrm{~ / ~ L, ~ C N R S, ~ C E A, ~ U n i v e r s i t e ~ P a r i s-S a c l a y, ~ 9 I 1 9 1 ~ G i f ~ s u r-Y v e t h}}} \end{array}
$$
1 Hamburg, Germany
2 Center for Ultraf lamburg, Germany & Department of rhus C, Denmark Department e, France

Department of Cheistry, Unive
$$
\begin{array} {c} {r s i t \ddot{a} t \ H a m b u r g, \ M a r t i n-L u t h e r-K i n g-P l a t z \ 6, \ 2 0 1 4 6 \ H a m b u r g,} \\ {\mathrm{( D a t e d : \ 2 0 2 4-0 3-2 9 )}} \\ \end{array}
$$
German

Radiation-induced damage of biological matter is an ubiquitous problem in nature. The influence of the hydration environment is widely discussed, but its exact role remains elusive. Utilising well defined solvated-molecule aggregates, we experimentally observed a hydrogen-bonded water molecule acting as a radiation protection agent for ionised pyrrole, a prototypical aromatic biomolecule. Pure samples of pyrrole and pyrrole(H2O) were outer-valence ionised and the subsequent damage and relaxation processes were studied. Bare pyrrole ions fragmented through the breaking of C-C or N-C covalent bonds. However, for pyrrole(H2O)t, we observed a strong protection of the pyrrole ring through the dissociative release of neutral water or by transferring an electron or proton across the hydrogen bond. Overall, a single water molecule strongly reduces the fragmentation probability and thus the persistent radiation damage of singly-ionised pyrrole.

Elek

## INTRODUCTION

The damage of biological matter upon the interaction with UV radiation [1 or ionising radiation |2], such as x-rays [2, 3], y-rays 4], and -particles |5], or other charged particles 3, 6, 7 is a major environmental impact on living organisms [1, 2. For instance, inner-shell-, inner-valence-, or outer-valence-ionised states can relax in various pathways that form cationic species, which can result in break up of the molecules |3, 8, 9]. One highly relevant mechanism of DNA-strand breaks is via autoionisa-tion or excitation caused by low-energy secondary electrons |3, 6, 7, 10, 11.

Regarding the radiation damage of molecules, ionisa-tion and excitation are similar: In both cases, vacancies are created in the occupied molecular orbitals, and this can lead to bond breaking. In the case of ionisation, the electron is directly transferred to the continuum, leaving the molecular ion behind, while excitation may result in the population of dissociative excited states 12]. Typical sources for single ionisation of biological matter in aqueous environments are deep UV radiation or the interaction with radicals, slow electrons, or ions [2, 3, 12, 13|. While deep UV radiation is efficiently blocked by the earth's atmosphere [14] it is omnipresent in outer space [15]. Harder, e. g. ionising, radiation penetrates the atmosphere.

Molecular assemblies such as clusters, droplets, and even large molecules like proteins in their natural solvation environment are known to allow for additional relaxation pathways due to intermolecular interactions |8, 16-24. These pathways may lead to a protection of the molecule especially if the biomolecule is directly affected by the radiation [1]. On the other hand, secondary species originating from the ionisation of surrounding solvent molecules can induce new pathways that lead to biomolecular destruction.

Hydrogen-bonded solute-solvent complexes allow for quantitative investigations of these effects |25 28]. One of the important electronic relaxation channels of such solvated-molecule clusters after x-ray ionisation, electron-impact ionisation, or o-particle irradiation was ascribed to intermolecular Coulombic decay (ICD) |8, 9, 25-27, 29. This resulted in the formation of mainly charge-separated di-cationic complexes which undergo fragmentation via electrostatic repulsion. A competing ultrafast relaxation channel of hydrogen-bonded complexes after inner-shell ionisation, which may protect biomolecules, is intermolecular electron- or proton-transfer-mediated charge separation [22, 24, 27]. This was also observed following x-ray ionisation of the water dimer |28| and liquid water 30, 31.

To examine the influence of nano-hydration on the dynamics of biomolecules various studies using mass spectrometric techniques were performed |32-41 . These experiments can essentially be divided into three approaches: In the first approach one uses mass selective ion beam methods to extract individual clusters in the case of cationic and anionic samples |32, 33, 42. The initialisation of the dynamics, e. g. ionisation or collisions, is species unspecific which results in an undefined initial condition. For instance, it is not possible to avoid ionisation of the water as the initial step. The second approach of experiments utilises a localised initiation for the dynamics inside the cluster using, e.g. multi-photon ionisation |34-36 or slow electrons |37-39]. Here, however, experiments are done with mixed samples, e. g. various cluster sizes and isomers present in the molecular beam simultaneously. An unambiguous assignment of the fragments to a corresponding parent cluster is not possible. This is especially a problem in the case where the isolated molecules and the clusters give rise to the same fragments. The third approach utilises neither a well-defined probe nor a localised trigger [40, 41].

A key ingredient for the indirect destruction pathways of biological matter is the radiolysis of water 13, 43, 44, likely because typically -3/4 of a cell's volume comprises an aqueous environment |3, 13]. In this case, reactive cations, radicals, anions, or electrons are produced inside the water environment, which can trigger biomolecular fragmentation |2, 43-47. In this context, numerous experimental studies claim that the hydration environment can either inhibit or enhance radiation-induced biological damage 4, 13, 33, 35, 38, 47-52. This includes a recent study showing a relatively weak catalysis effect, i.e. an enhancement of radiation damage, due to water being present |39|. The details obviously depend on the nature of the ionising radiation and the specific potential energy landscape of the biomolecule in its hydration environment [2, 3].

Pyrrole, a heterocyclic aromatic molecule, is a UV-absorbing chromophore, e.g. in hemes and chloro-phylls |53]. Pyrrole is also a subunit of indole, 3-methylindole, and tryptophan, which are of great relevance as the principal UV absorbers of proteins 54, 55]. The photophysical and photochemical properties of indole and pyrrole are sensitive to the hydration environment 56-61|: upon UV absorption these chromophores indirectly populate an excited -no* state, which is repulsive along the N-H-stretching coordinate 54-56]. This triggers an ultrafast internal-conversion process to the ground state, essential for the photostability of proteins 62.

The pyrrole(H2O) cluster has a well-defined structure with a hydrogen bond between pyrrole's N-IH site and the water's oxygen 63. This can, due to its similarities with indole-water, reflect the strongest interaction between pyrrole and surrounding H2O in aqueous solution 64]. H-elimination dynamics from the N-H site of pyrrole, mediated by the electronic excitation of the ro* state |54, 65-67 or by vibrationally mediated photodissociation |68], was studied by time-resolved photoion and photoelectron spectroscopy. Theoretical calculations for electronically excited pyrrole(H2O) clusters predicted electron transfer across the hydrogen bond without photodissociation of the pyrrole moiety 58, 69 . Direct ionisation from the HOMO and HOMO-1 orbitals of pyrrole |70, 71 and the HOMO orbital of pyrrole(H2O) |72, 73 does not lead to fragmentation of the aromatic ring. However, the dissociation from excited cationic states of pyrrole led to molecular fragmentation |70, 71, and similar processes are expected for pyrrole(H2O).

Here, we experimentally investigated the damage incurred in singly- and doubly-ionised pyrrole molecules and the effect of solvation by comparing the fragmentation

![](figures/1-5-FIGURE.jpg)

FIG. 1. Schematic representation of the ionisation scheme and radiation-protection mechanism in pyrrole(H2O). Single ionisation of pyrrole(H2O) is followed by its dissociation, with the leaving neutral water molecule allowing the aromatic ring to stay intact without further fragmentation.

pathways of bare pyrrole and microsolvated pyrrole(H2O) heterodimers using the combination of pure samples of either species |73 and local, site-specific multi-photon ionisation. Our clean approach enables the systematic investigation of the role of water solvent on the photophysics of pyrrole and for hydrated biomolecules in general.

A schematic representation of our ionisation strategy is represented in Figure 1. We mimicked the triggering of radiation damage through outer valence ionisation as it would naturally occur in secondary processes such as the interaction with slow electrons or UV photons. Pyr-role and pyrrole(H2O) were site-specifically ionised by removing electrons from the highest-energy molecular orbitals, whose densities are predominantly localised on the aromatic ring as shown in Figure 7. The site-specific ionisation allows a direct comparison of the subsequent fragmentation of the two systems since the ionisation process is not significantly altered. Ionisation was achieved by strong-field ionisation (SFI) using 800 nm laser pulses with a peak intensity of 1014 W/cm? and a pulse duration of 30 fs, see Methods for details. On one hand, valence ionisation of bare pyrrole resulted in extensive fragmentation, i. e. breaking of the aromatic ring. On the other hand, for singly-ionised pyrrole(H2O) we mainly observed solely the breaking of the hydrogen bond with the water molecule leaving the intact pyrrole ring. In this case, breaking of the actual biomolecule is strongly suppressed.

## RESULTS

Our comparison of the fragmentation dynamics of bare and singly-microsolvated pyrrole built on the production of very pure molecular beams of pyrrole and pyrrole(H,O), respectively. The electrostatic deflector was used to spatially separate the different species by their dipole-moment-to-mass ratio from a cold molecular beam |73, 74; see Methods for details. The species-selected molecular beam had, in the case of pyrrole, a purity of -95 %, with

![](figures/2-0-FIGURE.jpg)

FIG. 2. Time-of-flight mass spectrum and corresponding velocity-map images of the ions generated by strong-field ioni-sation of pyrrole. The structure of pyrrole is given on the right of the lower panel. The colourmap and velocity scale holds for all velocity-map images.

a -5 % contamination by pyrrole homodimer. The purity of the pyrrole(H2O) beam was -99 % with the main contamination being the water dimer |73].

## Fragmentation dynamics of pyrrole

Figure 2 shows the time-of-fight mass spectrum (TOF-MS) and corresponding velocity-map images (VMIs) of all ions resulting from strong-field ionisation of pyrrole. All data were recorded simultaneously using a Timepix3 camera |75-77]. Rings in the VMIs occur for two-body Coulomb explosion, i.e. a charge-repulsion-driven fast breakup into two positively charged fragments. These fragmentation channels obey momentum conservation in the recoil frame. Low-kinetic-energy (KE) features correspond to intact parent ions or ions created from dissociative single ionisation. The data shows no signatures of three-body breakup beyond hydrogen atom/proton loss.

The most prominent feature in the TOF-MS is the narrow peak at m/a = 67 u/e, assigned to pyrrolet, on top of a broader pedestal. The peak corresponds to the sharp central dot in the corresponding VMI. The pedestal correlates with the rings in the VMI which are assigned to pyrrole from Coulomb explosion of the pyrrole ho-modimer. The TOF-MS peak at m/g = 33.5 u/e and the central dot in the corresponding VMI are assigned to doubly-ionised pyrrole. Its pedestal in the TOF-MS and the corresponding rings in the VMI were attributed to pyrrole?t from Coulomb explosion of multiply-ionised pyrrole homodimer. In both cases 95 % of the signal strengths were in the central peaks, i.e. originated from the monomer.

The signals in the mass-to-charge regions m/g = 24 ...30 u/e and m/g = 35 ...44 u/e correspond to fragments from the breakup of the pyrrole ring. Some possible ionic products are labeled in Figure 2, in line with the mass peak assignment after electron-impact- and photo-ionisation of pyrrole 70, 78. A clear assignment of the various individual peaks observed in the two mass regions to specific fragments was not possible due to overlapping signals and ambiguities in the construction of specific mass-to-charge ratios out of possible feasible fragments. The situation was further complicated by the fact that some fragments lost hydrogen atoms. However, proton loss after double ionisation was ruled out due to the lack of correlations between the detected protons and the fragments observed in the two mass regions. The small proton peak in the spectrum was attributed to initial charge states >2, which are not further discussed in the current work. The structure at m/g = 70 u/e is assigned to contributions from larger clusters. The expected m/g = 68 u/e 13C-pyrrole isotopologues peak is suppressed due to the strong parent ion signal, see Methods. Intense central peaks in the VMIs correspond to fragments from dissociative ionisation of singly-charged pyrrole. Rings in the VMIs, contributing ～30 % of the total ion count, correspond to fragments from Coulomb explosion of doubly-charged pyrrole. The Coulomb explosion signals of the m/q = 24 ... 30 u/e and m/g = 35 .. .44 u/e mass regions are correlated for the double ionization of bare pyrrole, as confirmed by kinetic-energy-selected coincidence maps and momentum conservation.

## Fragmentation dynamics of pyrrole(HzO)

Figure 3 shows the TOF-MS and VMIs of all ions resulting from strong-field ionisation of pyrrole(H2O). Again all data were recorded simultaneously using the Timepix3 detector. All VMIls exhibit a central low-KE part due to single ionisation as well as sharp or diffuse higher-KE signals.

The peak at m/g = 85 u/e, with a central dot in the VMI, corresponds to the pyrrole(H,O) parent ion. The strongest peak in the TOF-MS is again at $m / q=$ 67 u/e, the pyrrole-monomer cation, which resulted from the dissociation of the hydrogen bond in singly-ionised pyrrole(H2O). This is confirmed by its broader KE distribution in the VMI owing to recoil from the momentum conservation with the leaving neutral water molecule. Furthermore, no correlations between singly charged pyrrole ions themselves were found in the PIPICO map. We would expect to see this correlation for the higher charge states present in our data and, therefore, infer negligible contributions from pyrrole homodimers in our deflected molecular beam in line with previous studies 73, 79

The peaks at m/ = 66 ufe and m/q = 19 u/e cor-

![](figures/3-0-FIGURE.jpg)

FIG. 3. Time-of-fight mass spectrum of pyrrole(H2O) following SFI with the velocity-map images of the ions, which were recorded simultaneously after strong-field ionisation. Also shown are the structure of the heterodimer, sum formulas of all fragments, and the velocity ranges and colourmap for all velocity-map images.

respond to GAHaN and HgOt, respectively. Both fragments exhibit sharp rings in their VMIs, with correlated ions that obeyed momentum conservation, demonstrating a two-body Coulomb explosion break-up channel of pyrrole(H2O)2+ including a proton transfer from pyrrole to water. A weaker HO" channel, -3/4 of which originates from pyrrole(H2O)2+ whereas the remaining signal can be attributed to the water homodimer, shows the direct charge-separating breakup of pyrrole(H2O)2+ across the hydrogen bond.

As for pyrrole, fragments within the regions m/g = 24 ...30 u/e and m/g = 35 ...44 u/e were detected due to the breakup of the aromatic ring. However, they showed broad structureless distributions in the VMIs which were not correlated with each other. The high-KE ions in these regions originate from pyrrole(H2O)2+ after three-body fragmentation processes. These channels involved HgOt as a second ionic partner, as well as a neutral fragment. The small peak at m/q = 36 u/e was attributed to singly-ionised water homodimer ((H2O)2) 79.

## DISCUSSION

Overall, single- and double-valence ionisation of pyrrole led to a significant breakup of the aromatic ring, in addition to the formation of singly- or doubly-charged parent ions. Single ionisation of pyrrole into the 2A2 ground state and the -Bi first excited state of the cation led to the formation of a stable parent ion |70, 71]. Single ionisation also caused fragmentation of the pyrrole moiety through various dissociative pathways, which resulted in low-kinetic-energy ions. This was due to ionisation into diffuse bands of excited electronic states of the cation with energies in the range of 12.. .15 eV, i. e. around 4 eV above the ground-state energy of the cation |70, 71, 80-82. With Koopmans' theorem, the energies of these excited states match well with the ionisation energies of HOMO-2 to HOMO-6 orbitals of the pyrrole molecule 70]. Double ionisation caused fragmentation of the aromatic ring driven by Coulomb explosion.

Surprisingly, the scenario was very different for singly-and doubly-ionised pyrrole(H2O). New relaxation pathways emerged due to the hydrogen bond with the water molecule - despite the predominantly localised ionisation with the removal of electrons from pyrrole's r orbitals. For example, in the case of singly-ionised pyrrole(H2O), we observed a strong dissociation channel for the hydrogen bond, i.e. the loss of neutral water, which protected the pyrrole ring from fragmentation. Furthermore, after double ionisation additional Coulomb-explosion channels appeared for pyrrole(H2O)2t compared to pyrrolet, such as the HgO" channel with its counter ion C4H4NT Both fragments showed sharp rings in the corresponding VMIs, demonstrating that the pyrrole ring was left intact with only a proton transferred to the water moiety. Additionally, two body Coulomb-explosion channels of pyrrole(H2O)2t in the regions m/q = 24...30 u/e and m/q = 35...44 u/e, i.e. clear rings, were absent and the uncorrelated signal was much weaker than the strong signals observed for the pyrrole monomer. In total, the fragmentation pathways were significantly influenced, i. e. fragmentation of the pyrrole ring was strongly reduced by the attached single water molecule.

Single ionisation of pyrrole(H2O) into the ground state of the cation created intact parent ions with the charge localised on the aromatic moiety. The binding energy of the cationic heterodimer was determined to 670 meV |72]. The energy of the first excited state is expected to be roughly 1 eV above the ground state of the cation, as in the case of the pyrrole monomer |70, 80]. In the TOF-MS of pyrrole(H2O) after single-ionization, Figure 3, the dominant peak was m/g = 67 u/e, so a dissociation product of pyrrole(H2O)t. The pyrrole cation arose from the dissociation following single ionisation of pyrrole(H2O). Assuming a similar ionisation cross-section for pyrrole and pyrrole(H2O) into the first electronically excited state of the cation led to the conclusion that this state of pyrrole(H2O)t was dissociative. Otherwise the pyrrole(H2O) spectrum after single-ionisation would be dominated by pyrrole(H2O)-. Therefore, the aromatic ring was protected after ionisation into the ground and the first excited state of the pyrrole(H,O) cation. We also observed similar aromatic ring fragmentation products for pyrrole(H2O)t, as in the case of pyrrole", from the above-mentioned diffuse dissociation band |70, 80]. However, the relative intensities between stable aromatic rings versus fragmentation channels varied significantly for the monomer and the heterodimer, leading to a higher ring fragmentation probability for the former.

To unravel the influence of the microsolvation on the radiation-induced damage and to quantify the degree of protection for ionised pyrrole in the presence of a single water molecule, we normalised the ion yields for the pyrrole and pyrrole(H2O) species after SFI with respect to each other. We normalised both species based on their total single-ionisation ion yield by assuming the single-ionisation cross-section to be the same. This is justified by the similarity of laser-intensity-dependent single-ionisation ion yield for the two species as described in the Methods. Furthermore, the single, double, and higher-order ionisation channels were separated to provide a direct comparison of the fragmentation yields for both species as a function of the initial charge state. Corrections for saturation effects in detector areas with high count rates were statistically taken into account, see Methods. In addition, the fragmentation channels were classified into ring-fragmenting and ring-protecting channels.

The momentum maps for the specific mass-to-charge regions were taken into account in order to separate single, double, and higher-order ionisation channels. Almost all VMIs shown in Figure 2 and Figure 3 had contributions from ions with low as well as with high kinetic energy. We attribute the low-KE ions to single ionisation and the high-KE ions to double or higher-order ionisation, respectively. Gating on the momenta with p < 30 ukm/s resulted in a normalised mass spectrum (NORMS), which is a composition of single-ionisation channels and the doubly charged parent ion channel that also exhibits low kinetic energy. Gating on the momenta with p > 30 ukm/s resulted in a NORMS for the higher-order ionisation channels. The resulting normalised gated time-of-flight mass spectra for pyrrole and pyrrole(H2O), following SFI, are shown in Figure 4 for m/q = 0...60 u/e, which contain all ring-breaking fragments. The upper panel corresponds to the single-ionisation channels (z = +1), whereas the lower panel corresponds to double(z= +2) or higher(z > t2) ionisation channels.

Both species showed similar fragmentation products, especially in the mass-to-charge regions m/g = 24 .. .30 u/e and m/g= 35...44 u/e, which were the channels arising from the breaking of the pyrrole ring. However, they vastly differed in the specific ion yield and we observed a significant reduction of fragments arising from ring fragmentation for pyrrole(H2O) than for pyrrole after single ionisation. For both, pyrrole and pyrrole(H2O), following SFI, the contributions in the NORMS for z 2 +2 in the

![](figures/4-4-FIGURE.jpg)

FIG. 4. Comparison of the normalised TOF-MS of pyrrole (red) and pyrrole(H2O) (blue) following SFI. The number of charges created on the system after strong-field ionisation is denoted by z. The upper panel corresponds to an initial charge state z = -1. The peak marked with the asterisk corresponds to intact C4HsN2 from double ionisation of pyrrole. The lower section is for the charge states z > t1. Signals for m/g = 2...14 u/e in the lower section originated from initial charge states with z > t2.

region n/g = 15...60 u/e were dominated by double ionisation. This includes the large differences in the region m/g = 18...19 u/e where hydronium and water ions are formed. The contributions from triple ionisation were statistically estimated to less than 5 % and are thus negligible, see Methods. Furthermore, the NOR.MS peaks in the region m/g = 1...14 u/e originated from charge states with z > +2, confirmed by a covariance analysis. In the case of higher-order ionisation, i.e. z > 2, a direct comparison of the ion yield of pyrrole and pyrrole(H2O) after SFI from the NORMS was not feasible due to the complex fragmentation processes and overlapping fragmentation channels.

To estimate the extent of fragmentation protection after single and double ionisation of pyrrole in a microsolvated environment, the observed fragmentation channels were classified into ring-breakup and ring-protection channels. Based on this, the ring-fragmentation probability is defined as $P=N_{\mathrm{b}}$ /Ntotal with the number of fragments where the ring is broken $N_{\mathrm{b}}$ and the total ion yield Notal-

First, we considered ring-breakup and ring-protection channels following single ionisation of pyrrole and pyrrole(HzO). For pyrrole, the parent ion was considered as a channel leaving the molecule intact. For single ioni-sation of pyrrole(H2O), in addition to the parent ion, the dominant ring-protection channel was the dissociation of the hydrogen bond, i. e. the loss of neutral water. Furthermore, the dissociative single-ionisation processes resulting in low-KE ions of H,Ot, HgO ${^+}$ , and CaHAN", prevented the aromatic ring from fragmentation. All other low-KE

![](figures/5-0-FIGURE.jpg)

FIG. 5. Schematic representation of the potential energy surfaces and the first dissociation band of pyrrolet and pyrrole(H2O)" together with the ring-protection and ring-breaking probabilities. Ring-protection and ring-breaking channels are represented by blue and red colours, respectively. In the case of pyrrole(H2O)" additional relaxation pathways emerged through the cleavage of the hydrogen bond for the first dissociation band. For simplicity, only one of the observed fragments is shown for each dissociation pathway.

ions in the mass-to-charge region m/g = 15 .. .60 u/e were considered as ionic products that originated from the fragmentation of the aromatic ring. The ring-fragmentation probabilities for pyrrole and pyrrole(H2O) after single ionisation were then determined by counting the ions in the momentum-map images with a gating specifically on the low-KE part in the specific mass-to-charge regions. The projection of ions from higher charge states ( $z=+2$ ) into the center of the momentum-map images was estimated statistically, see Methods, and this contribution was subtracted.

We estimated the ring-fragmentation probability individually for pyrrole and pyrrole(H2O) after single ion-isation to 31 % and 6 %, respectively. Figure 5 provides a sketch of the corresponding potential-energy surfaces of pyrrole" and pyrrole(H2O)t with the resulting products and their probabilities. Single ionisation of pyrrole into the ground and first excited state of the cation led to the formation of a stable parent ion, pyrrole" |70, 71]. The ionised molecule underwent fragmentation through the higher excited cationic states 80, whose probability was 31 %. In the case of pyrrole(H2O), single ionisation into the ground state resulted in a stable parent ion, pyrrole(H2O)t |72]. The first excited state of pyrrole(H,O)" dissociated the heterodimer into a pyrrole" and neutral water. For the higher excited states of pyrrole(H,O)" a reduction in the ring fragmentation probability was observed. This was due to dissociative channels, where the water is leaving neutrally. Obviously, for the pyrrole monomer such channels do not exist after single ionisation.

Overall, the ring-fragmentation probability of pyrrole following single ionisation is reduced by a factor of approximately 31/6 = 5.2 in pyrrole(HzO) compared to pyrrole. Based on the observation of reduced fragmentation for pyrrole(H,O)t and the assumption of a similar cross section for single ionisation, we can infer that neutral molecules can be protected against radiation damage through outer-valence ionisation by solvation even with a specifically-bound single water molecule.

To shed light on radiation damage effects after double ionisation, we classified the channels following double ionisation of pyrrole and pyrrole(H,O). For pyr-role, the only ring-protecting channel was the formation of a (meta)stable doubly-charged parent ion, C4H5N2+, marked by the asterisks in the upper panel of Figure 4. All other channels broke the aromatic ring. The dominant ring protection channel for the pyrrole(H2O)2+ was the intermolecular proton transfer from the N-H site of the pyrrole moiety to the water moiety, producing H3O ${\mathrm{+}}$ and CaHaN". A second channel was an electron transfer process across the hydrogen bond, which led to the formation of CaHsN" and H2O". All other double-ionisation channels broke the aromatic ring, but in our experiment these were minor contributions. The ring-fragmentation probability for pyrrole and pyrrole(H2O) after double ionisation was determined by counting ions in the high-KE part of the momentum-map images while taking into account that two ions might have been produced after double ionisa-tion, leading to two hits in the corresponding momentum maps for a single fragmentation event; the finite detection efficiency of 0.5 for each ion was statistically taken into account. This led to a similar ring-fragmentation probability after double ionisation for pyrrole(H2O), $P=$ 0.72 +0.04 and pyrrole, P = 0.78 + 0.04. Furthermore, we extracted a similar double-ionisation cross-section within our model, see Methods. This observation is consistent with our previous assumption that the cross sections for single ionisation are similar for both species.

## CONCLUSION

We demonstrated that a single water molecule strongly protects the pyrrole molecule from fragmentation after single ionisation. Furthermore, we observed similar ring-fragmentation probabilities for pyrrole and pyrrole(H2O) in the case of double ionisation. These quantitative studies were enabled by the production of pure samples of the bare molecule as well as the singly-microsolvated complex and by the use of the versatile Timepix3 detector.

Singly-ionised pyrrole underwent radiation-induced damage through the breaking of, typically two, C-C or N-C bonds. Notably, the dissociation mechanisms after single ionisation of pyrrole(H2O), through breaking of the intermolecular bond or by transferring an electron or proton across this hydrogen bond, strongly reduces the ring breaking probability by a factor of 5.2. We inferred that solvation effects also provided radiation protection for the neutral pyrrole(H2O) system.

The radiation protection mechanisms for excited chro-mophores were studied both experimentally and theoretically 55, 56, 61, 62, 83. Our study showed that this protective effect observed for solvated chromophores is also valid after ionisation.

Following double ionisation similar ring-fragmentation probabilities were observed for pyrrole and pyrrole(H2O). In the microsolvated system, intermolecular proton- and electron transfer processes occurring across the hydrogen bond increased the redistribution of charges, initially created in the pyrrole ring, to the water molecule. This charge-distribution was observed through the formation of H2O" and H3O", where the counter ion is either an intact ring or a ring-fragmentation product.

We employed strong-field ionisation for the removal of electrons from the low-binding-energy molecular orbitals, which are localised on the pyrrole moiety in the monomer as well as the pyrrole-water heterodimer. This process mimies the ionisation by slow secondary electrons in aqueous systems, such as cells, as well as ionisation through VUV radiation - which both typically create singly-charged molecules since these ionisation prosesses access the same potential energy surfaces and therefore dissociative states.

Our results provide a test case of how an aqueous micro-solvation environment can strongly reduce the radiation damage of biological molecules induced by ionising radiation as well as the biologically important process of secondary effects of ionising radiation, where single outer-valence ionisation of the biomolecular chromophore is the scenario. Furthermore, the doubly-ionised systems in our experiment resemble to a large extent the fate of a molecule after Auger decay processes subsequent to direct core-shell ionisation |8, 9].

Biomolecules and proteins in nature are actively sol-vated by the surrounding water molecules, which allow for efficient charge redistribution to the solvent environment through electron- and proton transfer pathways quantified here. In aqueous solution, the loss of the attached - neutral, ionised, or protonated - water could easily be repaired by the many solvent molecules around. Our analysis of the protection in pyrrole(H2O) provides a quantitative analysis of radiation protection and serves as the basis for further detailed investigations regarding the role of the solvent environment on the radiation damage of biomolecules.

## METHODS

## Experimental Setup

Details of the experimental setup were described elsewhere 84]. A pulsed valve was operated at 100 Hz to supersonically expand a few millibars of pyrrole (Sigma Aldrich, > 98 %) and traces of water in -90 bar of helium into vacuum. The resulting molecular beam

![](figures/6-8-FIGURE.jpg)

Peak ntensty (10 W cem-)

FIG. 6. Single-ionisation yields for pure samples of pyrrole (red), pyrrole(H2O) (blue), and water (purple) measured at different laser peak intensities. All curves are normalised to their highest ion yield observed.

contained atomic helium, individual pyrrole and water molecules, and various aggregates thereof. The electric deflector, which enables the spatial separation of neutral polar molecules according to their dipole-moment-to-mass ratio |74, 85], was used to create pure samples of pyrrole(H2O) with a typical purity close to 100% 73]. Pyrrole and pyrrole(2O) were strong-field ionised by 800 nm laser pulses with linear polarisation, a duration of -30 fs, focused to 0 - 35 um (full width at half maximum intensity) with a peak intensity of ～1 x 1014 W/cm2. The ions generated were extracted perpendicular to the molecular beam and laser propagation directions using a velocity-map-imaging spectrometer (VMIS). All ions were detected using a position- and time-sensitive detector consisting of a micro-channel plate (MCP) in combination with a fast phosphor screen (P46). A visible-light-sensitive Timepix3 detector 75, 86 in an event-driven mode recorded all signals, which were stored and cen-troided using our homebuilt pymepix software |76].

## Normalisation of the mass spectra

The normalisation of the TOF-MS was necessary due to the different densities of the two species, pyrrole and pyrrole(H2O), in the molecular beam. Due to the very similar first ionisation energies (Ei) of pyrrole and pyrrole(HzO) the ionisation probabilities for both species are also very similar. The calculated (HF/MP2-aug-cc-pVTZ using GAMESS-US) first vertical $E_{\mathrm{i}}$ of pyrrole and pyrrole(H,O) are 8.59 eV and 8.15 eV, respectively. To quantify the relative ionisation probability experimentally |87, 88 the ion yield as a function of the laser peak intensity was measured for the single-ionisation channel for pyrrole, pyrrole(H2O), and water, see Figure 6. The spectrometer was defocussed in terms of VMI conditions moin1 TAMn 4

![](figures/7-0-FIGURE.jpg)

FIG. 7. Molecular orbital picture of HOMO, HOMO-1, and HOMO-4 for the geometry optimised ground state structure of the pyrrole(H2O).

to avoid saturation of the detector. The ion yield from each pure species is normalised to its value for the highest laser intensity, demonstrating that the peak-intensity-dependent shape of the curves is indeed very similar, confirming the similarity of the E; 87. In the low-intensity region, 1-8 × 10 $1 3$ W/cm?, for pyrrole only the parent ion was observed. A saturation intensity for the parent ion signal of -6 x 1013 W/cm? was obtained from the measured low-intensity ion-yield curve. For pyrrole(H,O) we summed the signals for parent ion and pyrrole |73], which yielded a saturation intensity for single ionisation of -4.5 x 1013 W/cm?. Based on the similar saturation intensities and the very comparable intensity dependence of the ionisation yields, Figure 6, we assumed similar single-ionisation cross-sections and normalised the TOF-MS of pyrrole and pyrrole(H2O) using a normalisation factor of 3.33 - 0.1. This normalisation factor is identical to the relative number densities of pyrrole and pyrrole(H2O) beam.

For the ionisation of water, we obtained a very different intensity dependence and saturation intensity, which was determined as -1.4x 1014 W /cm?. This is consistent with the larger Ei of 12.62 eV |89 and further demonstrates the similarities in the ionisation cross sections of pyrrole and pyrrole(H2O).

Highest occupied molecular orbitals of pyrrole(H2O)

The molecular orbitals calculated (GAMESS-US, HF/MP2-aug-cc-pVTZ) for the geometry-optimised ground state structure of pyrrole(H2O) are shown in Figure 7. The electron densities of HOMO to HOMO-3 are localised on the aromatic ring. The highest-energy bound molecular orbital with significant density on the water moiety is HOMO-4. This orbital has an energy that is 6.5 eV lower than the HOMO. Therefore, under the applied laser intensities ionisation from this orbital can be neglected |90| and localised ionisation of pyrrole(H2O) at the pyrrole moiety can be safely assumed.

![](figures/7-6-FIGURE.jpg)

FIG. 8. The momentum map for all ions detected within a mass-to-charge region m/q = 35...45 u/e is shown. Marked circles with specific radii in the momenta map represent edges for single, double, and triple ionisation, respectively.

## Double-ionisation yield

We compared the absolute total ion yield of the monomer and the singly-microsolvated system after double ionisation. This double-ionisation ion yield was indicated qualitatively through the comparison of the ion signals in the NORMS in Figure 4. However, a direct comparison of the yields in the TOF-MS was not straightforward due to the complex fragmentation pathways and the overlap of higher-order ionisation channels. Therefore, to quantify this, we counted the ions in the normalised momentum maps of the specific channels originating from double ionisation of pyrrole and pyrrole(H2O). The nor-malisation was done using the extracted relative number density ratios between these two species, which was based on the assumption of similar single-ionisation cross-section for both species. The direct comparison of the total double-ionisation yields revealed a reduction of the total ion yield of pyrrole(H2O), with respect to pyrrole, by a factor of 1.22 + 0.3. Thus, we concluded that the double-ionisation cross-section is also similar for pyrrole and pyrrole(H2O) within the errors of our estimation model.

## Triple-ionisation contributions

To estimate the contributions of individual ions over a given mass-to-charge range from the measured 2D projection of the 3D momenta, we made specific cuts in these experimental momentum maps in order to isolate

| radius p. | ion counts in disk | ion counts in ring | area of disk/m | area of ring/m |
| --- | --- | --- | --- | --- |
| 60 | 167522 | 167522 | 3600 | 3600 |
| 140 | 225860 | 58338 | 19600 | 16000 |
| 200 | 229120 | 3260 | 40000 | 20400 |

TABLE I. Total ion counts as well as the areas of disks and rings within specific radi chosen in the momenta map.

| charge state | ion counts | ion counts/area |
| --- | --- | --- |
| +1(single | 167522 -3.486 . 3600 - 0.1598 . 3600 = 154397 | 154397/3600=42.89 |
| +2 （double) | 58338 .(19600/16000) - 0.1598.19600 = 68332 | 68332/19600= 3.486 |
| -3（triple | 3260 (40000/20400)= 6392 | 6392/40000 = 0.1598 |

TABLE I. Number of ion counts per area of each disk, and the estimated number of ions formed after the single, double, and triple ionisation, respectively.

contributions from single, double, and triple ionisation processes.

The measured momentum map for m/g =3. ...45 u/e is shown with Figure 8 as an example. Circles indicate corresponding cuts in the 2D projection of the 3D momentum sphere formed from each ionisation process: The white circle with a radius of py. = 60 u km/s represents the edge of the momentum for dissociative single ionisation, the green circle with $p_{r}=1$ 40 ukm/s corresponds to the maximum momentum of ions from Coulomb explosion following the double ionisation, and the red circle with p, = /2 * 140 - 200 ukm/s is the maximum momentum of ions from triple ionisation, assuming a two-body fragmentation into a singly-charged and a doubly-charged ion.

The total ion count corresponding to the disks defined by these specific radii and the signal in the two outer rings are provided in Table I. Areas of the specific disks and rings are also given. Ion counts inside the outer ring, 140 < $p_{r}$ < 200, correspond to triple ionisation without contribution from single and double ionisation. However, the middle ring, 60 < p. < 140, represents the double-ionisation channels and it has contributions from triple ionisation; similarly, the innermost disk,0 < p, < 60, representing single ionisation has contributions from ions originating in double and triple ionisation. The corrected total number of ions from single, double, and triple ionisation are provided in Table II assuming a flat ion distribution in the inner part of the corresponding rings and disks. The relative contribution of the ion yield from the triple-ionisation process to the total ion yield in the given mass-to-charge region is < 5 %, i.e. negligible.

## Determination of real ion numbers taking into account detector saturation

Here, the connection between the measured number of ions Ndet and the real number of ions produced Nreal taking into account saturation effects of the detection system are discussed. The saturation efects appear, e. g. for the parent ions, pyrrole and pyrrole-water, due to the small areas on the detector where these ions are detected. The small areas are accounted for the fact that the spectrometer was operated in VMI conditions in combination with the translational molecular beam temperature below 1 K. Furthermore, all parent ions arrive on the detector at the same TOF within the temporal resolution of the Timepix3 camera. This makes it impossible to determine the real number of parent ions per shot by counting since only a single event is detected at an instant of time by our detection system. Assuming a Poissonian distribution P(Nreal) of the real ions created, however, allows to estimate the real number of ions Nreal from the detected number of ions Ndet. Table IlI summarises the numbers and probabilities of various channels. The first column indicates the parent system under investigation. The corresponding ions are listed in the second column including the fragments. The corresponding number of laser shots are denoted with Nshots. The detected hit rate per shot $R_{\mathrm{d e t}}=N_{\mathrm{d e t}} / N_{\mathrm{s h o t}}$ s indicates the probability to detect an event for a single laser shot per channel. The probability to detect O ions within a laser shot is given by P, (0) = 1 - Rdet. This value can be used to determine the mean number of ions per shot A = -ln(P (O)) according to the Poissonian distribution. The real number of ions Nreal is then given by Nreal = NshotsA. For the ring fragmentation channels, we set $N_{\mathrm{r e a l}}=N_{\mathrm{d e t}}$ due to the larger spatio-temporal volume covered by these ions on the detector. The ring fragmentation probability for pyrrole and pyrrole(H2O) after SFI taking into account saturation effects of the detection system is therefore given by $P_{\mathrm{P}}=$ (548485 + 241298)/241298 = 3.273 and Ppw = (1301176 + 159591 - 91799)/91799 = 16.912, respectively. This gives rise to a ring protection factor given by P = Ppw/Pp = 16.912/3.273 = 5.167.

| Parent molecule | Ion | Ndet | Nshots | Rdet | Px(O) | 入 | Nreal |
| --- | --- | --- | --- | --- | --- | --- | --- |
| pyrrole | pyrrole | 234626 | 270028 | 0.8688 | 0.1312 | 2.0310 | 548485 |
| pyrrole | fragments | 241298 | 270028 | 0.89360 | - | - | 241298 |
| pyrrole(H2O) | pyrrole | 926658 | 1801197 | 0.5144 | 0.4856 | 0.7223 | 1301176 |
| pyrrole(H2O | pyrrole(H2O) | 152728 | 1801197 | 0.08479 | 0.91521 | 0.08860 | 159591 |
| pyrrole(H2O) | fragments | 91799 | 1801197 | 0.05097 | - |  | 91799 |

TABLE III. Measured number of ions, probabilities, correction factors, and real number of ions

## Pyrrole and pyrrole-water isotopologue peaks

The missing isotopologue peak for pyrrole is attributed to the dead time in the order of us of the Timepix3 camera in combination with the relatively high detection rate per shot given by Rdet = 0.8688 (see Table lll) and the finite spatio-temporal resolution. The natural abundancy of C13 isotope is in the order of 1.1%. This results in an expected relative peak height in the order of 4.5% for the C13 parent ion peak due to the 4 carbon atoms present in pyrrole. Due to the dead time, we expect only C13 containing parent ions to be detected when no C12-only containing parent ion was detected before. Taken into account the ion rate per shot provided for pyrrole, results in a dead time corrected relative peak height for its isotopologue of (1 - 0.8688) . 0.045 = 0.6%. This is in the noise level of the pyrrole peak. For the doubly charged parent, ion the isotopologue peak is present in Figure 2. Here, we only have a detection rate per shot given by 0.1073. The rate for the corresponding isotopologue peak is given by 0.00381. This gives rise to a corresponding C13 containing fraction of 3.4% close to the estimate provided above. The same arguments hold for the observed isotopologue peaks in the case of pyrrole-water Figure 3. Here, due to lower count rates, the isotopologue peaks are present for CqH;N" and C4H;N(HzO)F.

## Data and materials availability

The data that support the findings of this study are awailable from the repository at https: / /doi.org/10.5281/zenodo.7857990

Code availability

The code used for the data analysis is available at https:/ /doi.org/10.5281/zenodo.7857990

## REFERENCES

* Email: sebastian.trippelQcfel.de:

Website: https://w.controlled-moleculeimaging.org 

|1] Carlos E Crespo-Hernandez, Boiko Cohen, Patrick M Hare, and Bern Kohler. Ultrafast excited-state dynamics in nucleic acids. Chem. Rev., 104:1977-2020, 2004. doi:10.1021/cr0206770. URL https: //doi.org/10.1021/ cr0206770.

|2| Shirley Lehnert. Biomolecular Action of Ionizing Radiation. Taylor & Francis, London, 2007.  doi:10.1201/9781420011920. URL https: //www.taylorfrancis.com/books/9780429145117.

3 Elahe Alizadeh, Thomas M. Orlando, and Léon Sanche. Biomolecular damage induced by ionizing radiation: The direct and indirect effects of low-energy electrons on DNA. Annw. Rew. Phys. Chem., 66 379 -398, 2015. doi:10.1146/annurev-physchem-040513-103605. URL https://www.annualreviews.org/doi/ pdf/10.1146/annurev-physchem-040513-103605.

4] T. Ito, S. C. Baker, C. D. Stickley, J. G. Peak, and M. J. Peak. Dependence of the yield of strand breaks induced by y-rays in DNA on the physical conditions of exposure: Water content and temperature. Int. J. Radiat. Biol., 63:289-296, 1993. doi:10.1080/09553009314550391. URL https://doi.org/10.1080/09553009314550391.

|5 Hong-Keun Kim, Jasmin Titze, Markus Schiffler, Flo-rian Trinter, Markus Waitz, J6rg Voigtsberger, Hendrik Sann, Moritz Meckel, Christian Stuck, Ute Lenz, Matthias Odenweller, Nadine Neumann, Sven Schissler, Klaus Ullmann-Pfleger, Birte Ulrich, Rui Costa Fraga, Nikos Petridis, Daniel Metz, Annika Jung, Robert Grisenti, Achim Czasch, Ottmar Jagutzki, Lothar Schmidt, Till Jahnke, Horst Schmidt-B6cking, and Reinhard Dorner. Enhanced production of low energy electrons by alpha particle impact. PNAS, 108:11821-11824, 2011. doi: 10.1073/pnas.1104382108. URL https://www.pnas.org/ content/108/29/11821.

6] Badia Boudaiffa, Pierre Cloutier, Darel Hunting, Michael A. Hues, and Leon Sanche. Resonant formation of DNA strand breaks by low-energy (3 to 20 eV) electrons. Science, 287(5458):1658-1660, 2000. doi: 10.1126/science.287.5458.1658. URL https://science. sciencemag .org/content/287/5458/1658.

[7 Tilmann D Mirk and Paul Scheier. Unexpected electrons. Nat. Phys., 6(2):82-83, 2010. doi:10.1038/nphys1526. URL https://doi.org/10.1038/nphys1526.

|8| T Jahnke. Interatomic and intermolecular Coulombic decay: the coming of age story. J. Phys. $B$ ,48(8):082001, 2015. doi:10.1088/0953-4075/48/8/082001. URL http: //doi.org/10.1088/0953-4075/48/8/082001.

|9| L S Cederbaum, J Zobeley, and F Tarantelli. Giant intermolecular decay and fragmentation of clusters. Phys. Rew. Lett., 79(24):4778-4781, December 1997. doi: 10.1103/PhysRevLett.79.4778. URL https://doi.org/ 10.1103/PhysRevLett.79.4778.

[10] Jack Simons. How do low-energy (0.1-2 eV) electrons cause DNA-strand breaks? Acc. Chem. Res., 39(10): 772 - 779, 2006. doi:10.1021/ar0680769. URL https: //pubs.acs.org/doi/10.1021/ar0680769.

|11| F' Martin, P. D. Burrow, Z Cai, D Cloutier, Pand Hunting, and L Sanche. DNA strand breaks induced by 0-4 eV electrons: The role of shape resonances. Phys. Rev. Lett., 93:068101, Aug 2004. doi: 10.1103/PhysRevLett.93.068101. URL https://link. aps.org/doi/10.1103/PhysRevLett.93.068101.

12] C. Y. Ng. Vacuum Ultraviolet Photoionization and Pho-todissociation of Molecules and Clusters. World Scientific Publishing Co. Pte. Ltd, 1991. ISBN 981-02-0430-2. doi:10.1142/1244. URL https://www.worldscientific. com/worldscibooks/10.1142/1244.

|13| Bruce C. Garrett, David A. Dixon, Donald M. Camaioni, Daniel M. Chipman, Mark A. Johnson, Charles D. Jonah, Gregory A. Kimmel, John H. Miller, Thomas N. Rescigno, Peter J. Rossky, Sotiris S. Xantheas, Steven D. Colson, Allan H. Laufer, Douglas Ray, Paul F. Barbara, David M. Bartels, Kurt H. Becker, Kit H. Bowen, Stephen E. Brad-forth, Ian Carmichael, James V. Coe, L. Rene Corrales, James P. Cowin, Michel Dupuis, Kenneth B. Eisenthal, James A. Franz, Maciej S. Gutowski, Kenneth D. Jordan, Bruce D. Kay, Jay A. LaVerne, Sergei V. Lymar, Theodore E. Madey, C. William McCurdy, Dan Meisel, Shaul Mukamel, Anders R. Nilsson, Thomas M. Orlando, Nikolay G. Petrik, Simon M. Pimblott, James R.. Rus-tad, Gregory K. Schenter, Sherwin J. Singer, Andrei Tokmakoff, Lai-Sheng Wang, , and Timothy S Zwier. Role of water in electron-initiated processes and radical chemistry: Issues and scientific advances. Chem. Rew., 105:355-390, 2005. doi:10.1021/cr030453x. URL https://doi.org/10.1021/cr030453x.

|14 Dan Lubin and Elsa H. Jensen. Effects of clouds and stratospheric ozone depletion on ultraviolet radiation trends. Nature, 377:710-713, 1995. doi:10.1038/377710a0. URL https://doi.org/10.1038/377710a0.

15] Martin A. Barstow and Jay B. Holberg. Ewtreme Ultrawvi-olet Astronomy. Cambridge University Press, Cambridge, 2003. doi:10.1017/CBO9780511536144.

|16| Thomas Schultz, Elena Samoylova, Wolfgang Radloff, Ingolf V Hertel, Andrzej L Sobolewski, and Wolf-gang Domcke. Efficient deactivation of a model base pair via excited-state hydrogen transfer. Science, 306 (5702):1765-8, December 2004. ISSN 1095-9203. doi: 10.1126/science.1104038. URL https://www.science. org/doi/10.1126/science.1104038.

|17 Chongand Fang, Renee R. Frontiera, Rosalie Tran, and Richard A. Mathies. Mapping GFP structure evolution during proton transfer with femtosecond ra-man spectroscopy. Nature, 462:200-204, 2009. doi: 10.1038/nature08527. URL https://doi.org/10.1038/ nature08527.

18 Dominik Marx, Mark E. Tuckerman, Jiirg Hutter, and Michele Parrinello. The nature of the hydrated excess proton in water. Nature, 397:601-604, 1999. doi: 10.1038/17579. URL https://doi.org/10.1038/17579.

|19| Amir Golan, Ksenia B. Bravaya, Romas Kudirka, Oleg Kostko, Stephen R Leone, Anna I. Krylov, and Musahid Ahmed. Ionization of dimethyluracil dimers leads to facile proton transfer in the absence of hydrogen bonds. Nat. Chem., 4:323-329, 2012. doi:10.1038/nchem.1298. URL https://doi.org/10.1038/nchem.1298.

[20] D. A. Horke, H. M. Watts, A. D. Smith, E. Jager,
E. Springate, O. Alexander, C. Cacho, R. T. Chapman,
and R.. S. Minns. Hydrogen bonds in excited state proton
transfer. Phys. Rev. Lett., 117(16):163002, October 2016.
doi:10.1103/PhysRevLett.117.163002. URL http://link.
aps.org/doi/10.1103/PhysRevLett.117.163002.

[21] M Mudrich, A C LaForge, A Ciavardini, P O'Keeffe,
C Callegari, M Coreno, A Demidovich, M Devetta, M Di
Fraia, M Drabbels, P Finetti, O Gessner, C Grazioli,
A Hernando, D M Neumark, Y Ovcharenko, P Piseri,
O Plekan, K C Prince, R Richter, M P Ziemkiewicz,
T Mdller, J Eloranta, M Pi, M Barranco, and F Stienke-
meier. Ultrafast relaxation of photoexcited superfluid
He nanodroplets. Nat. Commwn., 11:112, 2020. doi:
10.1038/s41467-019-13681-6. URL https://doi.org/10.
1038/s41467-019-13681-6.

[22] Petr Slavicek, Nikolai V Kryzhevoi, Emad F Aziz, and Bernd Winter. Relaxation processes in aqueous systems upon x-ray ionization: Entanglement of electronic and nuclear dynamics. J. Phys. Chem. Lett., 7(2):234-243, jan 2016. doi:10.1021/acs.jpclett.5b02665. URL http: //pubs.acs.org/doi/10.1021/acs.jpclett.5b02665.

[23] Mario Barbatti, Adélia J. A. Aquino, Jaroslaw J. Szym-czak, Dana Nachtigallova, Pavel Hobza, and Hans Lis-chka.. Relaxation mechanisms of UV-photoexcited DNA and RNA nucleobases. PNAS, 107(50):21453-21458, 2010. doi:10.1073/pnas.1014982107. URL https://www.pnas. org/content/107/50/21453.

|24 J Zobeley, R. Santra, and L S Cederbaum. Electronic decay in weakly bound heteroclusters: Energy transfer versus electron transfer. .J. Chem. Phys., 115(11):5076-5088, 2001. doi:10.1063/1.1395555. URL https://doi. org/10.1063/1.1395555.

|25| X. Ren, E. Wang, A. D. Skitnevskaya, A. B. Trofi-mov, G. Kirill, and A. Dorn. Experimental evidence for ultrafast intermolecular relaxation processes in hydrated biomolecules. Nat. $P h y s.$ , 79:1745, 2018. doi: 10.1038/s41567-018-0214-9. URL https://doi.org/10. 1038/s41567-018-0214-9.

[26] T. Jahnke, H. Sann, T. Havermeier, K. Kreidi, C. Stuck, M. Meckel, M. Schifler, N. Neumann, R. Wallauer, S. Voss, A. Czasch, O. Jagutzki, A. Malakzadeh, F. Afaneh, Th. Weber, H. Schmidt-Bcking, and R.. Dorner. Ultrafast energy transfer between water molecules. Nat. Phys., 6(2):139-142, January 2010. doi:10.1038/nphys1498. URL http://www.nature.com/ doifinder/10.1038/nphys1498.

|27| Shenyue Xu, Dalong Guo, Xinwen Ma, Xiaolong Zhu, Wentian Feng, Shuncheng Yan, Dongmei Zhao, Yong Gao, Shaofeng Zhang, Xueguang Ren, Yong-tao Zhao, Zhongfeng Xu, Alexander Dorn, Lorenz S. Cederbaum, and Nikolai V. Kryzhevoi. Damaging intermolecular energy and proton transfer processes in alpha-particle-irradiated hydrogen-bonded systems. Angew. Chem. Int. Ed., 57(52):17023-17027, 2018. doi: 10.1002/anie.201808898. URL https://onlinelibrary. wiley.com/doi/abs/10.1002/anie.201808898.

|28| Clemens Richter, Daniel Hollas, Clara Magdalena Saak, Marko Firstel, Tsveta Miteva, Melanie Mucke, Olle Bjirneholm, Nicolas Sisourat, Petr Slavitek, and Uwe Hergenhahn. Competition between proton transfer and intermolecular Coulombic decay in water. Nat. Commun., 9: 4988, 2018. doi:10.1038/s41467-018-07501-6. URL https: //www.nature. com/articles/s41467-018-07501-6.

|29| Melanie Mucke, Markus Braune, Silko Barth, Marko $\mathrm{F}$ 6rs-tel, Toralf Lischke, Volker Ulrich, Tiberiu Arion, Uwe Becker, Alex Bradshaw, and Uwe Hergenhahn. A hitherto unrecognized source of low-energy electrons in water. Nat. Phys., 6:143-146, 2010. doi:10.1038/nphys1500. URL https://www.nature.com/articles/nphys1500.

[30] Stephan Thiirmer, Milan Oncak, Niklas Ottosson, Robert Seidel, Uwe Hergenhahn, Stephen E. Bradforth, Petr Slavitek, and Bernd Winter. On the nature and origin of dicationic, charge-separated species formed in liquid water on X-ray irradiation. Nat. Chem., 5:590-596, 2013. doi: 10.1038/nchem.1680. URL https://doi.org/10.1038/ nchem.1680.

[31] Petr Slavitek, Bernd Winter, Lorenz S. Cederbaum, and Nikolai V. Kryzhevoi. Proton-transfer mediated enhancement of nonlocal electronic relaxation processes in X-ray irradiated liquid water. .J. Am. Chem. Soc., 136(52): 18170-18176, June 2014. doi:10.1021/ja5117588. URL https://doi.org/10.1021/ja5117588.

[32] Francis Berthias, Linda Feketeova, Henry Cher-mette, Valérian Forquet, Christophe Morell, Hassan Abdoul-Carime, Bernadette Farizon, Michel Fari-zon, and Tilmann D. Mark. Proton Migration in Clusters Consisting of Protonated Pyridine Solvated by Water Molecules. Chem. Phys. Chem., 16(15): 3151-3155, 2015. doi:10.1002/cphc.201500465. URL https://chemistry-europe.onlinelibrary.wiley.
com/doi/10.1002/cphc.201500465.

|33 B. Liu, S. Brondsted Nielsen, P. Hvelplund, H. Zettergren, H. Cederquist, B. Manil, and B. A. Huber. Collision-induced dissociation of hydrated adenosine monophos-phate nucleotide ions: Protection of the ion in water nanoclusters. Phys. Rew. Lett., 97:133401, 2006. doi: 10.1103/PhysRevLett.97.133401. URL https://link. aps.org/doi/10.1103/PhysRevLett.97.133401.

|34| Nam Joon Kim, Yung Sam Kim, Gawoon Jeong, Tae Kyu Ahn, and Seong Keun Kim. Hydration of DNA base cations in the gas phase. Int. J. Mass $S p e c t r o m.$ , 219(1):11-21, 2002. doi:10.1016/s1387-3806(02)00547-x.  URL https://www.sciencedirect.com/science/ article/pii/S138738060200547X?via%3Dihub.

[35] B. Barc, M. Ryszka, J.-C. Poully, E. Jabbour Al Maalouf, Z. el Otell, J. Tabet, R. Parajuli, P.J.M. van der Burgt, P. Limao-Vieira, P. Cahillane, M. Dampc, N.J. Mason, and S. Eden.  Multi-photon and electron impact ionisation studies of reactivity in adenine-water clusters. Int. .J. Mass Spectrom., 365: 194-199, 2014. doi:10.1016/j.ijms.2014.01.007. URL https://www.sciencedirect.com/science/article/

p11/313813801400110.

[36] Rahul Pandey, Mathieu Lalande, Michal Ryszka, Paulo Limao-Vieira, Nigel J. Mason, Jean-Christophe Poully, and Samuel Eden. Stabilities of nanohydrated thymine radical cations: insights from multiphoton ionization experiments and ab initio calculations.  Eur. Phys. J. D, 71(7):190, 2017. doi:10.1140/epjd/e2017-70827-1. URL https: //link.springer.com/article/10. 1140/epjd/e2017-70827-1.

[37] S. K. Kim, W. Lee, and D. R. Herschbach. Cluster beam chemistry: Hydration of nucleic acid bases; ionization potentials of hydrated adenine and thymine. .J. Phys. Chem., 100(19):7933-7937, May 9 1996. ISSN 0022-3654. doi: 10.1021/jp960635d. URL https://pubs.acs.org/doi/ abs/10.1021/jp960635d..

|38 J Kocisek, A Pysanenko, M Farnik, and J Fedor. Micro-hydration prevents fragmentation of uracil and thymine by low-energy electrons. J. Phys. Chem. Lett., 27: 3401-3405, 2016. doi:10.1021 /acs.jpclett.6b01601. URL https://doi.org/10.1021/acs.jpclett.6b01601.

[39] Enliang Wang, Xueguang Ren, WoonYong Baek, Hans Rabus, Thomas Pfeifer, and Alexander Dorn. Water acting as a catalyst for electron-driven molecular breakup of tetrahydrofuran. Nat. Commu., 11:2194, 2020. doi:10.1038/s41467-020-15958-7. URL https://doi.org/ 10.1038/s41467-020-15958-7.

[40] L. F. Sukhodub. Interactions and hydration of nucleic acid bases in a vacuum. Experimental study. Chem. Rev., 87 (3):589-606, 1987. doi:10.1021/cr00079a006. URL https: //pubs.acs.org/doi/abs/10.1021/cr00079a006.

[41] Michael Neustetter, Masoomeh Mahmoodi-Darian, and Stephan Denifl. Study of Electron Ionization and Fragmentation of Non-hydrated and Hydrated Tetrahydro-furan Clusters. J. $A$ m. Soc. Mass Spectrom., 28(5): 866-872, 2017. ISSN 1044-0305. doi:10.1007/s13361-017-1634-y. URL https: //pubs.acs.org/doi/10.1007/ s13361-017-1634-y.

[42] Denis Comte, Leo Lavy, Paul Bertier, Florent Calvo, Isabelle Daniel, Bernadette Farizon, Michel Farizon, and Tilmann D. Mirk. Glycine Peptide Chain Formation in the Gas Phase via Unimolecular Reactions. J. Phys. Chem. A, 127(3):775 -780, 2023. doi: 10.1021/acs.jpca.2c08248. URL https://pubs.acs.org/ doi/10.1021/acs.jpca.2c08248.

[43] Z.-H. Loh, G. Doumy, C. Arnold, L. Kjellsson, S. H. Southworth, A. A Haddad, Y. Kumagai, M.-F. Tu, P. J. Ho, A. M. March, R.. D. Schaller, M. S. Bin Mohd Yusof, T. Debnath, M. Simon, R. Welsch, L. Inhester, K. Khalili, K. Nanda, A.I. Krylov, S. Moeller, G. Coslovich, J.Ko-ralek, M. P. Minitti, W. F. Schlotter, J.-E. Rubensson, R. Santra, and L. Young. Observation of the fastest chemical processes in the radiolysis of water. Science, 367: 179-182, 2020. doi:10.1126/science.aaz4740. URL https: //science.sciencemag.org/content/367/6474/179.

[44] Vit Svoboda, Rupert Michiels, Aaron C. LaForge, Jakub Med, Frank Stienkemeier, Petr Slavitek, and Hans Jakob Worner. Real-time observation of water radiolysis and hydrated electron formation induced by extreme-ultraviolet pulses. Science Advances, 6:eaaz0385, 2020. doi:10.1126/sciadv.aaz0385. URL https://advances. sciencemag.org/content/6/3/eaaz0385.

[45] Barry D. Michael and Peter O'Neill. A sting in the tail of electron tracks. Science, 187(5458):1603-1604, 2000. doi:10.1126/science.287.5458.1603. URL https: //science.sciencemag.org/content/287/5458/1603.

[46] Chun-Rong Wang, Jenny Nguyen, and Qing-Bin Lu. Bond breaks of nucleotides by dissociative electron transfer of nonequilibrium prehydrated electrons: A new molecular mechanism for reductive DNA damage. .J. Am. Chem. Soc., 131:11320-11322, 2009. doi:10.1021/ja902675g. URL https://doi.org/10.1021/ja902675g.

[47] Xiaoguang Bao, Jing Wang, Jiande Gu, and Jerzy Leszczynski. DNA strand breaks induced by near-zero-electronvolt electron attachment to pyrimidine nucleotides. PNAS, 103(15):5658-5663, 2006. doi: 10.1073/pnas.0510406103. URL https://www.pnas.org/ content/103/15/5658.

|48 Jun Ma, Furong Wang, Sergey A. Denisov, Amitava Adhikary, and Mehran Mostafavi. Reactivity of prehy-drated electrons toward nucleobases and nucleotides in aqueous solution. Science Advances, 3(12):1-7, 2017. doi:10.1126/sciadv.1701669. URL https://advances. sciencemag.org/content/3/12/e1701669.

[49] Jun Ma, Anil Kumar, Yusa Muroya, Shinichi Yamashita, Tsuneaki Sakurai, Sergey A. Denisov, Michael D. Sevilla, Amitava Adhikary, Shu Seki, and Mehran Mostafavi. Observation of dissociative quasi-free electron attachment to nucleoside via excited anion radical in solution. Nat. Com-mun., 6:1, 2019. doi:10.1038/s41467-018-08005-z. URL https://doi.org/10.1038/s41467-018-08005-z.

|50] Jiande Gu, Jerzy Leszczynski, and Henry F. Schae-fer. Interactions of electrons with bare and hydrated biomolecules: From nucleic acid bases to DNA segments. Chem. Rev., 112:5603-5640, 2012. doi:10.1021/cr3000219. URL https://doi.org/10.1021/cr3000219.

|51] M. Smyth, J. Kohanoff, and I. I. Fabrikant. Electron-induced hydrogen loss in uracil in a water cluster environment. .J. Chem. $P h y s.$ , 140:184313, 2014. doi: 10.1063/1.4874841. URL https://doi.org/10.1063/1. 4874841.

[52] Aleksandar R. Milosavljevic, Viktor Z Cerovski, Fran-cis Canon, Milos Lj Rankovit, Nikola Skoro, Laurent Nahon, and Alexandre Giuliani. Energy-dependent UV photodissociation of gas-phase adenosine monophosphate nucleotide ions: The role of a single solvent molecule. J. Phys. Chem. Lett., 5(11):1994-1999, 2014. doi: 10.1021/jz500696b. URL https://pubs.acs.org/doi/ 10.1021/jz500696b.

|53] Andrew T. Ulijasz, Gabriel Cornilescu, Claudia C. Cornilescu, Junrui Zhang, Mario Rivera, John L. Markley, and Richard D. Vierstra. Structural basis for the photo-conversion of a phytochrome to the activated Pfr form. Nature, 463:250-254, 2010. doi:10.1038/nature08671. URL https://www.nature.com/articles/nature08671.

|54] M. N. R. Ashfold, B. Cronin, A. L. Devine, R. N. Dixon, and M. G. D. Nix. The role of wo* excited states in the photodissociation of heteroaro-matic molecules. Science, 312:1637-1640, 2006. doi:10.1126/science.1125436. URL http://science. sciencemag.org/content/312/5780/1637/tab-pdf.

55 A. L. Sobolewski, W. Domcke, C. Dedonder-Lardeux, and C. Jouvet. Excited-state hydrogen detachment and hydrogen transfer driven by repulsive no* states: A new paradigm for nonradiative decay in aromatic biomolecules. Phys. Chem. Chem. Phys., 4:1093-1100, 2002. doi: 10.1039/B110941N. URL http://dx.doi.org/10.1039/ B110941N.

|56] A. L. Sobolewski and W. Domcke. Conical intersections induced by repulsive  no* states in planar organic molecules: malonaldehyde, pyrrole and chlorobenzene as photochemical model systems. Chem. Phys., 259(2):181-191, 2000. doi:10.1016/S0301-0104(00)00203-2. URL http://www.sciencedirect.com/science/ article/pii/S0301010400002032.

|57 H Lippert, V Stert, L Hesse, C P Schulz, I V Her-tel, and W Radloff. Ultrafast photoinduced processes in indole-water clusters. Chem. Phys. Lett., 376(1 2):40-48, jul 2003. doi:10.1016/S0009-2614(03)00921-7. URL http://linkinghub.elsevier.com/retrieve/ pii/S0009261403009217.

|58] Andrzej L Sobolewski and Wolfgang Domcke. Photoejec-tion of electrons from pyrrole into an aqueous environment: ab initio results on pyrrole-water clusters. Chem. Phys. Lett., 321(5-6):479-484, May 2000. doi:10.1016/S0009-2614(00)00404-8. URL http://linkinghub.elsevier. com/retrieve/pii/S0009261400004048.

|59| Timothy M. Korter, David W. Pratt, and Jochen Kiüp-per. Indole-H2O in the gas phase. Structures, barriers to internal motion, and S1 <- So transition moment orientation. Solvent reorganization in the electronically excited state. J. Phys. Chem. A, 102(37):7211-7216, 1998. doi: 10.1021/jp982456x. URL http://dx.doi.org/10.1021/ .jp982456x.

[60] Samir Kumar Pal, Jorge Peon, and Ahmed H. Zewail. Biological water at the protein surface: Dynamical solvation probed directly with femtosecond resolution. $P$ NAS,99 (4):1763-1768, 2002. doi:10.1073/pnas.042697899. URL https://www.pnas.org/content/99/4/1763.

[61] Jolijn Onvlee, Sebastian Trippel, and Jochen Kiipper. Ultrafast light-induced dynamics in solvated biomolecules: The indole chromophore with water. Nat. Commun., 13:7462, 2022. doi:10.1038/s41467-022-33901-w. URL https://dx.doi.org/10.1038/s41467-022-33901-w.

62| Wolfgang Domcke and Andrzej L. Sobolewski. Spectroscopy meets theory. Nat. Chem., 5(4):257-258, 2013. ISSN 1755-4330. doi:10.1038/nchem.1601.

|63] Michael J. Tubergen, Anne M. Andrews, and Robert L. Kuczkowski. Microwave spectrum and structure of a hydrogen-bonded pyrrole-water complex. J. Phys. Chem., 97(29):7451-7457, 1993. doi:10.1021/j100131a011. URL https://doi.org/10.1021/j100131a011.

|64| Lanhai He, Lukas Tomanik, Sebastian Malerz, Florian Trinter, Sebastian Trippel, Michal Belina, Petr Slaviéek, Bernd Winter, and Jochen Kipper. Specific versus nonspecific solvent interactions of a biomolecule in water. J. Phys. Chem. Lett., 14(46):10499-10508, 2023. doi: 10.1021 /acs.jpclett.3c01763. URL https://doi.org/10. 1021/acs. jpclett.3c01763.

|65] Gareth M. Roberts, Craig A. Williams, Hui Yu, Adam S. Chatterley, Jamie D. Young, Susanne Ullrich, and Vasil-ios G. Stavros. Probing ultrafast dynamics in photoex-cited pyrrole: timescales for $1$ ro" mediated H-atom elimination. Faraday Disc., 163:95-115, 2013. doi: 10.1039/c2fd20140b. URL http://pubs.rsc.org/en/ content/articlepdf/2013/fd/c2fd20140b.

|66 Oliver M. Kirkby, Michael A. Parkes, Simon P. Neville, Graham A. Worth, and Helen H. Fielding. Non-radiative relaxation dynamics of pyrrole following excitation in the range 249.5-200 nm. Chem. Phys. Lett., 683:179-185, 2017. doi:10.1016/j.cplett.2017.04.035. URL https: //doi.org/10.1016/j.cplett.2017.04.035.

67] H Lippert, H.-H Ritze, I V Hertel, and W W Radloff. Femtosecond time-resolved hydrogen-atom elimination from photoexcited pyrrole molecules. Chem. Phys. Lett., 5:1423-1427, 2004. doi:10.1002/cphc.200400079. URL https: //doi.org/10.1002/cphc .200400079.

68] K. Grygoryeva, J. Rakovsky, Ivo Vinklérek, O. Votava, M. Farnik, , and Viktoriya Poterya. Vibrationally mediated photodissociation dynamics of pyrrole. A $I P$ Adw., 9:0351511-0351517, 2019. doi:10.1063/1.5091974. URL https: //aip.scitation.org/doi/pdf/10.1063/1. 5091974?class=pdf.

|69| Irmgard Frank and Konstantina Damianos. Excited state dynamics in pyrrole-water clusters: First principles simulation. Chem. Phys., 343:347-352, 2008. doi: 10.1016/j.chemphys.2007.08.029. URL https://doi.org/ 10.1016/j.chemphys.2007.08.029.

|7O| Alrik. J. van den Brom, Makis Kapelios, Theofanis N. Kitsopoulos, N. Hendrik Nahler, BrAd Cronin, and Michael N. R Ashfold. Photodissociation and photoion-ization of pyrrole following the multiphoton excitation at 243 and 364.7 nm. Phys. Chem. Chem. $P h y s.$ ,7: 5704-899, 2005. doi:10.1039/B415766D. URL http: //dx.doi.org/10.1039/B415766D.

71 E.E. Rennie, C.A.F. Johnson, J.E. Parker, R.. Fer-guson, D.M.P. Holland, and D.A. Shaw. A pho-toabsorption and mass spectrometry study of pyrrole. Chem. Phys., 250(2):217-236, 1999. doi:10.1016/S0301-0104(99)00285-2. URL https://www.sciencedirect. com/science/article/pii/S0301010499002852.

|72| Markus Schiitz, Yoshiteru Matsumoto, Aude Bouchet, Murat Oztürk, and Otto Dopfer. Microsolvation of the pyrrole cation (Py") with nonpolar and polar ligands: infrared spectra of PyT-Ln with $\mathrm{L}=$ Ar, N2, and H2O (n < 3). Phys. Chem. Chem. Phys., 15(5):3970-3986, 2017. doi:10.1039/c6cp07251h. URL https://doi.org/ 10.1039/c6cp07251..

l73] Melby Johny, Jolijn Onvlee, Thomas Kierspel, Helen Bieker, Sebastian Trippel, and Jochen Kiipper. Spatial separation of pyrrole and pyrrole-water clusters. Chem. Phys. Lett., 721:149-152, 2019. ISSN 0009-2614. doi: 10.1016/j.cplett.2019.01.052. URL https://doi.org/10. 1016/j.cplett.2019.01.052.

|74 Yuan-Pin Chang, Daniel A. Horke, Sebastian Trippel, and Jochen Ktipper. Spatially-controlled complex molecules and their applications. Int. Rev. Phys. Chem., 34:557-590, 2015. doi:10.1080/0144235X.2015.1077838. URL https: //dx.doi.org/10.1080/0144235X.2015.1077838.

|75] Arthur Zhao, Martin van Beuzekom, Bram Bouwens, Dmitry Byelov, Irakli Chakaberia, Chuan Cheng, Erik Maddox, Andrei Nomerotski, Peter Svihra, Jan Visser, Vaclav Vrba, and Thomas Weinacht. Coincidence velocity map imaging using Tpx3Cam, a time stamping optical camera with 1.5 ns timing resolution. Rev. Sci. Instrum., 88(11):113104, 2017. doi:10.1063/1.4996888. URL https: //doi.org/10.1063/1.4996888.

l76 Ahmed Al-Refaie, Melby Johny, Jonathan Correa, David Pennicard, Peter Svihra, Andrei Nomerotski, Sebastian Trippel, and Jochen Kipper. PymePix: A python library for SPIDR readout of Timepix3. J. Instrum., 14 (10):P10003, 2019. doi:10.1088/1748-0221/14/10/P10003. URL https://iopscience.iop.org/article/10.1088/ 1748-0221/14/10/P10003/meta.

|77] Hubertus Bromberger, Christopher Passow, David Penni-card, Rebecca Boll, Jonathan Correa, Lanhai He, Melby Johny, Christina Papadopoulou, Atia Tul-Noor, Joss Wiese, Sebastian Trippel, Benjamin Erk, and Jochen Kiipper. Shot-by-shot 250 khz 3d ion and mhz photoelectron imaging using Timepix3. J. Phys. B, 55(14): 144001, June 2022. doi:10.1088/1361-6455/ac6b6b. URL https://doi.org/10.1088/1361-6455/ac6b6b.

|78] Vaclav Profant, Viktoriya Poterya, Michal Farnik, Petr Slaviéek, and Udo Buck. Fragmentation dynamics of size-selected pyrrole clusters prepared by electron impact ionization: Forming a solvated dimer ion core. J. Phys. Chem. A, 111:12477-12486, 2007. doi:10.1021/jp0751561. URL https://doi.org/10.1021/jp0751561.

|79 Helen Bieker, Jolijn Ovlee, Melby Johny, Lanhai He, Thomas Kierspel, Sebastian Trippel, Daniel A Horke, and Jochen Kiipper. Pure molecular beam of water dimer. .J. Phys. Chem. A, 123:7486-7490, August 2019. doi:10.1021/acs.jpca.9b06460. URL https://doi.org/ 10.1021/acs.jpca.9b06460.

|80| Michael H. Palmer, Isobel C. Walker, and Mar-tyn F. Guest. The electronic states of pyrrole studied by optical (VUV) absorption, near-threshold electron energy-loss (EEL) spectroscopy and ab initio multi-reference configuration interaction calculations. Chem.. Phys., 238(2):179-199, 1998. ISSN 0301-0104. doi: 10.1016/S0301-0104(98)00285-7. URL https://doi.org/ 10.1016/S0301-0104(98)00285-7.

81] P. J Derrick, L. Asbrink, O. Edqvist, B. A. Jon-sson, and E. Lindholm. Rydberg series in small molecules: XlI. photoelectron spectroscopy and electronic structure of pyrrole. Int. J. Mass Spec-trom. Ion Physics, 6:191-202, 1971. doi:10.1016/0020-7381(71)80003-7. URL https://www.sciencedirect. com/science/article/pii/0020738171800037.

821 Gary D. Willett and Tomas Baer. Thermochemistry and dissociation dynamics of state-selected CaHaX ions. 3. CaHsN . J. Am. Chem. Soc., 102:6774-6779, 1980. doi: 10.1021/ja00542a018. URL https://doi.org/10.1021/ ja00542a018.

83 I V Hertel and W Radloff. Ultrafast dynamics in isolated molecules and molecular clusters. Rep. Prog. Phys., 69 (6):1897-2003, 2006. doi:10.1088/0034-4885/69/6/r06. URL https://iopscience.iop.org/article/10.1088/ 0034-4885/69/6/R06/meta.

84 Sebastian Trippel, Terry G. Mullins, Nele L. M. Miuiller, Jens S. Kienitz, Karol Dlugolecki, and Jochen Kiip-per. Strongly aligned and oriented molecular samples at a klHz repetition rate. Mol. Phys., 111:1738, 2013. doi:10.1080/00268976.2013.780334. URL http://dx.doi. org/10.1080/00268976.2013.780334.

[85] Frank Filsinger, Undine Erlekam, Gert von Helden, Jochen Kiipper, and Gerard Meijer. Selector for structural isomers of neutral molecules. Phys. Rew. Lett., 100:133003, 2008. doi:10.1103/PhysRevLett.100.133003. URL http: //dx.doi.org/10.1103/PhysRevLett.100.133003.

[86] A. Roberts, P. Svihra, A. Al-Refaie, H. Graafsma, J. Kiüip-per, K. Majumdar, K. Mavrokoridis, A. Nomerotski, D. Pennicard, B. Philippou, S. Trippel, C. Touramanis, and J. Vann. First demonstration of 3D optical readout of a TPC using a single photon sensitive Timepix3 based camera. J. Instrwm., 14(06):P06001-P06001, June 2019. doi:10.1088/1748-0221/14/06/p06001. URL https: //doi.org/10.1088/1748-0221/14/06/P06001.

[87] S Hankin, D Villeneuve, P Corkum, and D Rayner. Intense-field laser ionization rates in atoms and molecules. Phys. Rew. A, 64(1):013405, 2001. doi: 10.1103/PhysRevA.64.013405. URL https://doi.org/ 10.1103/PhysRevA.64.013405.

[88] Joss Wiese, Jean-Francois Olivieri, Andrea Trabattoni, Sebastian Trippel, and Jochen Ktüipper. Strong-field photoelectron momentum imaging of OOS at finely resolved incident intensities. New J. Phys., 21:083011, August 2019. doi:10.1088/1367-2630/ab34e8.

[89] R.. H. Page, Y. R.. Shen, and Y. T. Lee. High-resolution photoionization spectrum of water molecules in a supersonic beam. J. Chem. Phys., 88:5362-5376, 1988. doi:10.1063/1.454058. URL https://doi.org/10.1063/ 1.454058.

[90] S V Popruzhenko. Keldysh theory of strong field ionization: history, applications, difficulties and perspectives. J. Phys. B, 47(20):204001, 2014. doi: 10.1088/0953-4075/47/20/204001. URL http://stacks. iop.org/0953-4075/47/i=20/a=204001.
</end of paper 0>


<paper 1>
# The unreasonable effectiveness of optimal transport in economics 

submitted to the proceeding of the 2020 World<br>Congress of the Econometric Society

Alfred Galichon*

July 13,2021

This paper is dedicated to the memory of Emmanuel Farhi (1978-2020).

## 1 Introduction

The mathematical theory of optimal transport traces back to Monge in the 18th century, who asked the main questions, for which he provided deep insights but left them unresolved. Regarded as a famous open problem throughout the 19th century, it was revived, and finally solved, with the advent of linear programming and works by Kantorovich, Koopmans, von Neumann, Dantzig and others in the mid 20th century. While the theory[^0]partly arose out of economic motivations (specifically resource allocation problems), it soon drifted away from economics. A second revival has occured since the 1990s, when insights from convex analysis were introduced by Brenier, Rachev, and Rüschendorf, and from geometry by Gangbo, McCann, Villani and others.

In spite of this, up until recently, optimal transport has still been reported missing from the standard toolbox of quantitative economics. However, it turns out that many basic problems encountered in diverse economic applications in various fields are optimal transport problems in disguise. Beyond intellectual curiosity, understanding this connection is useful to make use of the mature set of results of optimal transport to solve the problems, and in particular, to deal with questions of existence, uniqueness, stability, and computation without reinventing the wheel.

This paper is a rapid overview of some of these connections, and some extensions. It is admittedly skewed toward my own work, and borrows much material from my 2016 monograph, Optimal Transport Methods in Economics, to which the reader is referred for details. I cover much of the material from an empirical perspective every winter in the January edition of my 'math+econ+code' masterclasses (www.math-econ-code.org). In mathematics, a useful read is Santambrogio's Optimal Transport for Applied Mathematicians 2015, or Villani's 2003 introductory lecture notes Topics in Optimal Transportation. For computational aspects, Peyré and Cuturi's Computational Optimal Transport is a useful complement. Villani's 2009 treatise Optimal Transport: Old and New remains the most exhaustive reference on the topic.

## 2 Optimal transport in a nutshell

### 2.1 Optimal transport duality

Let us describe the optimal transport problem in the discrete case. Assume a central planner needs to match a population of workers, each of whom is characterized by their type $x \in \mathcal{X}$, with a population of firms, each of whom with type $y \in \mathcal{Y}$. A match between a worker of type $x$ and a firm of type $y$ produces output $\Phi_{x y}$, called transport surplus. The set of types $\mathcal{X}$ and $\mathcal{Y}$ are finite, and the total number of workers and firms are identical. We denote by $\left(p_{x}\right)$ and $\left(q_{y}\right)$ the vectors of probability distribution over $\mathcal{X}$ and $\mathcal{Y}$, thus normalizing the total mass of workers and firms to one: $\sum_{x \in \mathcal{X}} p_{x}=$ $\sum_{y \in \mathcal{Y}} q_{y}=1$.

The central planner's problem is to form a matching, and therefore, to decide on the mass $\pi_{x y}$ of pairs $x y$ to form. In the sequel, we shall call $\pi_{x y}$ the optimal transport plan. This quantity must match everyone, namely satisfy the double set of constraints that all workers of each type $x$ are assigned, $\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}$, and that all firms of type $y$ are assigned, namely $\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}$. With these constraints in mind, the workers shall maximize total output, which is $\sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}$ the sum of the pairwise output weighted by the mass of each pair. This yields the problem

$$
\begin{align*}
\max _{\pi \geq 0} & \sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}  \tag{1}\\
\text { s.t. } & \left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x} \forall x \in \mathcal{X} \\
\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y} \forall y \in \mathcal{Y}
\end{array}\right.
\end{align*}
$$

which is clearly a linear programming problem, which we shall call the primal problem. Note that the set of $\pi$ satisfying the constraints is clearly nonempty, as the random matching obtained by $\pi_{x y}=p_{x} q_{y}$ does satisfy the constraints. However, this matching is not optimal in general.

It is a basic result in linear programming that in this case, the value of the primal problem coincides with the value of the dual problem, which is

$$
\begin{align*}
& \min _{u, v} \sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{2}\\
& \text { s.t. } u_{x}+v_{y} \geq \Phi_{x y} \forall x \in \mathcal{X}, y \in \mathcal{Y}
\end{align*}
$$

where the dual variables $u_{x}$ and $v_{y}$ are the Lagrange multipliers respectively associated with the primal constraints $\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}$ and $\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}$, while the primal variables $\pi_{x y} \geq 0$ serve as Lagrange multipliers associated with the dual constraints $u_{x}+v_{y} \geq \Phi_{x y}$.

Lastly, another important result in linear programming, complementary slackness, asserts that $\pi_{x y}>0 \Longrightarrow u_{x}+v_{y}=\Phi_{x y}$ : if a Lagrange multiplier is strictly positive, then the corresponding dual constraint is saturated.

Optimal transport is a far-reaching generalization of the finite-dimensional duality discussed above to the case when $\mathcal{X}$ and $\mathcal{Y}$ are much richer sets; in particular the theory applies to the case when $\mathcal{X}$ and $\mathcal{Y}$ are finite-dimensional vector spaces, and we will not need more for most of the economic applications we will discuss. In that case, letting $P$ and $Q$ be probability distributions over $\mathcal{X}$ and $\mathcal{Y}$, we shall define $\mathcal{M}(P, Q)$ as the set of joint probability distributions over $\mathcal{X} \times \mathcal{Y}$ with margins $P$ and $Q$, which is the set of joint
probability distributions $\pi$ such that if $(X, Y) \sim \pi$, where $\sim$ is understood as "distributed as," then $X \sim P$ and $Y \sim Q$. In this more general setting, the primal problem (1) extends to

$$
\begin{equation*}
\max _{\pi \in \mathcal{M}(P, Q)} \int_{\mathcal{X} \times \mathcal{Y}} \Phi(x, y) d \pi(x, y) \tag{3}
\end{equation*}
$$

while its dual, extending (2), is

$$
\begin{array}{ll}
\min _{u, v} & \int_{\mathcal{X}} u(x) d P(x)+\int_{\mathcal{Y}} v(y) d Q(y)  \tag{4}\\
\text { s.t. } & u(x)+v(y) \geq \Phi(x, y)
\end{array}
$$

The Monge-Kantorovich theorem provides assumptions under which the former duality results are preserved in more general settings, that is: (i) there exist primal solutions $\left(\pi_{x y}\right)$; (ii) there is no duality gap, that is, the value of the dual problem (4) coincides with the value of the primal (3); and (iii) there exist dual solutions $\left(u_{x}\right)$ and $\left(v_{y}\right)$.

### 2.2 Some variants

### 2.2.1 Entropy regularized Optimal Transport

To facilitate computation, consider the previous primal problem with an entropic regularization in the objective function. Take $\sigma>0$ a parameter
that can be made arbitrarily small. The primal problem

$$
\begin{align*}
& \max _{\pi \geq 0} \sum_{x, y} \pi_{x y} \Phi_{x y}-\sigma \sum_{x, y} \pi_{x y} \ln \pi_{x y}  \tag{5}\\
& \text { s.t. }\left\{\begin{array}{l}
\sum_{y} \pi_{x y}=p_{x} \\
\sum_{x} \pi_{x y}=q_{y}
\end{array}\right.
\end{align*}
$$

has dual

$$
\begin{equation*}
\min _{u, v}\left\{\sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sigma \sum_{x, y} \exp \left(\frac{\Phi_{x y}-u_{x}-v_{y}}{\sigma}\right)-\sigma\right\} \tag{6}
\end{equation*}
$$

and the optimal $\pi$ in (5) and the optimal $(u, v)$ in (6) are related by

$$
\begin{equation*}
\pi_{x y}=\exp \left(\frac{\Phi_{x y}-u_{x}-v_{y}}{\sigma}\right) \tag{7}
\end{equation*}
$$

Again, this problem has extension to the case where $\mathcal{X}$ and $\mathcal{Y}$ are no longer discrete sets: this is the theory of Bernstein-Schrödinger systems, surveyed in Léonard (2014). Recently, progresses have been made on the computation of this problem in particular through coordinate descent:

Starting at $t=0$ with an initial estimate of $v_{y}^{t}$ :

- Compute $\left(u_{x}^{t+1}\right)$ in order to minimize the objective function in (6), while keeping $v=\left(v_{y}^{t}\right)$ fixed.
- Compute $\left(v_{y}^{t+1}\right)$ in order to minimize the objective function in (6), while keeping $u=\left(u_{x}^{t+1}\right)$ fixed.
- Iterate over $t$, until the update to the $u$ 's and the $v$ 's are below toler-
ance.

It is easy to see that both steps are explicit and one full iteration of the algorithm expresses as

$$
\left\{\begin{array}{l}
u_{x}^{t+1}=\sigma \log \left(\frac{1}{p_{x}} \sum_{y \in \mathcal{Y}} \exp \left(\frac{\Phi_{x y}-v_{y}^{t}}{\sigma}\right)\right)  \tag{8}\\
v_{y}^{t+1}=\sigma \log \left(\frac{1}{q_{y}} \sum_{y \in \mathcal{Y}} \exp \left(\frac{\Phi_{x y}-u_{x}^{t+1}}{\sigma}\right)\right)
\end{array}\right.
$$

This is the iterated proportional fitting algorithm (IPFP), which has been rediscovered under many names": "matrix scaling", "RAS algorithm", "Sinkhorn-Knopp algorithm", "Kruithof's method", "Furness procedure", "biproportional fitting procedure", "Bregman's procedure". In economics, this algorithm has been proposed at least twice, once by Berry, Levinsohn and Pakes 1995 under the name "contraction mapping algorithm," and once by Guimares-Portugal (2010) in the context of the gravity equation in trade. We will see some of these connections below. This algorithm has been successfully applied to machine learning, see Cuturi (2013) and Peyré and $\mathrm{Cu}-$ turi (2019). The rates of convergence of this algorithm are by now well understood thanks to the Hilbert projective metric, see Franklin and Lorenz (1989), and more recently, thanks to the theory of Bregman divergences, see Léger $(2020)$.

### 2.2.2 Variant with unassigned agents

A variant of the problem leaves the agents the possibility of remaining unassigned. When the total mass of workers differs from that of the firms, we still[^1]denote $p_{x}$ be the mass of workers of type $x$ (no longer interpreted as a probability) and $q_{y}$ the mass of firms of type $y$, and we allow for $\sum_{x} p_{x} \neq \sum_{y} q_{y}$ to hold. The constraint is now that the total mass of matched workers of type $x$ should be no greater than $p_{x}$, and that the total mass of matched firms of type $y$ should not exceed $q_{y}$; and the total surplus is still $\sum_{x y} \pi_{x y} \Phi_{x y}$; the primal problem is now

$$
\begin{align*}
\max _{\pi \geq 0} & \sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}  \tag{9}\\
\text { s.t. } & \left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y} \leq p_{x} \forall x \in \mathcal{X} \\
\sum_{x \in \mathcal{X}} \pi_{x y} \leq q_{y} \forall y \in \mathcal{Y}
\end{array}\right.
\end{align*}
$$

while the dual problem becomes

$$
\begin{align*}
& \min _{u \geq 0, v \geq 0} \sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{10}\\
& \quad \text { s.t. } u_{x}+v_{y} \geq \Phi_{x y} \forall x \in \mathcal{X}, y \in \mathcal{Y}
\end{align*}
$$

As we see, these formulations only slightly differ from (1) and (2) respectively: the constraints in the primal switch from an equality to an inequality, while the variables in the dual are now subject to nonnegativity constraints. Because this leaves the possibility of agents to remained unmatched (unemployed in the labor market; singles in the marriage market), these problems are sometimes more relevant for economic modelling. This model is called the Becker-Shapley-Shubik model, after Becker (1973) and Shapley-Shubik (1971).

### 2.3 Inverse optimal transport problem

Understanding the "direct problem" of optimal transport as determining the optimal transport plan $\pi_{x y}$ in (1) or (5) based on the transport surplus $\Phi_{x y}$, as described above, we now turn to the "inverse problem" of optimal transport: how to determine the transport surplus $\Phi_{x y}$ based on the observation of an optimal transport plan $\hat{\pi}_{x y}$. More specifically, we specify

$$
\begin{equation*}
\Phi_{x y}^{\lambda}=\sum_{k} \lambda_{k} \phi_{x y}^{k} \tag{11}
\end{equation*}
$$

Setting $\theta=\left(\lambda_{k}, u_{x}, v_{y}\right)$ and

$$
\begin{equation*}
\pi_{x y}^{\theta}=\exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right) \tag{12}
\end{equation*}
$$

the inverse optimal transport problem consists of seeking the parameter $\theta$ such that $\pi_{x y}^{\theta}$ has the same margins and moments as $\hat{\pi}_{x y}$, that is

$$
\begin{equation*}
\sum_{y \in \mathcal{Y}} \pi_{x y}^{\theta}=\sum_{y \in \mathcal{Y}} \hat{\pi}_{x y}=: p_{x}, \sum_{x \in \mathcal{X}} \pi_{x y}^{\theta}=\sum_{x \in \mathcal{X}} \hat{\pi}_{x y}=: q_{y}, \sum_{x, y} \pi_{x y}^{\theta} \phi_{x y}^{k}=\sum_{x, y} \hat{\pi}_{x y} \phi_{x y}^{k} \tag{13}
\end{equation*}
$$

This question solved by the following convex optimization problem:

Theorem 1 The unique $\lambda$ satisfying conditions (13) is unique solution to

$$
\begin{equation*}
\min _{u, v, \lambda}\left\{\sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sum_{x, y} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)-\sum_{x y} \hat{\pi}_{x y} \Phi_{x y}^{\lambda}\right\} \tag{14}
\end{equation*}
$$

whose dual is

$$
\begin{array}{ll} 
& \max _{\pi \geq 0}\left\{-\sum_{x y} \pi_{x y} \ln \pi_{x y}\right\}  \tag{15}\\
\text { s.t. } \quad & \sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}\left[u_{x}\right], \sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}\left[v_{y}\right] \\
& \sum_{x, y} \pi_{x y} \phi_{x y}^{k}=\sum_{x, y} \hat{\pi}_{x y} \phi_{x y}^{k}\left[\lambda_{k}\right]
\end{array}
$$

The problem of parametric estimation of $\lambda$ is therefore the problem of a Poisson pseudo-maximum likelihood estimation, similar to the technique employed in trade to estimate the gravity equation (Santos Silva and Tenreyro, 2006). Galichon and Salanié (2021) formulated the initial connection with the Choo-Siow (2006) matching model, in the variant with singles. Dupuy and Galichon (2014) studies a continuous version of this model. Dupuy, Galichon and Sun (2019) add a Lasso-type penalization to estimate $\lambda$ under sparsity constraint, while Carlier, Dupuy, Galichon and Sun (2021) offer an algorithm called SISTA (Sinkhorn+Iterative Soft Thresholding Algorithm) to compute efficently the regularized problem by alternating coordinate descent steps (Sinkhorn steps) on the $u_{x}$ 's and the $v_{y}$ 's, with a proximal gradient descent step.

## 3 Optimal transport in economics, finance and statistics

### 3.1 Family economics

As first understood by Becker (1973) and Shapley-Shubik (1971), the duality in optimal transport can be thought as a powerful welfare theorem, providing the equivalence between optimal matchings (in the sense of the problem of a central planner), and stable matchings (in a sense to be specified). Becker applied this insight in his pioneering analysis of the marriage market, and we now describe his analysis.

Consider the "marriage" problem of heterosexual men and women who need to decide to match. Men are distributed according to a a mass vector $\left(p_{x}\right)$, while women are distributed according to a mass vector $\left(q_{y}\right)$, where the total mass of men and women don't have to coincide. It is assumed that if $x$ and $y$ decide to match, they enjoy a joint utility $\Phi_{x y}$, which they need to split among them. Any agent remaining unmatched gets a reservation utility equal to zero.

A stable marriage is a specification of a joint distribution $\left(\pi_{x y}\right) \geq 0$ over $\mathcal{X} \times \mathcal{Y}$ as well as payoffs vectors $u_{x}$ and $v_{y}$ such that

$$
\left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y}+\pi_{x 0}=p_{x}, \sum_{x \in \mathcal{X}} \pi_{x y}+\pi_{0 y}=q_{y}  \tag{16}\\
u_{x}+v_{y} \geq \Phi_{x y} \\
u_{x} \geq 0, v_{y} \geq 0 \\
\pi_{x y}>0 \Longrightarrow u_{x}+v_{y}=\Phi_{x y} \\
\pi_{x 0}>0 \Longrightarrow u_{x}=0, \pi_{0 y}>0 \Longrightarrow v_{y}=0
\end{array}\right.
$$

The first set of conditions implies that all agents either participate in the matching market, or remain unmatched. The next conditions, namely $u_{x}+v_{y} \geq \Phi_{x y}$, imply that there is no blocking pair: if $u_{x}+v_{y}$ were less than $\Phi_{x y}$, then $x$ and $y$ would have an incentive to quit their existing assignments and form a blocking pair, and each achieve strictly greater utility than $u_{x}$ and $v_{y}$ respectively. Similarly, $u_{x} \geq 0$ and $v_{y} \geq 0$ indicate that no one can achieve an outcome worse than the reservation utility.

Finally, the last set of conditions expresses that if pairs $x y$ are actually formed, then there must be a way to split the joint surplus $\Phi_{x y}$ in such a way that $u_{x}$ and $v_{y}$ sum to $\Phi_{x y}$, while if a positive mass of either $x$ or $y$ remain unmatched at equilibrium, the payoff of the corresponding type should be zero.

It is not hard to see that equations (16) are the complementary slackness conditions associated with linear programming problem (9)-(10). Hence:

Theorem 2 (Becker-Shapley-Shubik) ( $\pi, u, v)$ is a stable marriage in the sense of (16) if and only if $\pi$ is an optimal solution to (9), and $(u, v)$ is an optimal solution to (10).

This linear programming formulation is especially attractive for computational purposes, see chapter 3.4 of Galichon (2016).

### 3.2 Labor economics

In a realistic model of the labor market, not all jobs offering the same wage are as attractive for the workers. Hence, we need to capture the job amenities as the monetary valuations for working certain type of jobs conditional
on being a certain type of worker. Let $\alpha_{x y}$ be the monetary valuation of employer $y$ 's amenities for worker $x$, and let $\gamma_{x y}$ be the monetary output of worker $x$ working for employer $y$. As before, we normalize to zero the payoff of unassigned agents.

Let $w_{x y}$ be the wage that $x$ receives if working for $y$, which is determined at equilibrium. The worker and the firm problems are respectively

$$
\begin{equation*}
u_{x}=\max _{y \in \mathcal{Y}}\left\{\alpha_{x y}+w_{x y}, 0\right\} \text { and } v_{y}=\max _{x \in \mathcal{X}}\left\{\gamma_{x y}-w_{x y}, 0\right\} \tag{17}
\end{equation*}
$$

from which it follows that, defining the total output associated with an $x y$ match as the sum of monetary amenity plus production, namely $\Phi_{x y}=\alpha_{x y}+$ $\gamma_{x y}$, an equilibrium on the labor market should be such that $(\pi, u, v)$ should be a stable matching in the sense of (16). Once $(u, v)$, which is solution to (10) has been computed, one can compute the vector of equilibrium wages $w_{x y}$ by

$$
\begin{equation*}
\gamma_{x y}-v_{y} \leq w_{x y} \leq u_{x}-\alpha_{x y} \tag{18}
\end{equation*}
$$

Note that for pairs $x y$ that are actually formed at equilibirum, $\pi_{x y}>0$

implies that $u_{x}+v_{y}=\Phi_{x y}$, and thus the upper bound $u_{x}-\alpha_{x y}$ coincides with the lower bound $\gamma_{x y}-v_{y}$. For other pairs, the upper bound may differ from the lower bound, which is a typical situation in equilibrium, where the price vectors need not be unique outside of the equilibrium path.

### 3.3 Trade

The structural gravity equations in international trade, introduced by Anderson (2003), with antecedents in Alan Wilson (1969), has been described
as a "workhorse" model in that field (Head and Mayer, 2013). Letting $\mathcal{X}$ be the set of countries, we define $\hat{\pi}_{x y}$ as the observed trade flow from country $x \in \mathcal{X}$ to country $y \in \mathcal{X}$. Letting $p_{x}=\sum_{y \neq x} \hat{\pi}_{x y}$ be the total volume of country $x$ 's exports, and $q_{y}=\sum_{x \neq y} \hat{\pi}_{x y}$ be the total volume of country $y$ 's imports, the gravity model assumes that

$$
\begin{equation*}
\pi_{x y}^{\lambda, u, v}=\exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right) \tag{19}
\end{equation*}
$$

where $\Phi_{x y}^{\lambda}=\sum_{k} \phi_{x y}^{k} \lambda_{k}$ and the $\phi_{x y}^{k}$ 's are various measures of proximity between country $x$ and country $y$. The exporter and importer fixed effects $u_{x}$ and $v_{y}$ are called "multilateral resistances" and are adjusted by fitting the total imports and exports

$$
\left\{\begin{array}{l}
p_{x}=\sum_{y \neq x} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)  \tag{20}\\
q_{y}=\sum_{x \neq y} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)
\end{array}\right.
$$

As understood by Wilson (1969), $\pi^{\lambda, u, v}$ is the solution to the regularized optimal transport problem (5), while $u_{x}$ and $v_{y}$ are solution to its dual (6). Moreover, $\theta=(\lambda, u, v)$ can estimated as an inverse optimal transport problem (14), as suggested by the influencial paper of Santos Silva and Tenreyro (2006), who connect the procedure with a Poisson regression. The link with inverse optimal transport and matching problems is made in Dupuy, Galichon and Sun (2019).

### 3.4 Hedonic models

Consider a quasilinear hedonic model where each producer $x \in \mathcal{X}$ produces one unit of good and chooses in which quality $z \in \mathcal{Z}$. Each consumer $y \in \mathcal{Y}$ consumes one unit of good, and chooses in which quality $z \in \mathcal{Z}$. The mass of the producers and consumers are respectively distributed according to vectors $\left(p_{x}\right)$ and $\left(q_{y}\right)$. There is a price $P_{z}$, determined at equilibrium, for one unit of the good in quality $z$, and a producer of type $x$ incurs a profit $P_{z}-C_{x z}$ of producing quality $z$ at that price where $C$ is a cost, while a consumer of type $y$ derives a utility $U_{y z}-P_{z}$ of consuming utility $z$ at that price. Both producers and consumers can opt out of the market and get profit or utility zero in that case.

In a hedonic equilibrium (Ekeland, Heckman and Nesheim, 2004), demand and supply are formed by the producer's and consumer's problems which are respectively

$$
\begin{equation*}
u_{x}=\max _{z \in \mathcal{Z}}\left\{P_{z}-C_{x z}, 0\right\} \text { and } v_{y}=\max _{z \in \mathcal{Z}}\left\{U_{y z}-P_{z}, 0\right\} \tag{21}
\end{equation*}
$$

Chiappori, McCann and Nesheim (2010) have shown that this problem is actually an optimal transport problem of the type (9) between consumers and producers, with a matching surplus equal to

$$
\begin{equation*}
\Phi_{x y}=\max _{z}\left\{U_{y z}-C_{x z}\right\} \tag{22}
\end{equation*}
$$

and the indirect utilities $u_{x}$ and $v_{y}$ are determined by (10). The intuition for the result is limpid: if $x$ and $y$ decide to exchange a good, they should
pick the good which is cost efficient in the sense that it maximizes their total joint surplus. The price vector $P_{z}$ will be deduced from $u_{x}$ and $v_{y}$ by the set of inequalities

$$
\begin{equation*}
\min _{x \in \mathcal{X}}\left\{u_{x}+C_{x z}\right\} \geq P_{z} \geq \max _{y \in \mathcal{Y}}\left\{U_{y z}-v_{y}\right\} \tag{23}
\end{equation*}
$$

where - similarly to the wage determination in equation (18) - the lower bound and the upper bound will coincide as soon as the quality $z$ is actually traded at equilibrium.

### 3.5 Discrete choice models

Recently, an intimate connection between optimal transport theory and discrete choice models has been explored, which we now describe. Consider the (additive) discrete choice problem where a consumer $i$ drawn from a population faces a choice between a finite set of alternatives $y \in \mathcal{Y}$. Consumer $i$ 's problem is

$$
\begin{equation*}
u\left(\varepsilon_{i}\right)=\max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}\right\} \tag{24}
\end{equation*}
$$

where $V_{y}$ is the systematic utility that every consumers associate with alternative $y$, and $\left(\varepsilon_{i y}\right)_{y \in \mathcal{Y}}$ is drawn from a random vector over $\mathbb{R}^{\mathcal{Y}}$ with distribution $\mathbf{P}$, which is assumed to have a density. The distribution of the random part of the utility $\varepsilon$ induces a choice probability, or market share $Q_{y}(V)$ which is the probability that $y$ is chosen by a consumer $i$ drawn from
the population, formally expresses as ${ }^{2}$

$$
\begin{equation*}
Q_{y}(V)=\operatorname{Pr}\left(y \in \arg \max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}\right\}\right) \tag{25}
\end{equation*}
$$

The demand inversion problem, popularized by Berry (1994) and Berry, Levinsohn and Pakes (1995, hereafter BLP) consists of, given a vector of market shares $q_{y}$, how to look for a vector of systematic utility $V$ such that $Q(V)=q$. This problem is a key step in BLP's estimation procedure, which consists of computing $V$ by demand inversion, and then running an instrumental variable regression on $V$.

Galichon and Salanié (2021) showed that the problem of discrete choice inversion is, in fact, isomorphic to an optimal transport problem.

Theorem 3 (Galichon-Salanié, part 1) The following statements are equivalent:

(i) $Q(V)=q$, that is $V$ is the solution to inversion problem of the discrete choice model in (24), and

(ii) There exist $(u, v)$ with $v=-V$ such that $(u, v)$ is solution to the dual optimal transport problem with surplus $\Phi(\varepsilon, y):=\varepsilon_{y}$

$$
\begin{align*}
& \min _{u, v} \int_{\varepsilon \in \mathbb{R}^{\mathcal{Y}}} u(\varepsilon) d \mathbf{P}(\varepsilon)+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{26}\\
& \text { s.t. } u(\varepsilon)+v_{y} \geq \varepsilon_{y} \forall \varepsilon \in \mathbb{R}^{\mathcal{Y}}, \forall y \in \mathcal{Y}
\end{align*}
$$

This result was extended to the nonsmooth case (where no regularity as-[^2]sumption is made on the distribution of $\varepsilon$ ) by Chiong, Galichon and Shum (2016), where a linear programming approch was provided for computational purposes. It has been extended to the continuous choice by Chernozhukov, Galichon, Henry and Pass (2021), and beyond additive random utility models by Bonnet et al. (2021).

A philosophical consequence of theorem 3 is that - at least from a mathematical standpoint - there is no relevant distinction between "one-sided" and "two-sided" models. We think of a discrete choice problem as a situation where conscient creatures called "consumers" choose inanimate objects called "yogurts". However, the equivalence described in theorem 3 shows that this situation is mathematically equivalent to a situation where consumers and yogurts would match, which is itself fully equivalent to a situation where yogurts choose consumers! This is a manifestation of Coase's principle: no matter how the utility is initially distributed, that is, no matter if consumers have preferences for yogurts or if yogurts have preferences for consumers, a Pareto efficient outcome should be reached in any case, and the bargaining process, here the yogurt price adjustment, allows to implement this outcome.

Interestingly, theorem 3 can be extended to mixed logit models, such as BLP's random coefficient logit model. Consider now a variant

$$
\begin{equation*}
u\left(\varepsilon_{i}\right)=\max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}+\sigma \eta_{y}\right\} \tag{27}
\end{equation*}
$$

where $\left(\varepsilon_{y}\right) \sim \mathbf{P}$ as before, while $\left(\eta_{y}\right)$ is a vector of i.i.d. random variables with a Gumbel distribution, independent from $\left(\varepsilon_{y}\right)$. Let $Q_{y}^{\sigma}(V)$ be the
corresponding market share defined for each entry $y \in \mathcal{Y}$.

Theorem 4 (Galichon-Salanié, part 2) The following statements are equivalent:

(i) $Q^{\sigma}(V)=q$, that is $V$ is the solution to inversion problem of the discrete choice model in (27), and

(ii) There exist $(u, v)$ with $v=-V$ such that $(u, v)$ is solution to the dual regularized optimal transport problem with surplus $\Phi(\varepsilon, y):=\varepsilon_{y}$

$$
\begin{equation*}
\min _{u, v} \int_{\varepsilon \in \mathbb{R} \mathcal{Y}} u(\varepsilon) d \mathbf{P}(\varepsilon)+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sigma \sum_{y \in \mathcal{Y}} \int_{\varepsilon \in \mathbb{R}^{\mathcal{Y}}} \exp \left(\frac{\varepsilon_{y}-u(\varepsilon)-v_{y}}{\sigma}\right) d \varepsilon \tag{28}
\end{equation*}
$$

Note that (28) is the same problem as (6) where the summation on $\varepsilon$ has been replaced by a continuous integrals; however, in the sample version, we considering a sample $\varepsilon_{1}, \ldots, \varepsilon_{N}$ from distribution $\mathbf{P}$, and the integrals are replaced by sums.

As shown in Bonnet et al. (2021), the coordinate descent algorithm described in paragraph 2.2.1 coincides with BLP's celebrated "contraction mapping algorithm." This observation led the former authors to propose a demand inversion procedure that extends to the non-additive case.

### 3.6 Derivative pricing

Consider two stocks, and let $X$ and $Y$ be random variables standing for the value of these stocks at a horizon of time in the future. The fundamental theorem of asset pricing (see Duffie 1992) asserts that if there is a complete market of options with $X$ as an underlying, then there is a distribution $\mathbf{P}$
called martingale measure such that the price of an option whose payoff is $u(X)$ shall be $\mathbb{E}_{\mathbf{P}}[u(X)]$. We shall assume that this is the case, and that there is a martingale measure $\mathbf{Q}$ such that the price of any option with payoff $v(Y)$ is $\mathbb{E}_{\mathbf{Q}}[v(Y)]$.

However, we shall not assume that there is a complete market of options on the joint realization of the underlying pair $(X, Y)$, hence we cannot infer a joint martingale measure $\pi(x, y)$ based on the quoted prices. For a trader wishing to introduce a new option on the pair $(X, Y)$, some restrictions must however be considered; in particular, if the option's payoff is of the form $a(X)+b(Y)$, its price must be $\mathbb{E}_{\mathbf{P}}[a(X)]+\mathbb{E}_{\mathbf{Q}}[b(Y)]$, otherwise the trader would face an arbitrage opportunity. But in general, the price of an option with a payoff $\Phi(X, Y)$ that is not additively separable cannot exceed

$$
\begin{equation*}
\max _{\pi \in \mathcal{M}(P, Q)} \mathbb{E}_{\pi}[\Phi(X, Y)] \tag{29}
\end{equation*}
$$

The Monge-Kantorovich duality will give us sharp arbitrage bounds for the price of this option, and will provide arbitrage strategies, as explained in Galichon, Henry-Labordère and Touzi (2014):

Theorem 5 An option whose payoff $\Phi(X, Y)$ is priced at $V$ is not subject to an arbitrage opportunity based on the two single-underlying option markets if and only if

$$
\begin{align*}
& \max _{u, v} \mathbb{E}_{\mathbf{P}}[u(X)]+\mathbb{E}_{\mathbf{Q}}[v(Y)] \leq V \leq \min _{u, v} \mathbb{E}_{\mathbf{P}}[u(X)]+\mathbb{E}_{\mathbf{Q}}[v(Y)]  \tag{30}\\
& \text { s.t. } u(x)+v(y) \leq \Phi(x, y) \\
& \text { s.t. } u(x)+v(y) \geq \Phi(x, y)
\end{align*}
$$

In other words, the price of the option should be bounded above by the
price of the cheapest overreplicating portfolio, while it should be bounded below by the price of the costliest underreplicating portfolio.

The above discussion has assumed that the pair of underlyings $X$ and $Y$ were the realizations of two assets prices at the same time. However, some derivatives are written on the same underlying asset at two different dates in the future. Assume that $X$ is the value of a stock at a future date, and $Y$ is the stock value at a later date. We then have an additional restriction, which is that in any martingale measure, $\mathbb{E}_{\pi}[Y \mid X]=X$ expresses absence of arbitrage. The option bound problem (29) now becomes

$$
\begin{align*}
\max _{\pi \in \mathcal{M}(P, Q)} & \mathbb{E}_{\pi}[\Phi(X, Y)]  \tag{31}\\
\text { s.t. } & \mathbb{E}_{\pi}[Y \mid X]=X
\end{align*}
$$

for which the Monge-Kantorovich duality extends and interprets as incorporating dynamic arbitrage strategies; see an exposition from a financial engineering's point of view in Pierre Henry-Labordère (2020)'s insightful book.

### 3.7 Quantiles

There is an intimate connection between optimal transport and the notion of quantile. Consider the optimal transport problem described in (3) with $\mathcal{X}=\mathcal{Y}=\mathbb{R}, P=\mathcal{U}([0,1])$ the uniform distribution on the unit interval, $Q$ a distribution with finite second moments, and $\Phi(x, y)=x y$.

Then, as explained in chapter 4 of Galichon (2016), the solution $(X, Y) \sim$ $\pi$ to problem (3) is a random pair such that $Y=F_{Q}^{-1}(X)$. Further, the
solution $(u, v)$ to problem (4) is such that $u^{\prime}(x)=F_{Q}^{-1}(x)$ and $v^{\prime}(y)=$ $F_{Q}(y)$. Hence the primal solution involves the quantile transform, and the dual solutions are simply primitives of the quantile map and the cumulative distribution function.

### 3.7.1 Multivariate quantiles

This connection led to the definition of a notion of multivariate quantiles: when $Y$ is multivariate, say has $d$ dimensions, one can extend the above

setting to $X \sim P=\mathcal{U}\left([0,1]^{d}\right)$ and to $\Phi(x, y)=x^{\top} y$ and, if $(u, v)$ is a solution to problem (4) in that case, the map $x \rightarrow \nabla u(x)$ is defined as the multivariate quantile associated with distribution $Q$. By Brenier's theorem (Brenier 1987), $\nabla u(X)$ has distribution $Q$, generalizing the well-known fact in the univariate case that the quantile map associated with a distribution pushes the uniform distribution on the unit interval onto the distribution. This new notion of multivariate quantiles found applications to risk measures (Ekeland, Galichon and Henry, 2012), decision theory (Galichon and Henry, 2012), and multivariate depth (Hallin, Chernozhukov, Galichon and Henry, 2017).

### 3.7.2 Quantile regression

There is an intimate connection between optimal transport and quantile regression, that is explored in a series of paper by Carlier, Chernozhukov and Galichon $(2016,2017)$ and Carlier, Chernozhukov, De Bie and Galichon (2020). We follow the latter paper in the present exposition. Quantile regression (see Koenker, 2005) attempts to fit a parametric dependence of
the conditional $\tau$-th quantile of a random variable $Y$ conditional on the value of $X$, a random vector on $\mathbb{R}^{k}$, as

$$
\begin{equation*}
Q_{Y \mid X}(\tau \mid x)=\beta(\tau)^{\top} x \tag{32}
\end{equation*}
$$

where $\beta(\tau) \in \mathbb{R}^{k}$ is the parameter of interest, defined for each value of $\tau \in$ $[0,1]$. Since Koenker and Bassett (1978), this problem has been recognized as a convex optimization problem in the population

$$
\begin{equation*}
\min _{\beta(\tau) \in \mathbb{R}^{k}} \mathbb{E}_{\mathbf{P}}\left[\rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right)\right] \tag{33}
\end{equation*}
$$

where the loss function $\rho_{\tau}(z)=\tau z^{+}+(1-\tau) z^{-}$, and $\mathbf{P}$ denotes the joint distribution of $(X, Y)$. The sample analog of (33) is a linear programming problem, yielding to a simple and computationally efficient estimation of $\beta$. The full curve $\tau \rightarrow \beta(\tau)$ can be estimated by summation of the objective functions in (33) over $\tau \in[0,1]$, yielding

$$
\begin{equation*}
\min _{\beta \in \mathbb{R}^{k \times[0,1]}} \mathbb{E}_{\mathbf{P}}\left[\int_{0}^{1} \rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right) d \tau\right] \tag{34}
\end{equation*}
$$

When specification (32) is correct, the map $\tau \rightarrow \beta(\tau)^{\top} x$ which is picked up is an actual quantile, and therefore nondecreasing. However, if specification (32) is incorrect, there is no guarantee that $\tau \rightarrow \beta(\tau)^{\top} x$ should be monotone. This phenomenon has been widely recognized in the literature on quantile regression and is known as the quantile crossing problem. To address the quantile crossing problem, one idea may be to impose directly the monotonicity of $\tau \rightarrow \beta(\tau)^{\top} x$ as an additional constraint in problem (34).

This has been done by Koenker and Ng (2005) but remains computationally challenging and the interpretation of the result is not obvious.

A more indirect approach consists of the following. Rather than imposing the monotonicity of $\tau \rightarrow \beta(\tau)^{\top} x$, one can impose the (weaker) constraint that $\tau \rightarrow 1\left\{y \geq \beta(\tau)^{\top} x\right\}$ should be nonincreasing in $\tau$. Consider the problem

$$
\begin{align*}
\min _{\beta \in \mathbb{R}^{k \times 00,1]}} & \mathbb{E}_{\mathbf{P}}\left[\int_{0}^{1} \rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right) d \tau\right]  \tag{35}\\
\text { s.t. } & 1\left\{y \geq \beta(\tau)^{\top} x\right\} \geq 1\left\{y \geq \beta\left(\tau^{\prime}\right)^{\top} x\right\} \quad \forall \tau \leq \tau^{\prime}, \forall x \in \mathbb{R}^{k}, y \in \mathbb{R}
\end{align*}
$$

The solution to the previous problem now has a very straightforward interpretation.

Theorem 6 (Carlier-Chernozhukov-De Bie-Galichon) If the map $\beta$ is solution to problem (33), then denoting $b(\tau)=\int_{0}^{\tau} \beta(t) d t$, and letting

$$
\begin{equation*}
\psi(x, y)=\max _{\tau \in[0,1]}\left\{\tau y-x^{\top} b(\tau)\right\} \tag{36}
\end{equation*}
$$

the pair $(b, \psi)$ will be solution to the following problem

$$
\begin{align*}
& \max _{b, \psi} \mathbb{E}_{\mathbf{P}}[X]^{\top} \int_{0}^{1} b(\tau) d \tau+\mathbb{E}_{\mathbf{P}}[\psi(X, Y)]  \tag{37}\\
& \text { s.t. } x^{\top} b(\tau)+\psi(x, y) \geq \tau y .
\end{align*}
$$

Conversely, if $(b, \psi)$ is solution to problem (37) and if $b$ is differentiable, then $\beta(\tau)=b^{\prime}(\tau)$ is a solution to problem (33).

Theorem 6 sheds new insights on quantile regression. Indeed, an extension of Monge-Kantorovich duality worked out in Carlier, Chernozhukov and Galichon (2016) shows that problem (37) is the dual problem to

$$
\begin{align*}
\min _{\pi \in \mathcal{M}(\mathcal{U}([0,1]), \mathbf{P})} & \mathbb{E}_{\pi}\left[(Y-U)^{2}\right]  \tag{38}\\
\text { s.t. } & \mathbb{E}[X \mid U]=\mathbb{E}[X]
\end{align*}
$$

where $\pi \in \mathcal{M}(\mathcal{U}([0,1]), \mathbf{P})$ means that if $(U, X, Y) \sim \pi$, then $U \sim \mathcal{U}([0,1])$ and $(X, Y) \sim \mathbf{P}$. If $(b, \psi)$ is a solution to (37) with $b$ differentiable and $(U, X, Y) \sim \pi$ is a solution to (38), then letting $\beta(\tau)=b^{\prime}(\tau)$, one has the representation

$$
\begin{equation*}
Y=X^{\top} \beta(U) \tag{39}
\end{equation*}
$$

where $X$ is mean-independent from $U$. Beyond the case when $Y$ is scalar, this formulation allows to get a multivariate extension of quantile regression using the notion of vector quantiles; see Carlier, Chernozhukov, Galichon (2016).

### 3.8 Partial identification and random sets

Some problems in econometrics specify incomplete restrictions between a model and an observed variable. Assume, following Galichon and Henry (2011), that we observe a random variable $Y \sim Q$ valued in $\mathcal{Y}$, and that the restrictions given by the model specify $Y \in \Gamma_{\theta}(X)$, and $X \sim P$, where $X$ is a data-generating process valued in $\mathcal{X}$ and $\theta \in \Theta$ is a parameter of the model. $\Gamma_{\theta}$ is a correspondence from $\mathcal{X}$ to $\mathcal{Y}$, such that $\Gamma_{\theta}(x)$ is a subset
of $\mathcal{Y}$. The identified set is the set $\Theta_{I}$ of $\theta \in \Theta$ such that there is a joint distribution $\pi \in \mathcal{M}(P, Q)$ with $\mathbb{E}_{\pi}\left[1\left\{Y \notin \Gamma_{\theta}(X)\right\}\right]=0$. Such a problem can be recast as an optimal transport problem

$$
\begin{equation*}
V=\min _{\pi \in \mathcal{M}(P, Q)} \mathbb{E}_{\pi}\left[1\left\{Y \notin \Gamma_{\theta}(X)\right\}\right] \tag{40}
\end{equation*}
$$

By working on the dual of this problem, one obtains Strassen's theorem (Strassen, 1965)

$$
\begin{equation*}
V=\max _{B}\left\{Q(B)-P\left(\Gamma^{-1}(B)\right)\right\} \tag{41}
\end{equation*}
$$

where the maximum extends over the Borel sets $B$ of $\mathcal{Y}$. Therefore $\theta \in$ $\Theta_{I}$ if and only if $Q(B) \leq P\left(\Gamma^{-1}(B)\right)$ for all $B$. The sample version of problem (40) allows to use optimal assignment algorithms as efficient computational tools to decide if $\theta \in \Theta_{I}$, and dual formulation (41) allows to do inference (Galichon and Henry, 2009).

### 3.9 Generalized linear models

Consider a generalized linear model (GLM) with 2-way fixed effects. The observations are $i j$; the dependent variable is $\hat{\pi}_{i j}$, while the explanatory variables are $\Phi=\left(\phi_{i j}^{k}\right)_{i j, k}$ for $k \in\{1, \ldots, K\}$ and the $i$ and $j$ fixed effects. If $l$ is the link function, which is increasing and continuous, the model is written as

$$
\begin{equation*}
\mathbb{E}\left[\hat{\pi}_{i j} \mid \phi_{i j}^{k}, i, j\right]=l^{-1}\left((\Phi \beta)_{i j}-u_{i}-v_{j}\right) \tag{42}
\end{equation*}
$$

Denote $p_{i}=\sum_{j} \hat{\pi}_{i j}$ and $q_{j}=\sum_{i} \hat{\pi}_{i j}$ the margins of $\hat{\pi}$. Letting $L$ be a primitive of $l$, and letting $L^{*}(w)=\max _{z}\{w z-L(z)\}$ be its convex conjugate,
which is a primitive of $l^{-1}$, one can show that the GLM model can be fit using

$$
\begin{equation*}
\min _{\beta}\left\{W(\beta)-\sum_{i j} \hat{\pi}_{i j}(\Phi \beta)_{i j}\right\} \tag{43}
\end{equation*}
$$

where

$$
\begin{align*}
W(\beta)=\max _{\pi_{i j} \geq 0} & \left\{\sum_{i j} \pi_{i j}(\Phi \beta)_{i j}-\sum_{i j} L\left(\pi_{i j}\right)\right\}  \tag{44}\\
\text { s.t. } & \sum_{j} \pi_{i j}=p_{i}, \sum_{i} \pi_{i j}=q_{j}
\end{align*}
$$

is a regularized optimal transport problem which can be equivalently expressed by its dual:

$$
\begin{equation*}
W(\beta)=\min _{u_{i}, v_{j}}\left\{\sum_{i} p_{i} u_{i}+\sum_{j} q_{j} v_{j}+\sum_{i j} L^{*}\left((\Phi \beta)_{i j}-u_{i}-v_{j}\right)\right\} \tag{45}
\end{equation*}
$$

In particular, the $\log \operatorname{link}$ function $l(z)=\ln z$ yields $l^{-1}(t)=\exp (t)$, and thus $L(z)=z(\ln z-1)$, and $L^{*}(t)=\exp (t)$, and $W(\beta)$ is the solution to an entropy regularized optimal transport problem, as described in paragraph 2.2.1.

### 3.10 Hide-and-seek games

In 1953, von Neumann described the following two-person, zero-sum game. Let ( $K_{i j}$ ) be a $N \times N$ matrix with positive terms. There are two players, "Hider" and "Seeker". Hider plays first and hides in a cell $(i, j)$. Playing second, Seeker highlights either a row or a column they claims contains Hider. If Seeker's claim is correct, then Hider pays Seeker $K_{i j}>0$, otherwise

0 .

Hider's mixed strategy is described by a vector of probabilities $\pi_{i j}$ of hiding in cell $i j$. Once Hider has played, Seeker picks either a column $i^{\prime}$ or a column $j^{\prime}$, whichever of these maximizes $\sum_{j^{\prime}} K_{i j^{\prime}} \pi_{i j^{\prime}}$ over $i$ and $\sum_{i^{\prime}} K_{i^{\prime} j} \pi_{i^{\prime} j}$ over $j$. Let us denote $(a, b)$ the vector of mixed strategies of Seeker, where $a_{i} \geq 0$ is the probability of highlighting a row $i$, and $b_{j} \geq 0$ is the probability of highlighting a column $j$, and $\sum_{i=1}^{n} a_{i}+\sum_{j=1}^{n} b_{j}=1$. If Hider plays strategy $\pi$ and Seeker plays strategy $(a, b)$, the expected payoff of Seeker is therefore

$$
\sum_{i j}\left(a_{i}+b_{j}\right) K_{i j} \pi_{i j}
$$

and hence the value of this zero-sum game for Seeker is obtained by minimizing the above expression over $x_{i j} \geq 0, \sum_{i j} x_{i j}=1$, and maximizing it over $(a, b) \geq 0$ such that $\sum_{i} a_{i}+\sum_{j} b_{j}=1$.

Von Neumann showed that this game is intimately connected with an optimal transport problem. Indeed,

$$
\begin{aligned}
V^{-1}= & \max _{\pi \geq 0} \sum_{i j} \pi_{i j} K_{i j}^{-1}=\min _{u \geq 0, v \geq 0} \sum_{i} \frac{u_{i}}{n}+\sum \frac{v_{j}}{n} \\
& \text { s.t. }\left\{\begin{array}{ll}
\sum_{j} \pi_{i j} \leq 1 / n \\
\sum_{i} \pi_{i j} \leq 1 / n
\end{array} \quad \text { s.t. } u_{i}+v_{j} \geq K_{i j}^{-1}\right.
\end{aligned}
$$

and the solution $\pi_{i j} \geq 0$ to the primal problem yields Hider's optimal strategy, while setting $a_{i}=V u_{i} / n$ and $b_{j}=V v_{j} / n$ yields Seeker's optimal strategy.

Although von Neumann's paper appeared in 1953, it seems that this important connection between a zero-sum game and a linear programming
problem was known to him decades earlier, in anticipation of Dantzig's general connection between linear programming and zero-sum games, cf. Dantzig (1951). See a historical perspective in Kuhn and Tucker (1958).

## 4 The mathematics of optimal transport

### 4.1 Network formulation

As explained in Galichon (2016), chapter 8, the optimal transport problem has the structure of a min-cost flow problem. Introduce a network whose set of nodes is $\mathcal{Z}=\mathcal{X} \cup \mathcal{Y}$ and whose set of arcs is $\mathcal{A}=\mathcal{X} \times \mathcal{Y}$. Such a network is called a bipartite one. Define an $\mathcal{A} \times \mathcal{Z}$ matrix $\nabla$ which is such that

$\nabla_{x y, z}=1\{z=y\}-1\{z=x\}$. Consider the "change of sign trick" where one defined $\tilde{q}=\left(-p^{\top}, q^{\top}\right)^{\top}$ and $\tilde{v}=\left(-u^{\top}, v^{\top}\right)^{\top}$. Define $c_{x y}=-\Phi_{x y}$. The vector $\tilde{q}$ should be interpreted as a vector of quantities, while the vector $\tilde{v}$ should be interpreted as a vector of prices.

Call $C(\tilde{q})$ the value of the optimal transport problem, which rewrites under its primal form as

$$
\begin{align*}
& C(\tilde{q})= \min _{\pi \geq 0}  \tag{46}\\
& \text { s.t. } \quad \nabla^{\top} \pi=\tilde{q}
\end{align*}
$$

when $q^{\top} 1 \mathcal{Z}=0$, and $C(\tilde{q})=+\infty$ otherwise. Equivalently, $C(\tilde{q})$ can be
expressed by its dual value as

$$
\begin{array}{r}
C(\tilde{q})=\max _{\tilde{v}} \quad \tilde{q}^{\top} \tilde{v} \\
\text { s.t. } \quad \nabla \tilde{v} \leq c .
\end{array}
$$

This is an instance of the min-cost flow problem, which makes sense more generally on any (not necessarily bipartite) network.

### 4.2 Equilibrium expression

By convex duality, denoting

$$
\begin{equation*}
C^{*}(\tilde{v})=\max _{\tilde{q}}\left\{\tilde{q}^{\top} \tilde{v}-C(\tilde{q})\right\} \tag{47}
\end{equation*}
$$

the convex conjugate of $C$, it can be seen that $C^{*}(\tilde{v})=0$ if $\nabla \tilde{v} \leq c$ and $+\infty$ otherwise, and one has

$$
\begin{equation*}
C(\tilde{q})=\max _{\tilde{v}}\left\{\tilde{q}^{\top} \tilde{v}-C^{*}(\tilde{v})\right\} \tag{48}
\end{equation*}
$$

Further, the set of $\tilde{v}=(-u, v)$ where $u$ and $v$ are solutions to problem (2) are the maximizers of (48).

In the case of the entropy regularized problem (5)-(6), these expressions become respectively

$$
\begin{align*}
C_{\sigma}(\tilde{q})=\min _{\pi \geq 0} & \pi^{\top} c+\sigma \pi^{\top} \log \pi  \tag{49}\\
& \text { s.t. } \nabla^{\top} \pi=\tilde{q}
\end{align*}
$$

and

$$
\begin{equation*}
C_{\sigma}^{*}(\tilde{v})=\sigma 1^{\top} \exp \left(\frac{c-\nabla \tilde{v}}{\sigma}\right) \tag{50}
\end{equation*}
$$

Keeping in mind the interpretation of $\tilde{q}$ as quantities and $\tilde{v}$ as prices, one should view $C(\tilde{q})$ as a cost function, expression $\tilde{v}^{\top} \tilde{q}-C_{\sigma}(\tilde{q})$ as a profit, and $C^{*}(\tilde{v})$ as an indirect profit function. Hence, expression (47) should be viewed as a profit maximization problem. The optimal transport problem consists of looking for the potentials $\tilde{v}$ that maximize $\tilde{q}^{\top} \tilde{v}-C^{*}(\tilde{v})$. By convex duality (see chapter 6 of Galichon, 2016), this is equivalent with

$$
\begin{equation*}
\tilde{v} \in \partial C(\tilde{q}) \tag{51}
\end{equation*}
$$

which, still by convex analysis, is equivalent with

$$
\begin{equation*}
\tilde{q} \in \partial C^{*}(\tilde{v}) \tag{52}
\end{equation*}
$$

Therefore, $\partial C^{*}$ should be interpreted as a supply correspondence, while $\partial C=$ $\left(\partial C^{*}\right)^{-1}$ should be interpreted as an inverse supply correspondence. The same intepretation extends immediately to the regularized versions of these objects.

### 4.3 Mathematical structures

The optimal transport problem is blessed with the priviledge to belong to the intersection of two rich theories: convex optimization and gross substitutes. There are, broadly speaking, two structures whithin which the equilibrium
problem

$$
\begin{equation*}
\tilde{q} \in Q(\tilde{v}) \tag{53}
\end{equation*}
$$

is well understood.

- The first one is convex optimization: $Q$ is the subdifferential of a convex function. Then the problem is a convex optimization problem, and convex optimization can be put to use to solve problem (53).
- The second case is gross substitutes: loosely speaking, $q_{x}$ cannot increase when $\tilde{v}_{y}$ increases $(x \neq y)$. This setting is needed for coordinate update algorithms such as Jacobi or Gauss-Seidel to converge, see Rheinboldt (1970).

In optimal transport, both structures are met, as we shall now see.

### 4.3.1 Convex optimization

Recall that the cost function $C$ and the indirect cost function $C^{*}$ defined above are convex functions, which are dual one to another in the sense of convex analysis. It follows that $\partial C^{*}(\tilde{v})$ and $\partial C(\tilde{q})$ are convex sets, and problems (51) and (52) can be solved as convex optimization problems dual to each other, respectively (48) and (47). In the unregularized case, these problems are linear programming problems. In the regularized case, the convexity structure is retained, but the problems are of course no longer linear.

### 4.3.2 Gross substitutes

When $\sigma>0$ it is easy to see that the indirect profit function $C_{\sigma}^{*}(\tilde{v})$ is submodular. It is not very hard to extend this result to the unregularized case to show that $C^{*}(\tilde{v})$ is submodular as well. As a result, the corresponding supply function satisfies Kelso and Crawford's (1982) gross substitutes property.

A remark is in order here. It may be a surprise that the optimal transport problem has the gross substitutes property, as common sense suggests that workers and firms should be complements, and not substitutes. However, keep in mind the "change-of-sign trick" implemented at paragraph 4.1: we defined $\tilde{v}=\left(-u^{\top}, v^{\top}\right)^{\top}$, and therefore we switched the sign of the worker's payoffs (and of their quantities accordingly). This change of sign is the reason why the optimal transport problem, in spite of being a problem with complementarities, reformulates as a problem with gross substitutes. See Sun and Yang (2006).

We can formulate gross substitutes properties of $C$ and $C^{*}$ in the language of L- and M-convexity, introduced by Murota (1998). Indeed, as the domain of $C$ is the set of $\tilde{q}$ such that $\tilde{q}^{\top} 1_{\mathcal{Z}}=0$, and as $C^{*}\left(\tilde{v}+\lambda 1_{\mathcal{Z}}\right)=C^{*}(\tilde{v})$ for all $\lambda \in \mathbb{R}$, it follows that $C$ is a $M$-convex function and $C^{*}$ is a $L$-convex function, and the supply bundle $\partial C^{*}(\tilde{v})$ is a $M$-convex set of $\mathbb{R}^{\mathcal{Z}}$, while $\partial C(\tilde{q})$ is a L-convex set, still in the terminology of the same author. In particular, $\partial C(\tilde{q})$ is a lattice, while $\partial C^{*}(\tilde{v})$ is a base polyhedron.

### 4.4 Extensions

As we have seen just above, the optimal transport problem can be formulated (at least under its regularized form) as a set of nonlinear equations $Q(p)=q$, where $Q$ happens to be the subdifferential of a convex function which is also submodular, and hence optimal transport belongs to both convexity and gross substitutes families. Some extensions of the optimal transport problem retain both convexity and gross substitutes. This is the case of the min-cost flow problem, for instance, as described in paragraph 4.1.

### 4.4.1 Problems that retain convexity, but not substitutability

Some problems retain convex optimization but not gross substitutes, such as one-to-many matching problems with transferable utility, see a related discussion in Azevedo and Hatfield (2018). Vector quantile regression, discussed above in paragraph 3.7.2, falls in that category, too.

In ongoing work with Pauline Corblet and Jeremy Fox 2020, we investigate a problem of dynamic matching that retains most of the convexity structure of optimal transport. The problem we study is a two-sided version of Rust (1987)'s model. More specifically, assume that conditional of a worker of type $X=x$ matching with a firm of type $y$, there is a probability $\mathbb{P}_{x^{\prime} \mid x y}$ that the worker will transition to type $x^{\prime}$ at the next period, and a probability $\mathbb{Q}_{y^{\prime} \mid x y}$ that the firm will transition to type $y^{\prime}$. In this case, the joint matching surplus should be the sum of the short-term surplus $\Phi_{x y}$ and the expected discounted future payoffs of the worker and of the firm, respectively denoted $\beta \mathbb{P}\left[u_{X} \mid x y\right]$ and $\beta \mathbb{Q}\left[v_{Y} \mid x y\right]$.

In this case, when $\beta=1$, Corblet et al. (2020) show that both the equilibrium computation and the estimation can be handled by the following saddle-point problem:

$$
\max _{n, m} \min _{u, v, \lambda} H(n, m, u, v, \lambda)
$$

where one has defined $H(n, m, u, v, \lambda)=$

$$
\left\{\begin{array}{l}
2 \sum_{x y \in \mathcal{X} \times \mathcal{Y}} \sqrt{n_{x} m_{y}} \exp \left(\frac{\sum_{k} \phi_{x y}^{k} \lambda_{k}+\mathbb{P}\left[u_{X} \mid x y\right]+\mathbb{Q}\left[v_{Y} \mid x y\right]-u_{x}-v_{y}}{2}\right) \\
+\sum_{x \in \mathcal{X}} n_{x} \exp \left(\sum_{k} \phi_{x 0}^{k} \lambda_{k}+\mathbb{E}\left[u_{X^{\prime}} \mid X=x\right]-u_{x}\right) \\
+\sum_{y \in \mathcal{Y}} m_{y} \exp \left(\sum_{k} \phi_{0 y}^{k} \lambda_{k}+\mathbb{E}\left[v_{Y}, \mid Y=y\right]-v_{y}\right) \\
-\sum_{x \in \mathcal{X}} n_{x}-\sum_{y \in \mathcal{Y}} m_{y}
\end{array}\right.
$$

which is convex in $(n, m)$ and concave in $(u, v, \lambda)$. Corblet et al. (2020) use this formulation to derive an algorithm to estimate the structural parameter $\lambda$ efficiently. They find that the algorithm extends to the case $\beta<1$. Dupuy et al. (2020) apply these ideas to family economics and fertility decisions.

### 4.4.2 Problems that retain substitutability, but not convexity

On the contrary, some problems retain the gross substitutes property, but not the convexity one. This is the case with one-to-one matching models with nontransferable utility, as shown by Adachi (2000), and with one-to-one matching models with imperfectly transferable utility, to handle in particular taxes, salary caps, public goods, etc. See Galichon, Kominers and Weber (2019). Non-additive random utility models and hedonic models beyond quasi-linear utility are also in this case. To handle these challenges, a more
general framework is needed, the equilibrium flow problem, which is the subject of current ongoing work by the author with Larry Samuelson and Lucas Vernet (2021). The equilibrium flow problem posits three objects. First a network $(\mathcal{Z}, \mathcal{A})$ is defined as in paragraph 4.1 , where $x y \in \mathcal{Z}$ is interpreted as the existence of a trade route from node $x$ to node $y$, and whose node-incidence matrix is denoted $\nabla$. Second, a vector of outflows $q \in \mathbb{R}^{\mathcal{Z}}$, where $q_{z}$ is interpreted as the mass that must leave the network at $z\left(q_{z}<0\right.$ means that mass actually appears at $\left.z\right)$. One assumes that $\sum_{z \in \mathcal{Z}} q_{z}=0$, so all the mass that enters the networks must leave it. Finally, a set of connection functions $G_{x y}: \mathbb{R} \rightarrow \mathbb{R}$ for each $x y \in \mathcal{A}$, which are increasing and whose interpretation is that $G_{x y}\left(p_{y}\right)-p_{x}$ is the profit of a carry trade, consisting of purchasing one unit of the commodity at price $p_{x}$ at node $x$, shipping to $y$, and selling at price $p_{y}$ at node $y$.

Given these inputs, the equilibrium flow problem consists of determining a vector of flows $\mu \in \mathbb{R}_{+}^{\mathcal{Z}}$ and prices $p \in \mathbb{R}^{\mathcal{Z}}$ such that:

(i) mass balance holds: the sum of mass that arrives at $z$ minus the sum that leaves is equal to $q_{z}$, that is, $\nabla^{\top} \mu=q$.

(ii) absence of arbitrage holds: there cannot be a positive rent associated with the carry trade over any arc, that is, $p_{x} \geq G_{x y}\left(p_{y}\right)$ for any $x y \in \mathcal{A}$.

(iii) individual rationality holds: if the carry trade over arc $x y$ is actually performed, then the associated profit cannot be negative, and thus, $\mu_{x y}>0$ implies $p_{x}=G_{x y}\left(p_{y}\right)$.

Galichon, Samuelson and Vernet (2021) show that this framework is general enough to encompass optimal transport problems, min-cost flow problems including shortest path problems, matching models with imperfectly
transferable utility, hedonic models, and supply chain problems.

## 5 Concluding discussion

To conclude, an attempt should be made to explain the claim to "unreasonable effectiveness" of optimal transport in economics, alluding to a celebrated formula of Wigner (1960). We believe that one of the reasons of the prevalence of optimal transport in economics is that the former strikes a good compromise between what models would like to capture and what they are capable of capturing.

Economics is, in a broad sense, the study of complementarities: capital and labor, worker and firms, supply and demand, buyers and sellers... all exhibit some complementarity which is at the source of economic activity. However, as it is now well understood since the insights of Kelso and Crawford (1982), problems with complementarities are hard to handle, and in particular, hard to compute. Fortunately, due to the bipartite structure, the "change-of-sign trick" described in paragraph 4.1 allowed us to reformulate the problem as a problem with gross substitutes, and therefore, let us enjoy the computational and structural benefits of a problem with gross substitutes. In some sense, the bipartite structure of optimal transport is a meeting point between the complementarity that models would like to capture, and the substitutability structure that they they are able to capture.

To make another analogy with Physics, the situation is similar to the two-body problem in cosmology, which has a tractable formulation and can be fully worked out - while the $n$-body problem with $n$ larger than two is
notoriously hard. Fortunately, just as in cosmology where many situations can be satisfactorily approximated by a two-body problem, in economics, many phenomenons can be captured using the bipartite approximation. We have surveyed some of these applications in the present paper, but certainly not in an exhaustive way. And optimal transport is a galaxy where there are many more planets, only waiting to be explored.

## References

Adachi, H. (2000). On a characterization of stable matchings. Economics Letters, 68(1), 43-49.

Anderson, J. E., \& Van Wincoop, E. (2003). Gravity with gravitas: A solution to the border puzzle. American Economic Review, 93(1), 170192 .

Azevedo, E. M., \& Hatfield, J. W. (2018). Existence of equilibrium in large matching markets with complementarities. SSRN Electronic Journal.

Becker, G. S. (1973). A theory of marriage: Part i. Journal of Political Economy, 81(4), 813-846.

Berry, S., Levinsohn, J., \& Pakes, A. (1995). Automobile prices in market equilibrium. Econometrica, 63 (4), 841-890.

Berry, S. T. (1994). Estimating discrete-choice models of product differentiation. The RAND Journal of Economics, 25(2), 242-262.

Bonnet, O., Galichon, A., Hsieh, Y.-W., O'Hara, K., \& Shum, M. (2021). Yogurts choose consumers? estimation of random utility models via
two-sided matching [Available at SSRN - Social Science Research Network].

Brenier, Y. (1987). Polar factorization and monotone rearrangement of vectorvalued functions. C. R. Acad. Sci. Paris, Ser. I, Mathematical Analysis, 305, 805-808.

Carlier, G., Chernozhukov, V., De Bie, G., \& Galichon, A. (2020). Vector quantile regression and optimal transport, from theory to numerics. Empirical Economics.

Carlier, G., Chernozhukov, V., \& Galichon, A. (2016). Vector quantile regression: An optimal transport approach. The Annals of Statistics, $44(3), 1165-1192$.

Carlier, G., Chernozhukov, V., \& Galichon, A. (2017). Vector quantile regression beyond the specified case. Journal of Multivariate Analysis, $161,96-102$.

Carlier, G., Dupuy, A., Galichon, A., \& Sun, Y. (2021, June 2). SISTA: Learning optimal transport costs under sparsity constraints (SSRN Scholarly Paper ID 3855961). Rochester, NY.

Chernozhukov, V., Galichon, A., Hallin, M., \& Henry, M. (2017). Monge kantorovich depth, quantiles, ranks and signs. The Annals of Statistics, $45(1), 223-256$.

Chernozhukov, V., Galichon, A., Henry, M., \& Pass, B. (2021). Identification of hedonic equilibrium and nonseparable simultaneous equations. Journal of Political Economy, 129(3), 842-870.

Chiappori, P.-A., McCann, R. J., \& Nesheim, L. P. (2010). Hedonic price equilibria, stable matching, and optimal transport: Equivalence, topology, and uniqueness. Economic Theory, 42(2), 317-354.

Chiong, K. X., Galichon, A., \& Shum, M. (2016). Duality in dynamic discretechoice models. Quantitative Economics, 7(1), 83-115.

Choo, E., \& Siow, A. (2006). Who marries whom and why. Journal of Political Economy, 114(1), 175-201.

Ciscato, E., Dupuy, A., Fox, J., Galichon, A., \& Weber, S. (2020). Family dynamics: Marriage, fertility and divorce [In progress].

Cuturi, M. (2013). Sinkhorn distances: Lightspeed computation of optimal transport. Advances in Neural Information Processing Systems, 26.

Dantzig, G. B. (1951). A proof of the equivalence of the programming problem and the game problem. Activity analysis of production and allocation, (13), 330-338.

Duffie, D. (1992). Dynamic asset pricing theory (Princeton, Ed.).

Dupuy, A., \& Galichon, A. (2014). Personality traits and the marriage market. Journal of Political Economy, 122(6), 1271-1319.

Dupuy, A., Galichon, A., \& Sun, Y. (2019). Estimating matching affinity matrices under low-rank constraints. Information and Inference: A Journal of the IMA, 8(4), 677-689.

Ekeland, I., Galichon, A., \& Henry, M. (2012). Comonotonic measures of multivariate risks. Mathematical Finance, 22(1), 109-132.

Ekeland, I., Heckman, J. J., \& Nesheim, L. (2004). Identification and estimation of hedonic models. Journal of Political Economy, 112, S60S109.

Fox, Galichon, \& Corblet. (2020). A dynamic model of two-sided matching [In progress.].

Franklin, J., \& Lorenz, J. (1989). On the scaling of multidimensional matrices. Linear Algebra and its Applications, 114-115, 717-735.

Galichon, A., Henry-Labordère, P., \& Touzi, N. (2014). A stochastic control approach to no-arbitrage bounds given marginals, with an application to lookback options. The Annals of Applied Probability, 24(1), $312-336$.

Galichon, A. (2016). Optimal transport methods in economics (Princeton, Ed.).

Galichon, A., \& Henry, M. (2009). A test of non-identifying restrictions and confidence regions for partially identified parameters. Journal of Econometrics, 152(2), 186-196.

Galichon, A., \& Henry, M. (2011). Set identification in models with multiple equilibria. The Review of Economic Studies, 78 (4), 1264-1298.

Galichon, A., \& Henry, M. (2012). Dual theory of choice with multivariate risks. Journal of Economic Theory, 147(4), 1501-1516.

Galichon, A., Kominers, S. D., \& Weber, S. (2019). Costly concessions: An empirical framework for matching with imperfectly transferable utility. Journal of Political Economy, 127(6), 2875-2925.

Galichon, A., \& Salanié, B. (2021). Cupid's invisible hand: Social surplus and identification in matching models. Review of Economic Studies, forthcoming.

Galichon, A., Samuelson, L., \& Vernet, L. (2021). The equilibrium flow problem [In progress].

Guimarães, P., \& Portugal, P. (2010). A simple feasible procedure to fit models with high-dimensional fixed effects. Stata Journal, 10(4), 628649 .

Head, K., \& Mayer, T. (2013). Gravity equations: Workhorse, toolkit, and cookbook.

Henry-Labordere, P. (2020). Model-free hedging: A martingale optimal transport viewpoint - 1 st edi.

Idel, M. (2016). A review of matrix scaling and sinkhorn's normal form for matrices and positive maps.

Kelso, A. S., \& Crawford, V. P. (1982). Job matching, coalition formation, and gross substitutes. Econometrica, 50(6), 1483-1504.

Koenker, R. (2005). Quantile regression.

Koenker, R., \& Bassett, G. (1978). Regression quantiles. Econometrica, $46(1), 33-50$.

Koenker, R., \& Ng, P. (2005). Inequality constrained quantile regression. Sankhyā: The Indian Journal of Statistics (2003-2007), 67(2), 418440 .

Kuhn, H. W., Tucker, A. W. et al. (1958). John von neumann's work in the theory of games and mathematical economics. Bulletin of the American Mathematical Society, 64 (3, Part 2), 100-122.

Léger, F. (2020). A gradient descent perspective on sinkhorn. Applied Mathematics 8 Optimization.

Léonard, C. (2014). A survey of the schrödinger problem and some of its connections with optimal transport. Discrete $\&^{2}$ Continuous Dynamical Systems, $34(4), 1533$.

Murota, K. (1998). Discrete convex analysis. Mathematical Programming, 83(1), 313-371.

Ortega, J. M., \& Rheinboldt, W. C. (1970). Iterative solution of nonlinear equations in several variables.

Peyré, G., \& Cuturi, M. (2019). Computational optimal transport: With applications to data science. Foundations and Trends in Machine Learning, $11(5), 355-607$.

Rust, J. (1987). Optimal replacement of gmc bus engines: An empirical model of harold zurcher. Econometrica: Journal of the Econometric Society, 999-1033.

Santambrogio, F. (2015). Optimal transport for applied mathematicians: Calculus of variations, PDEs, and modeling. Birkhäuser Basel.

Shapley, L. S., \& Shubik, M. (1971). The assignment game i: The core. International Journal of Game Theory, 1(1), 111-130.

Silva, J. M. C. S., \& Tenreyro, S. (2006). The log of gravity. The Review of Economics and Statistics, 88(4), 641-658.

Strassen, V. (1965). The existence of probability measures with given marginals. The Annals of Mathematical Statistics, 36(2), 423-439.

Sun, N., \& Yang, Z. (2006). Equilibria and indivisibilities: Gross substitutes and complements. Econometrica, 74 (5), 1385-1402.

Villani, C. (2003). Topics in optimal transportation. American Mathematical Soc.

Villani, C. (2009). Optimal transport: Old and new. Springer-Verlag.

Von Neumann, J. (1953). 1. a certain zero-sum two-person game equivalent to the optimal assignment problem. Contributions to the theory of games (am-28), volume ii (pp. 5-12).

Wigner, E. P. (1960). The unreasonable effectiveness of mathematics in the natural sciences. richard courant lecture in mathematical sciences delivered at new york university, may 11, 1959. Communications on Pure and Applied Mathematics, 13(1), 1-14.

Wilson, A. G. (1969). The use of entropy maximising models, in the theory of trip distribution, mode split and route split. Journal of transport economics and policy, 108-126.


[^0]:    ${ }^{*}$ New York University and Sciences Po, Email: alfred.galichon@nyu.edu. Support from the European Research Council under Grant Agreement No. 866274 "Equiprice" as well as research assistance by Gabriele Buontempo and Giovanni Montanari are gratefully acknowledged.

[^1]:    ${ }^{1}$ See Idel (2016) for a historical survey.

[^2]:    ${ }^{2}$ Note that as $\varepsilon$ has a density, the probability of ties is zero, and therefore the arg max has almost surely one element.

</end of paper 1>


<paper 2>
# Monotone Comparative Statics for Equilibrium Problems 

Alfred Galichon ${ }^{\dagger}$, Larry Samuelson ${ }^{b}$, and Lucas Vernet ${ }^{\S}$

July 15,2022


#### Abstract

We introduce a notion of substitutability for correspondences and establish a monotone comparative static result, unifying results such as the inverse isotonicity of M-matrices, Berry, Gandhi and Haile's identification of demand systems, monotone comparative statics, and results on the structure of the core of matching games without transfers (Gale and Shapley) and with transfers (Demange and Gale). More specifically, we introduce the notions of unified gross substitutes and nonreversingness and show that if $\mathrm{Q}: P \rightrightarrows Q$ is a supply correspondence defined on a set of prices $P$ which is a sublattice of $\mathbb{R}^{N}$, and $Q$ satisfies these two properties, then the set of equilibrium prices $\mathbf{Q}^{-1}(q)$ associated with a vector of quantities $q \in Q$ is increasing (in the strong set order) in $q$; and it is a sublattice of $P$.


${ }^{\dagger}$ Economics Department, FAS, and Mathematics Department, Courant Institute, New York University; and Economics Department, Sciences Po. Email: ag133@nyu.edu. Galichon gratefully acknowledges funding from NSF grant DMS1716489 and ERC grant CoG-866274.

${ }^{b}$ Department of Economics, Yale University. Email: larry.samuelson@yale.edu.

${ }^{\S}$ Economics Department, Sciences Po, and Banque de France. Email: lucas.vernet@acpr.banque-france.fr.

## Contents

1 Introduction ..... 1
2 Theory ..... 2
2.1 Unified Gross Substitutes ..... 2
2.1.1 Definition ..... 2
2.1.2 Properties ..... 3
2.2 Nonreversingness ..... 5
2.2.1 Definitions ..... 5
2.2.2 Properties ..... 5
2.3 M0-correspondences and Inverse Isotonicity ..... 8
2.3.1 M0-correspondences and Related Notions ..... 8
2.3.2 Inverse Isotonicity Theorems ..... 10
3 Connections with Existing Theories ..... 12
3.1 Kelso and Crawford's Gross Substitutes ..... 12
3.2 Polterovich and Spivak's Gross Substitutes ..... 13
3.3 Berry, Gandhi and Haile's Connected Strict Substitutes ..... 13
3.4 Topkis' Theorem ..... 15
4 Applications ..... 16
4.1 Profit Maximization ..... 16
4.2 Structures of Solutions ..... 18
4.3 An Equilibrium Flow Problem ..... 18
4.4 Matching with (Fully or Imperfectly) Transferable Utility ..... 23
4.5 Matching Without Transfers ..... 24
4.6 Hedonic Pricing ..... 26
5 Conclusion ..... 28
A Appendix ..... 28
A. 1 Aggregation Preserves Unified Gross Substitutes ..... 28
A. 2 The Sum of Two M0-correspondences is Not Always an M0-correspondence ..... 29
A. 3 Kelso and Crawford's Substitutes Does Not Imply Unified Gross Substitutes ..... 29
A. 4 Unified Gross Substitutes and Polterovich and Spivak's Property Are Independent ..... 30
A. 5 Outside Goods and Weighted Monotonicity ..... 31
A. 6 Connections with Monotone Comparative Statics ..... 32
A. 7 Proof of Theorem 3 . ..... 33
A. 8 Proof of Theorem 5 . ..... 38
A. 9 Matching and Equilibrium Flows ..... 39
A. 10 Proof of Theorem 7 ..... 40
A. 11 Proof of Theorem 8 ..... 41
A. 12 Proof of Theorem 9 ..... 42
B Online Appendix ..... 46
B. 1 Weak or Strong Inequalities? ..... 46
B. 2 Nonreversingness and Aggregate Monotonicity but Not Monotone Total Output ..... 48
B. 3 Equivalent Definitions of M-functions ..... 49
B. 4 Imperfect Competition ..... 49
B. 5 Partial Inverse Correspondence ..... 51
B. 6 Structures of Solutions ..... 52

## Monotone Comparative Statics for Equilibrium Problems

## 1 Introduction

This paper proposes the notion of unified gross substitutes for a correspondence $\mathrm{Q}: P \rightrightarrows Q$. For concreteness we often interpret $\mathrm{Q}$ as a supply correspondence mapping from a set of prices $P$ to a set of quantities $Q$, though our analysis applies to correspondences in general. Our analysis encompasses the familiar case in which $\mathrm{Q}$ arises from the optimization problem of a single agent, but unified gross substitutes need not refer to a single agent's decision problem, and we are especially interested in its potential for the study of equilibrium problems.

Our focus is the inverse isotonicity of the correspondence Q. We show that if the correspondence $\mathrm{Q}$ satisfies unified gross substitutes as well as a mild condition called nonreversingness, then the set of parameters $\mathrm{Q}^{-1}(q)$ associated with an element $q \in Q$ is increasing (in the strong set order) in $q$ and is a sublattice of $P$.

For functions, the notion of unified gross substitutes is equivalent to the familiar notion of weak gross substitutes. Berry, Gandhi and Haile [5] provide an inverse isotonicity result for functions and explain the importance of inverse isotonicity. One can view our work as generalizing their result to correspondences. In some cases, there is a natural formulation of the inverse $\mathrm{Q}^{-1}$ as the solution to an optimization problem. We can then (under appropriate conditions) apply the monotone comparative statics results of Topkis [34 and Milgrom and Shannon [22] to obtain inverse isotonicity. One can view our work as extending the study of monotone comparative statics beyond optimization problems.

For correspondences, the notion of unified gross substitutes implies (but is not equivalent to) Kelso and Crawford's [20] notion of gross substitutes for correspondences, which is too weak to imply our inverse isotonicity result. The notion of unified gross substitutes is related to the generalization of $M$-matrices to $M$-functions introduced by More and Rheinboldt [24] and is independent of a similar substitutes notion introduced by Polterovich and Spivak [29].

We show that unified gross substitutes for the argmax correspondence of a maximization problem is equivalent to the submodularity of the value function, generalizing a familiar result for argmax functions. We introduce a new equilibrium problem, referred to as the equilibrium flow problem, that contains a number of familiar settings as special cases and whose equilibrium correspondence satisfies unified gross substitutes. This provides a new route to the result that the set of stable matches in matching problems with transfers (as in Demange and Gale [9]) and without transfers form a sublattice. Finally, we examine hedonic pricing problems (cf. Rosen [32] and Ekeland, Heckman and Nesheim [11]), extending the basic results of Chiappori, McCann and Nesheim [8] beyond quasilinear utilities and establishing an inverse isotonicity result for such models.

## 2 Theory

When $u$ and $v$ are two elements of a partially ordered set $(\mathcal{S}, \leq)$, we use $u<v$ to express that $u \leq v$ and $u \neq v$. Let $P \subseteq \mathbb{R}^{N}$ and $Q \subseteq \mathbb{R}^{N}$, for some finite $N$, with generic elements $p \in P$ and $q \in Q$. Let $\mathrm{Q}: P \rightrightarrows Q$ be a correspondence. We maintain the following assumption throughout, typically without explicit mention:

Assumption 1. $P$ is a sublattice of $\mathbb{R}^{N}$.

Recall from Topkis [34, p. 13] that a set $P$ is a sublattice of $\mathbb{R}^{N}$ if for any pair of vectors $p, p^{\prime} \in P$, the set $P$ also contains their least upper bound (denoted by $p \vee p^{\prime}$ and defined as the coordinate-wise maximum of $p$ and $p^{\prime}$ ) as well as their greatest lower bound (denoted by $p \wedge p^{\prime}$ and defined as the coordinate-wise minimum of $p$ and $\left.p^{\prime}\right)$.

In one of our leading interpretations of the correspondence $\mathrm{Q}$, we view the dimensions of $\mathbb{R}^{N}$ as identifying goods and interpret $\mathrm{Q}$ as a supply correspondence. An element $p \in P$ is then a price vector, with $p_{z}$ denoting the price of good $z \in\{1, \ldots, N\}$. An element $q \in \mathrm{Q}(p)$ is an allocation, with $q_{z}$ denoting the quantity of good $z$ supplied at price vector $p$. No matter what the interpretation, we typically refer to elements of $q$ as quantities and elements of $p$ as prices.

### 2.1 Unified Gross Substitutes

### 2.1.1 Definition

Our basic notion of substitutability for correspondences is:

Definition 1 (Unified Gross Substitutes). The correspondence $\mathbf{Q}$ : $P \rightrightarrows Q$ satisfies unified gross substitutes if, given $p \in P, p^{\prime} \in P, q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, there exists $q^{\wedge} \in \mathrm{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\vee} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$ such that

$$
\begin{align*}
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z} \leq q_{z}^{\wedge} \text { and } q_{z}^{\vee} \leq q_{z}^{\prime}  \tag{1}\\
& p_{z}^{\prime}<p_{z} \quad \Longrightarrow \quad q_{z}^{\prime} \leq q_{z}^{\wedge} \text { and } q_{z}^{\vee} \leq q_{z} \tag{2}
\end{align*}
$$

Figure 1 gives an illustration of the unified gross substitutes property with two goods. This definition is appropriate for our interpretation of $\mathrm{Q}$ as a supply correspondence, and would need to be adjusted in a straightforward way for applications to demand correspondences 1 Section 3 connects this definition with existing notions in the literature and explains what is unified by this concept.
\footnotetext{
${ }^{1}$ The counterpart of $(1)-\sqrt{2}$ would then be

$$
\begin{equation*}
p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z} \geq q_{z}^{\wedge} \text { and } q_{z}^{\vee} \geq q_{z}^{\prime} \tag{3}
\end{equation*}
$$

$$
\begin{equation*}
p_{z}^{\prime}<p_{z} \quad \Longrightarrow \quad q_{z}^{\prime} \geq q_{z}^{\wedge} \text { and } q_{z}^{\vee} \geq q_{z} \tag{4}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-05.jpg?height=662&width=1070&top_left_y=299&top_left_x=516)

Figure 1: An illustration of the unified gross substitutes property with two goods. Q is a mapping between the set of prices on the left and the set of quantities on the right with $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$. Definition 1 imposes that there exists a $q^{\vee} \in\left(p \vee p^{\prime}\right)$, smaller than the top-right border of the rectangle drawn in the set of quantities, and a $q^{\wedge} \in\left(p \wedge p^{\prime}\right)$ larger than the bottom-left border.

One might be tempted to strengthen this definition by making the antecedents of (1)-(2) both weak inequalities. The resulting notion is not only stronger than we need, but vitiates many of our equivalence results and too often fails to hold. Appendix B. 1 provides an example. Notice that, given the ability to interchange the prices $p$ and $p^{\prime}$, it is irrelevant which antecedent carries the strict inequality, as long as one does.

### 2.1.2 Properties

This section collects some basic properties of unified gross substitutes. We first show that in the case of a function, unified gross substitutes is equivalent to the the textbook notion of weak gross substitutes (e.g., Mas-Colell, Green and Whinston [21, Definition 17.F.2, p. 611]). ${ }^{2}$

Property 1. For functions, unified gross substitutes and weak gross substitutes are equivalent. Recall that a function $\mathrm{q}: \mathbb{R}^{N} \rightarrow \mathbb{R}^{N}$ satisfies weak gross[^0]substitutes, or equivalently is off-diagonally isotone, or is a Z-map (Plemmons [28]), if and only if $\mathrm{q}_{i}(p)$ is nonincreasing in $p_{j}$ for $i \neq j$.

We now show that the function q satisfies weak gross substitutes if and only if the correspondence $\mathrm{Q}(p)=\{\mathrm{q}(p)\}$ satisfies unified gross substitutes. First let $\mathrm{q}$ satisfy weak gross substitutes, take $q=\mathrm{q}(p)$ and $q^{\prime}=\mathrm{q}\left(p^{\prime}\right)$, and let $q^{\wedge}=\mathrm{q}\left(p \wedge p^{\prime}\right)$ and $q^{\vee}=\mathrm{q}\left(p \vee p^{\prime}\right)$. Then $p_{z} \leq p_{z}^{\prime} \Longrightarrow\left(p \wedge p^{\prime}\right)_{z}=p_{z}$, which combines with $p \wedge p^{\prime} \leq p$ and weak gross substitutes to give $\mathrm{q}_{z}(p) \leq \mathrm{q}_{z}\left(p \wedge p^{\prime}\right)$ and hence the first part of (1). The other requirements in (1)-(2) are dealt with similarly, and hence $Q$ satisfies unified gross substitutes. Conversely, let $\mathrm{Q}(p)=\{\mathrm{q}(p)\}$ satisfy unified gross substitutes, let $p_{j} \geq p_{j}^{\prime}$ and $p_{i}=p_{i}^{\prime}$ for all $i \neq j$. Then $p^{\wedge}=p^{\prime}$ and $p^{\vee}=p$, so that applying (1) to some $i \neq j$ gives $\mathrm{q}_{i}(p) \leq \mathrm{q}_{i}\left(p^{\prime}\right)$, and hence $\mathrm{q}$ satisfies weak gross substitutes.

We next note that if the correspondence $\mathrm{Q}$ is the solution to a maximization problem, the unified gross substitutes condition admits a familiar characterization. Ausubel and Milgrom [3, Theorem 10] show that a demand correspondence satisfies a weak gross substitutes property (namely that $\mathrm{q}_{i}(p)$ is nonincreasing in $p_{j}$ for $i \neq j$ and for those $p$ for which $\mathrm{q}(p)$ is single-valued) if and only if the associated indirect utility function is submodular. We establish an analogous condition for unified gross substitutes.

Property 2. Subdifferentials of convex submodular functions satisfy unified gross substitutes. Let $c^{*}: \mathbb{R}^{N} \rightarrow \mathbb{R}$ be a convex function and consider the subdifferential of $c^{*}$, given by $\partial c^{*}(p)=\left\{q: p^{\prime} \rightarrow\left[q^{\top} p^{\prime}-c^{*}\left(p^{\prime}\right)\right]\right.$ is maximal at $\left.p\right\}$. Theorem 3 in Section 4.1 shows that $c^{*}$ is submodular if and only if the correspondence $p \rightrightarrows \partial c^{*}(p)$ satisfies unified gross substitutes.

Section 4.1 shows that we can think of $c^{*}$ as the indirect profit function associated with a profit maximization problem, which is necessarily convex, allowing us to conclude that the associated supply correspondence satisfies unified gross substitutes if and only if the indirect profit function is submodular.

Property 9 below illustrates one use of the following property.

Property 3. Monetary measurement preserves unified gross substitutes. Given an excess supply correspondence $\mathrm{Q}$ for a competitive economy, we can define the excess supply correspondence expressed in monetary terms as

$$
\mathbf{Q}^{\$}(p)=\left\{\left(p_{z} q_{z}\right)_{z \in\{1, \ldots, N\}} \text { with } q \in \mathbb{Q}(p)\right\}
$$

It is straightforward to verify that when the domain $P$ of $\mathrm{Q}$ is included in $\mathbb{R}_{+}^{N}$, so that prices are nonnegative, then $\mathrm{Q}$ satisfies unified gross substitutes if and only if $Q^{\$}$ satisfies unified gross substitutes.

The following property shows that unified gross substitutes aggregates in a natural way.

Property 4. Aggregation preserves unified gross substitutes. If the correspondences $Q^{1}$ and $Q^{2}$ have the unified gross substitutes property, then so does $\lambda Q^{1}+\mu Q^{2}$ for $\lambda \geq 0$ and $\mu \geq 0$, where

$$
\left(\lambda \mathbf{Q}^{1}+\mu \mathbf{Q}^{2}\right)(p)=\left\{\lambda q^{1}+\mu q^{2}: q^{1} \in \mathbf{Q}^{1}(p), q^{2} \in \mathbf{Q}^{2}(p)\right\} .
$$

The proof, in Appendix A.1, is a straightforward bookkeeping exercise.

### 2.2 Nonreversingness

Our second condition is a requirement that the correspondence $Q$ cannot completely reverse the order of two points:

### 2.2.1 Definitions

Definition 2 (Nonreversing correspondence). The correspondence $\mathrm{Q}: P \rightrightarrows Q$ is nonreversing if

$$
\left(\begin{array}{c}
q \in \mathbb{Q}(p)  \tag{5}\\
q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right) \\
q \leq q^{\prime} \\
p \geq p^{\prime}
\end{array}\right) \Longrightarrow\binom{q \in \mathbb{Q}\left(p^{\prime}\right)}{q^{\prime} \in \mathbb{Q}(p)}
$$

Nonreversingness is a weak monotonicity requirement. It is implied by the (stronger but common) assumption that $\mathrm{Q}$ is increasing in the strong set order, as we would typically expect of a supply correspondence.

When $\mathrm{Q}$ is point-valued, the previous notion equivalently boils down to the following implication:

$$
\begin{equation*}
p \geq p^{\prime} \text { and } \mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right) \text { implies } \mathrm{q}(p)=\mathrm{q}\left(p^{\prime}\right) \tag{6}
\end{equation*}
$$

Nonreversingneess is weaker than strong nonreversingness, where the conclusion in (5) is replaced by the stronger statement that $p=p^{\prime}$ :

Definition 3 (Strongly nonreversing correspondence). The correspondence Q : $P \rightrightarrows Q$ is strongly nonreversing if

$$
\left(\begin{array}{c}
q \in \mathbb{Q}(p)  \tag{7}\\
q^{\prime} \in \mathbf{Q}\left(p^{\prime}\right) \\
q \leq q^{\prime} \\
p \geq p^{\prime}
\end{array}\right) \Longrightarrow p=p^{\prime}
$$

### 2.2.2 Properties

Some familiar properties of economic models imply the nonreversingness of the supply correspondence. The first three of the following properties immediately imply nonreversingness by ensuring that the antecedent of (5) can hold only if $q=q^{\prime}$, rendering the consequent immediate.

Property 5. Constant aggregate output implies nonreversingness. The correspondence $\mathrm{Q}$ satisfies constant aggregate output if there exists $k \in \mathbb{R}_{++}^{N}$ such that $\sum_{z=1}^{N} k_{z} q_{z}=0$ holds for all $p \in P$ and $q \in \mathbb{Q}(p)$.

It will often be natural to take $k$ to be the unit vector. One obvious circumstance in which aggregate output is constant is that in which the bundle of goods is augmented by an "outside good" whose quantity is the negative of the sum of the quantities of the original set of goods, as in Berry, Gandhi and Haile 55. Alternatively, the correspondence may be describing market shares in a model of competition, probabilities in a prediction problem, or budget shares in a model of consumption.

Property 6. Monotone total output implies nonreversingness. The correspondence $\mathbb{Q}$ satisfies monotone total output if for $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right), p \geq p^{\prime}$ implies $\sum_{z=1}^{N} q_{z} \geq \sum_{z=1}^{N} q_{z}^{\prime}$.

The monotone total output property plays an important role in the matching with contracts literature (Hatfield and Milgrom [18]) under the name of law of aggregate demand (or more properly here, law of aggregate supply). ${ }^{3}$

Property 7. Aggregate monotonicity implies nonreversingness. The correspondence $\mathbf{Q}$ satisfies aggregate monotonicity if for $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, both $p \geq p^{\prime}$ and $q<q^{\prime}$ cannot hold simultaneously.

The correspondence $\mathrm{Q}$ satisfies aggregate monotonicity if and only if for all $p \geq p^{\prime}, q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, there exists $k \in \mathbb{R}_{++}$with $\sum_{z=1}^{N} k_{z} q_{z} \geq \sum_{z=1}^{N} k_{z} q_{z}^{\prime}$.

Constant aggregate output implies monotone total output if we take $k$ to be the unit vector in the former; otherwise they are not nested. Aggregate monotonicity is clearly implied by either of constant aggregate output or monotone total output, but the converses fail. To illustrate, Appendix B. 2 provides an example of a function that is nonreversing and that satisfies aggregate and weighted monotonicity (defined next) but not monotone total output.

Our next property combines with unified gross substitutes to imply nonreversingness.

Property 8. Weighted monotonicity and unified gross substitutes imply nonreversingness. The correspondence $\mathrm{Q}$ satisfies weighted monotonicity if, given prices $p$ and $p^{\prime}$ in $P$ and allocations $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, there exists $k \in \mathbb{R}_{++}^{N}$ and allocations $q^{\wedge} \in \mathrm{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\vee} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$ such that

$$
\begin{equation*}
\sum_{z=1}^{N} k_{z} q_{z} \geq \sum_{z=1}^{N} k_{z} q_{z}^{\wedge} \quad \text { and } \quad \sum_{z=1}^{N} k_{z} q_{z}^{\vee} \geq \sum_{z=1}^{N} k_{z} q_{z}^{\prime} \tag{8}
\end{equation*}
$$

Notice that the vector $k$ is allowed to depend on the prices and allocations involved.[^1]

Weighted monotonicity and unified gross substitutes together imply that $\mathrm{Q}$ is nonreversing. To see this, consider $p$ and $p^{\prime}$ in $P$, and $q$ and $q^{\prime}$ in $Q$, such that $q \in \mathbb{Q}(p), q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right), q \leq q^{\prime}$ and $p \geq p^{\prime}$. By definition, there exists $k \in \mathbb{R}_{++}^{N}$, $q^{\wedge} \in \mathbb{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\vee} \in \mathbb{Q}\left(p \vee p^{\prime}\right)$, satisfying (8). Using $q \leq q^{\prime}$ and unified gross substitutes (1), one sees that $q_{z} \leq q_{z}^{\wedge}$ and $q_{z}^{\vee} \leq q_{z}^{\prime}$ for all $z$. By summation one obtains $\sum_{z=1}^{N} k_{z} q_{z} \leq \sum_{z=1}^{N} k_{z} q_{z}^{\wedge}$ and $\sum_{z=1}^{N} k_{z} q_{z}^{\vee} \leq \sum_{z=1}^{N} k_{z} q_{z}^{\prime}$, and thus (using (8)) all these inequalities are equalities. Hence $q=q^{\wedge}$, and $q^{\prime}=q^{\vee}$, which shows that $q \in \mathbb{Q}\left(p \wedge p^{\prime}\right)=\mathrm{Q}\left(p^{\prime}\right)$ and $q^{\prime} \in \mathrm{Q}\left(p \vee p^{\prime}\right)=\mathrm{Q}(p)$ as needed.

Property 9. Walras law and nonreversingness. Given a correspondence Q, consider the correspondence measured in monetary terms,

$$
\mathbf{Q}^{\$}(p)=\left\{\left(p_{z} q_{z}\right)_{z \in\{1, \ldots, N\}} \text { with } q \in \mathbb{Q}(p)\right\}
$$

introduced in Property 3. Then $\mathbf{Q}$ satisfies Walras law if for all $p$, and all $q \in \mathbf{Q}(p)$, we have $p^{\top} q=0$, which holds if and only if for all $p$ and all $\tilde{q} \in Q^{\$}(p)$, we have $1^{\top} \tilde{q}=0$. Hence, if $\mathrm{Q}$ satisfies Walras law, it follows that $Q^{\$}$ has constant aggregate output, and is therefore nonreversing.

The obvious example of a correspondence satisfying Walras law is the excess supply correspondence of a competitive economy.

Property 10. Inverse isotonicity implies nonreversingness. The inverse correspondence $\mathrm{Q}^{-1}$ is isotone in the strong set order if for $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$ with $q \leq q^{\prime}$, one has $q \in \mathbb{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\prime} \in \mathbb{Q}\left(p \vee p^{\prime}\right)$.

It follows immediately from the definitions that inverse isotonicity in the strong set order implies nonreversingness. Section 2.3.2 develops this connection further.

Property 11. Single crossing of the objective function implies nonreversing argmax, and conversely. Consider $\varphi: \mathbb{R}^{2 N} \rightarrow \mathbb{R}$ and assume $\varphi(p, q)$ has single crossing in $(p, q)$, that is if $0 \geq \varphi\left(p^{\prime}, q\right)-\varphi\left(p^{\prime}, q^{\prime}\right)$ and $\varphi(p, q)-\varphi\left(p, q^{\prime}\right) \geq 0$ holds for $p^{\prime} \geq p$ and $q^{\prime} \leq q$, then these two inequalities hold as equalities. Although stated differently, this definition is equivalent to the one introduced by Milgrom and Shannon [22]. Consider

$$
\begin{equation*}
\mathrm{Q}(p)=\arg \max _{q \in Q}\{\varphi(p, q)\} \tag{9}
\end{equation*}
$$

Then $\mathbf{Q}$ is nonreversing. Indeed, assume $q \in \mathbb{Q}(p), q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right), p \geq p^{\prime}$ and $q \leq q^{\prime}$. Then by definition of $\mathbf{Q}$, one has $\varphi(p, q) \geq \varphi\left(p, q^{\prime}\right)$ and $\varphi\left(p^{\prime}, q^{\prime}\right) \geq \varphi\left(p^{\prime}, q\right)$. By single crossing, equality holds in both inequalities, and therefore $q \in \mathbb{Q}\left(p^{\prime}\right)$ and $q^{\prime} \in \mathbb{Q}(p)$. Conversely, it is easily seen by taking $Q=\left\{q, q^{\prime}\right\}$ that if $\mathbf{Q}$ defined as in (9) above is nonreversing for all $Q$, then $\varphi(p, q)$ has single crossing in (p,q).

Our next property connects nonreversingness with the notion of a $P$-function. Such functions arise in a number of applications, and are the subject of a rich literature (e.g., Varga [35]).

Property 12. A P-function is nonreversing. An affine function $\mathrm{q}: \mathbb{R}^{N} \rightarrow \mathbb{R}^{N}$, written as $\mathrm{q}(p)=A p+b$ for an $N \times N$ matrix $A$ and an $N \times 1$ vector $b$, is a $P$ function if the matrix $A$ is a $P$ matrix (every principal minor is positive).

More and Rheinboldt [24, Definition 2.5, p. 49] generalize this notion. A function $\mathrm{q}: \mathbb{R}^{N} \rightarrow \mathbb{R}^{N}$ is a $P$-function if for every $p$ and $p^{\prime}$ with $p \neq p^{\prime}$, there exists $z \in\{1, \ldots, N\}$ such that $\left(p_{z}-p_{z}^{\prime}\right)\left(\mathrm{q}(p)_{z}-\mathrm{q}\left(p^{\prime}\right)_{z}\right)>0$. An implication of this condition is

$$
p \geq p^{\prime}, \mathbf{q}(p) \leq \mathrm{q}\left(p^{\prime}\right) \Longrightarrow p=p^{\prime}
$$

The natural application of this concept to correspondences $\mathrm{Q}: P \rightrightarrows Q$ is that

$$
\left[q \in \mathbb{Q}(p), q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right), q \leq q^{\prime}, p \geq p^{\prime}\right] \Longrightarrow p=p^{\prime}
$$

The $P$-correspondence property immediately implies nonreversingness.

Gale and Nikaido [12] show that a smooth P-function defined on a rectangle is injective [Theorem 4.2, p. 86] and and establish conditions under which it has an isotone inverse [Theorem 5, p. 87]. P-functions and their properties are discussed at length in Nikaido [25].

### 2.3 M0-correspondences and Inverse Isotonicity

### 2.3.1 M0-correspondences and Related Notions

We introduce the notion of an MO-correspondences:

Definition 4 (M0-correspondence). An M0-correspondence is a correspondence which satisfies unified gross substitutes and is nonreversing.

We view unified gross substitutes as the more substantive of the two conditions, with nonreversingness typically being innocuous.

We noted in Property 4 that unified gross substitutes is preserved by aggregation. The same is not the case once we add nonreversingness:

Remark 1 (M0-correspondences fail to aggregate). Appendix A.2 shows that the sum (as defined in Property (4) of two M0-correspondences $\mathrm{Q}$ and $\mathrm{Q}^{\prime}$ is not necessarily an M0-correspondence.

If $\mathrm{Q}$ is an $\mathrm{M} 0$-correspondence, then neither $\mathrm{Q}$ nor $\mathrm{Q}^{-1}$ need be point-valued. In the special case in which both are point-valued, we recover the existing notion of an $M$-function:

Definition 5 (M-function). An M-function is an MO-correspondence Q which is point-valued and has point-valued inverse $\mathrm{Q}^{-1}$.

We can then mix and match to define:

Definition 6 (M0-function). An M0-function is an M0-correspondence Q which is point-valued.

Definition 7 (M-correspondence). An M-correspondence is an M0-correspondence Q which has point-valued inverse $\mathrm{Q}^{-1}$.

We summarize with the following table:

|  | $\mathrm{Q}^{-1}$ is point-valued | $\mathrm{Q}^{-1}$ is set-valued |
| :--- | :---: | :---: |
| $\mathrm{Q}$ is point-valued | $\mathrm{Q}$ is an M-function | $\mathrm{Q}$ is an M0-function |
| $\mathrm{Q}$ is set-valued | $\mathrm{Q}$ is an M-correspondence | $\mathrm{Q}$ is an $\mathrm{M} 0$-correspondence |

This string of definitions is based on our characterization of M0-correspondences in terms of unified gross substitutes and nonreversingness. More and Rheinboldt [24, Definition 2.3, p. 48] (see also Ortega and Rheinboldt [27, Definition 13.5.7, p. 468]) define an M-function Q as one that (in our terms) satisfies weak gross substitutes and the condition that $\mathrm{Q}(p) \leq \mathrm{Q}\left(p^{\prime}\right)$ implies $p \leq p^{\prime}$. In Appendix B.3, we show that our definition and More and Rheinboldt's definition of an M-function are indeed equivalent.

To motivate the labels for these various notions, we recall that an M-matrix is a square matrix with every off-diagonal entry less or equal than zero and with every principal minor greater than zero. An M0-matrix is a square matrix with every off-diagonal entry less or equal than zero and with every principal minor greater than or equal to zero. 4 Then we have:

Property 13. M(M0)-matrices Induce M(M0)-functions. Let $Q$ be an $n \times n$ matrix and consider the function $\mathrm{Q}(p)=Q p$. Then $\mathrm{Q}$ is an $\mathrm{M}$-function if and only if $Q$ is a M-matrix, and $\mathrm{Q}$ is a $\mathrm{M} 0$-function if and only if $Q$ is an $\mathrm{M} 0$-matrix.

To confirm this statement, we first note that $Q p$ is obviously point valued. If $Q$ is an M-matrix, then it is nonsingular and hence has an inverse $Q^{-1}$, and in addition the nonsingular matrix $Q$ is the inverse of $Q^{-1}$, ensuring that $Q^{-1}$ is point valued. Next, if $Q$ is an M0-matrix, then $Q p$ is again point-valued but $Q$ may be singular, in which case $Q^{-1}$ can be set-valued.

Our terms thus exte notions of an M-function and M0-function to nonlinear functions and correspondences.

We can give examples for each of these categories. As Section 3.3 explains, Berry, Gandhi and Haile [5] offer sufficient conditions for a function to be an M-function, with one example (among others) being the estimation of the choice probabilities in a random-utility discrete choice model. Section 4 below presents examples of[^2]

M0-correspondences. The excess supply correspondence of a competitive exchange economy with strictly convex preferences is in general an M0-function. Each price vector gives rise to a unique excess supply, but the inverse may be set-valued-multiple price vectors may give rise to (for example) an excess supply of zero. Relaxing strict convexity to convexity but adding weak gross substitutes yields an M-correspondence. A price vector may give rise to multiple excess supplies, but the inverse is pointvalued - each excess supply comes from a unique price vector. The following properties present additional examples.

Property 14. The aggregate supply function associated with a logit model without price normalization is an M0-function. Consider a logit model where there are $n_{x}$ producers of type $x \in \mathcal{X}$ and each producer $x$ produces one unit of good $z$ chosen from a set of goods $\{1, \ldots, N\}$. Producer type $x$ gleans the random profit $\pi_{x z}\left(p_{z}\right)+\varepsilon_{z}$ from producing good $z$, where $\pi_{x z}($.$) is increasing and \left(\varepsilon_{z}\right)_{z \in\{1, \ldots, N\}}$ is an independent-and-identically-distributed random vector with Gumbel distribution. Then the aggregate supply function is a function $Q_{z}: \mathbb{R}^{N} \rightarrow \mathbb{R}^{N}$ given by

$$
\mathbf{Q}_{z}(p)=\sum_{x \in \mathcal{X}} n_{x} \frac{\exp \left(\pi_{x z}\left(p_{z}\right)\right)}{\sum_{z^{\prime}=1}^{N} \exp \left(\pi_{x z^{\prime}}\left(p z^{\prime}\right)\right)}
$$

and is an M0-function.

Property 15. The aggregate supply function associated with a logit model with price normalization is an M-function. In the model of Property 14, assume that the price $p_{N}$ of good $N$ is normalized to equal $\pi$. The aggregate production function restricted and corestricted to $\mathbb{R}^{N-1}$, denoted by $\mathrm{Q}_{z}: \mathbb{R}^{N-1} \rightarrow \mathbb{R}^{N-1}$ and given by

$$
\mathbf{Q}_{z}(p)=\sum_{x \in \mathcal{X}} n_{x} \frac{\exp \left(\pi_{x z}\left(p_{z}\right)\right)}{\exp \left(\pi_{x N}(\pi)\right)+\sum_{z^{\prime}=1}^{N} \exp \left(\pi_{x z^{\prime}}\left(p z^{\prime}\right)\right)}
$$

is an M-function.

### 2.3.2 Inverse Isotonicity Theorems

We introduce the following condition, which is slightly stronger than requiring that the inverse correspondence $\mathrm{Q}^{-1}$ is isotone in the strong set order (a.k.a. Veinott's order, Veinott [36]). 5

Definition 8 (Totally Isotone Inverse). A correspondence $\mathbf{Q}: P \rightrightarrows Q$ has totally isotone inverse if, whenever $q \in \mathrm{Q}(p)$ and $q^{\prime} \in \mathrm{Q}\left(p^{\prime}\right)$ are such that there exists $B \subseteq\{1, \ldots, N\}$ with $p_{z} \leq p_{z}^{\prime}$ for all $z \in B$ and $q_{z} \leq q_{z}^{\prime}$ for all $z \notin B$, we have

$$
\begin{equation*}
q \in \mathbb{Q}\left(p \wedge p^{\prime}\right) \text { and } q^{\prime} \in \mathbb{Q}\left(p \vee p^{\prime}\right) \tag{10}
\end{equation*}
$$[^3]

If we require 10 to hold only for the case $B=\emptyset$, then the inverse correspondence $\mathbf{Q}^{-1}$ is isotone in the strong set order, i.e, whenever $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbf{Q}\left(p^{\prime}\right)$ are such that $q_{z} \leq q_{z}^{\prime}$ for all $1 \leq z \leq N$, we have

$$
q \in \mathbb{Q}\left(p \wedge p^{\prime}\right) \text { and } q^{\prime} \in \mathbb{Q}\left(p \vee p^{\prime}\right)
$$

In this case we say simply that $\mathrm{Q}$ is inverse isotone, a weaker property obviously implied by totally isotone inverse. We can equivalently express the inverse isotonicity of $\mathrm{Q}$, or equivalently the isotonicity of $\mathrm{Q}^{-1}$ in the strong set order, as the requirement that whenever $p \in \mathbf{Q}^{-1}(q)$ and $p^{\prime} \in \mathbf{Q}^{-1}\left(q^{\prime}\right)$ where $q \leq q^{\prime}$, it follows that

$$
p \wedge p^{\prime} \in Q^{-1}(q) \text { and } p \vee p^{\prime} \in Q^{-1}\left(q^{\prime}\right)
$$

The following inverse isotonicity result is the building block for subsequent applications.

Theorem 1. Let $\mathrm{Q}: P \rightrightarrows Q$ satisfy unified gross substitutes. Then the following conditions are equivalent:

(i) $\mathrm{Q}$ is nonreversing (i.e., $\mathrm{Q}$ is a M0-correspondence), and

(ii) $\mathrm{Q}$ has totally isotone inverse.

Proof Assume (i) and consider $q \in \mathbb{Q}(p), q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, and $B \subseteq\{1, \ldots, N\}$ such that $p_{z} \leq p_{z}^{\prime}$ for all $z \in B$ and $q_{z} \leq q_{z}^{\prime}$ for all $z \notin B$. By unified gross substitutes, one has the existence of $q^{\wedge} \in \mathrm{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\vee} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$ such that

$$
\begin{aligned}
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z} \leq q_{z}^{\wedge} \\
& p_{z}>p_{z}^{\prime} \quad \Longrightarrow \quad q_{z}^{\prime} \leq q_{z}^{\wedge}
\end{aligned}
$$

We have $p_{z}>p_{z}^{\prime} \Longrightarrow z \notin B$, which implies $q_{z} \leq q_{z}^{\prime}$. Combining with the inequalities above, we see that $q_{z} \leq q_{z}^{\wedge}$ holds for any $1 \leq z \leq N$. But then $q \leq q^{\wedge}$ and $p \geq p \wedge p^{\prime}$, so by nonreversingness it follows that $q \in \mathbb{Q}\left(p \wedge p^{\prime}\right)$. A similar reasoning shows that $q^{\prime} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$. We have therefore shown statement (ii).

Conversely, we assume statement (ii) holds and show $\mathrm{Q}$ is nonreversing. Take $p \geq p^{\prime}$ and $q \leq q^{\prime}$ such that $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathrm{Q}\left(p^{\prime}\right)$. Letting $B=\emptyset$, because $\mathrm{Q}$ has totally isotone inverse, we have that $q \in \mathbb{Q}\left(p \wedge p^{\prime}\right)$, which is equivalent to $q \in \mathbb{Q}\left(p^{\prime}\right)$, and $q^{\prime} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$, which is equivalent to $q^{\prime} \in \mathrm{Q}(p)$, which shows (i).

Appendix 14 generalizes this result to partial inverse correspondences. It is an immediate implication that:

Corollary 1. Let $\mathrm{Q}$ be an M0-correspondence. Then the set of prices $\mathrm{Q}^{-1}(q)$ associated with an allocation $q$ is a sublattice of $P$.

Proof Take $p \in \mathbf{Q}^{-1}(q)$ and $p^{\prime} \in \mathbf{Q}^{-1}(q)$. Then $q \leq q$ yields $q \in \mathbf{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\prime} \in \mathrm{Q}\left(p \vee p^{\prime}\right)$.

The inverse image $\mathrm{Q}^{-1}(\tilde{q})$ will often describe an equilibrium. For example, $\mathbf{Q}$ may be the aggregate supply function of a competitive economy and $\tilde{q}$ may be the negative if the aggregate endowment, so that $\mathrm{Q}^{-1}(\tilde{q})$ identifies the set of competitive equilibrium prices. Theorem 1 thus gives us monotone comparative statics results for equilibrium problems, in our example describing how competitive equilibrium prices vary in the endowment.

One can can show that under uniform gross substitutes, $\mathrm{Q}$ is a $\mathrm{M}$-correspondence if and only if it is totally nonreversing.

Theorem 2. Let $\mathrm{Q}: P \rightrightarrows Q$ satisfy unified gross substitutes. Then the following three conditions are equivalent:

(i) $\mathrm{Q}$ is an $M$-correspondence;

(ii) $\mathrm{Q}^{-1}$ is point-valued and isotone where not empty, i.e. $q \in \mathrm{Q}(p), q^{\prime} \in \mathrm{Q}\left(p^{\prime}\right)$ and $q \leq q^{\prime}$ imply $p \leq p^{\prime}$;

(iii) Q is strongly nonreversing.

Proof (i) implies (ii): Assume $\mathrm{Q}$ is a M-correspondence and assume $q \in \mathbb{Q}(p)$, $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$ and $q \leq q^{\prime}$. By Theorem 1, we have $q \in \mathbb{Q}\left(p \wedge p^{\prime}\right)$ and $q^{\prime} \in \mathbb{Q}\left(p \vee p^{\prime}\right)$. Because $\mathbf{Q}$ is injective, it follows that $p=p \wedge p^{\prime}$ and thus $p \leq p^{\prime}$.

(ii) implies (iii): Assume $\mathrm{Q}$ is inverse isotone and assume $\mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right)$ and $p \geq p^{\prime}$. By inverse isotonicity one has $p \leq p^{\prime}$, and thus $p=p^{\prime}$.

(iii) implies (i): Assume $\mathrm{Q}$ is strong nonreversing. Then it is nonreversing and thus $\mathrm{Q}$ is a M0-correspondence. Assume $q \in \mathbb{Q}(p)$ and $q \in \mathbb{Q}\left(p^{\prime}\right)$. By unified gross substitutes, we have $q^{\vee} \in \mathbb{Q}\left(p \vee p^{\prime}\right)$ with $q^{\vee} \leq q$. Because $p \vee p^{\prime} \geq p, p^{\prime}$, strong nonreversingness gives $p=p \vee p^{\prime}=p^{\prime}$. Hence, $p=p^{\prime}$ and thus $\mathrm{q}$ is injective.

## 3 Connections with Existing Theories

### 3.1 Kelso and Crawford's Gross Substitutes

We can connect unified gross substitutes to Kelso and Crawford's well-known definition [20, p. 1486] of substitutes. Translating their definition to our setting of supply correspondences, the correspondence $\mathrm{Q}$ has the Kelso-Crawford substitutes property if, given two price vectors $p$ and $p^{\prime}$ with $p^{\prime} \leq p$, for any $q \in \mathbb{Q}(p)$ there exists $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$ such that $p_{z}=p_{z}^{\prime} \Longrightarrow q_{z}^{\prime} \geq q_{z}$.

Property 16. Unified gross substitutes implies Kelso-Crawford substitutes. It follows immediately from (1) and the definition of Kelso-Crawford substitutes that unified gross substitutes implies the Kelso and Crawford substitutes property.

Appendix A. 3 shows that Kelso and Crawford's definition does not imply unified gross substitutes.

We refer to our notion as unified gross substitutes in order to emphasize the distinction between Kelso and Crawford gross substitutes and our notion, namely that the latter "unifies" the conditions (1) and (2) by requiring them to be satisfied by common $q^{\wedge}$ and $q^{\vee}$. Kelso and Crawford's condition implies there are allocations $q^{\wedge}$ and $q^{\vee}$ satisfying (1) and also allocations $q^{\wedge}$ and $q^{\vee}$ satisfying (2), but allows these allocations to differ.

### 3.2 Polterovich and Spivak's Gross Substitutes

Polterovich and Spivak [29, Definition 1, p. 118] propose a notion of gross substitutes for correspondences. (See Howitt [19] for an intermediate notion.) In our notation and setting, the correspondence $\mathrm{Q}(p)$ satisfies their notion of gross substitutability if, for any price vectors $p \leq p^{\prime}$ and any $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathbb{Q}\left(p^{\prime}\right)$, it is not the case that

$$
q_{z}^{\prime}>q_{z} \quad \forall z \text { s.t. } p_{z}=p_{z}^{\prime}
$$

Polterovich and Spivak's notion thus stipulates that if the prices of some set of goods increase while others remain constant, it cannot be the case that every one of the quantities associated with the latter set strictly increases.

Polterovich and Spivak [29, Lemma 1, p. 123] show that if the correspondence $\mathrm{Q}$ maps from the interior of $\mathbb{R}_{+}^{N}$ into $\mathbb{R}^{N}$, is convex valued and closed valued, and maps compact sets into nonempty bounded sets, then their gross substitutability condition implies (1)-(2). Appendix A.4 shows that our requirement that $P$ be a sublattice of $\mathbb{R}^{N}$ does not suffice for this result, and that in general neither notion implies the other. Polterovich and Spivak [29, p. 119] note that their definition of gross substitutes for correspondences is not preserved under the addition of correspondences, unlike unified gross substitutes.

### 3.3 Berry, Gandhi and Haile's Connected Strict Substitutes

Berry, Gandhi and Haile [5], abbreviated as BGH, examine functions q: $P \rightarrow Q$. They make the follwoing assumptions, which allow them to show that an inverse function is isotone and point-valued:

BGH, Implicit Assumption 0: q is point-valued.

BGH, Assumption 1: q is defined on a Cartesian product of sets.

BGH, Assumption 2.a: q has the gross substitutes property.

BGH, Assumption 2.b: The function defined by

$$
\mathrm{q}_{0}(p):=-\sum_{z=1}^{N} \mathrm{q}_{z}(p)
$$

is weakly decreasing in each $p_{z}$ for $z \in\{1, \ldots, N\}$.

BGH, Assumption 3: For all $B \subseteq\{1, \ldots, N\}, p$ and $p^{\prime}$ such that $p_{z}=p_{z}^{\prime}$ for all $z \in B$ and $p_{z}>p_{z}^{\prime}$ for all $z \notin B$, there exists $\tilde{z} \in B \cup\{0\}$ such that $\mathrm{q}_{\tilde{z}}(p)<\mathrm{q}_{\tilde{z}}\left(p^{\prime}\right)$.

We find it useful to record Berry, Gandhi and Haile's restriction to demand functions as an implicit Assumption 0. Berry, Gandhi and Haile's Assumption 1, that q is defined on a Cartesian produce of Euclidean spaces [5, p. 2094], implies our Assumption 1 that $P$ is a sublattice of $\mathbb{R}^{N}$. Their second assumption [5, p. 2094] (in our notation, and translating from their framing in terms of demand functions to our framing in terms of supply functions) is split here into Assumptions by 2.a and 2.b. Lastly, their Assumption 3 [5, p. 2095] is a connected strict substitutes assumption which expresses that one cannot partition the set of goods into two set of products such that no good in the first set is a substitute for some good in the second set. We have stated this assumption in the equivalent form established in their Lemma 1.

Applying our Theorem 1 gives a variant of Berry, Gandhi and Haile's 5] Theorem 1 which operates under weaker assumptions (more precisely, without their Assumption 3) but delivers a weaker conclusion:6

Corollary 2. Under Berry, Gandhi and Haile's Assumptions 0, 1, 2.a, and 2.b, the function $\mathrm{q}$ is an MO-function and hence the inverse $\mathrm{q}^{-1}$ of $\mathrm{q}$ is isotone in the strong set order, that is $\mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right)$ implies $\mathrm{q}(p)=\mathrm{q}\left(p \wedge p^{\prime}\right)$ and $\mathrm{q}\left(p^{\prime}\right)=\mathrm{q}\left(p \vee p^{\prime}\right)$.

Proof Recall that Property 1 establishes that if the function q satisfies weak gross substitutes, which it does under Assumption 2.a, then it satisfies unified gross substitutes. Using Assumption 2.b and Property 6, we get that $\mathrm{q}$ is also nonreversing, and hence $\mathrm{q}$ is an M0-function.

Applying our Theorem 2 now gives an alternative route to Berry, Gandhi and Haile's Theorem [5] Theorem 1 and Corollary 1.

Corollary 3. Under Berry, Gandhi and Haile's Assumptions 0, 1, 2.a, 2.6 and 3, the function $\mathrm{q}$ is an $M$-function and hence is inverse isotone $\left(\mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right)\right.$ implies $p \leq p^{\prime}$ ) and $\mathrm{q}^{-1}$ is point-valued.

Proof We show that under the additional Assumption 3, the function $\mathrm{q}$ is in addition strongly nonreversing. Indeed, assume $\mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right)$ and $p \geq p^{\prime}$. By nonreversingness, one has $\mathrm{q}(p)=\mathrm{q}\left(p^{\prime}\right)$. Assume $p>p^{\prime}$. Let $B=\left\{z: p_{z}=p^{\prime}\right\} \neq\{1, \ldots, N\}$. By BGH Assumption 3, there exists $z \in B \cup\{0\}$ such that $\mathrm{q}_{z}(p)<\mathrm{q}_{z}\left(p^{\prime}\right)$, a contradiction. Hence $p=p^{\prime}$, giving strong nonreversingness. Theorem 2 then gives the result.[^4]

We can generalize Berry, Gandhi and Haile's result to correspondences.

BGH, Assumption 3': For all $B \subseteq\{1, \ldots, N\}, p$ and $p^{\prime}$ such that $p_{z}=p_{z}^{\prime}$ for all $z \in B$ and $p_{z}>p_{z}^{\prime}$ for all $z \notin B$, and all $q \in \mathbb{Q}(p)$ and $q^{\prime} \in \mathrm{Q}\left(p^{\prime}\right)$ with $q \leq q^{\prime}$, there exists $\tilde{z} \in B \cup\{0\}$ such that $q_{\tilde{z}}<q_{\tilde{z}}^{\prime}$.

Let $\tilde{Q}:\{1\} \times P \rightrightarrows \mathbb{R} \times Q$ be the correspondence, written $\tilde{q} \in \tilde{Q}(\tilde{p})$ constructed from $Q$ by letting $\tilde{p}=(1, p)$ and $\tilde{q}=\left(-\sum_{z=1}^{N} q_{z}, q\right)$. Then $\tilde{Q}$ by construction satisfies constant aggregate output and hence nonreversingingss. An argument analogous to the proof of Corollary 3 establishes that $\mathrm{Q}$ is strongly nonreversing. Theorem 2 then immediately gives:

Corollary 4. Let $\tilde{Q}$ satisfy unified gross substitutes. Then $\tilde{Q}$ is an $M$-function and hence is inverse isotone $\left(\mathrm{q}(p) \leq \mathrm{q}\left(p^{\prime}\right)\right.$ implies $p \leq p^{\prime}$ ) and and $\mathrm{Q}^{-1}$ is point-valued.

Appendix A.5 shows that if the correspondence $\tilde{Q}$ satisfies unified gross substitutes, then so does $Q$.

### 3.4 Topkis' Theorem

When the inverse $\mathrm{Q}^{-1}$ is itself the solution to a maximization problem, we may be able to obtain an inverse isotonicity result via monotone comparative static arguments familiar from Topkis [33, 34]. For example, we may be interested in the supply function of a competitive, multiproduct firm, given by

$$
\begin{equation*}
\mathbf{Q}(p)=\arg \max _{q \in \mathbb{R}_{+}^{N}}\left\{p^{\top} q-c(q)\right\}=\partial c^{*}(p) \tag{11}
\end{equation*}
$$

where $c$ is a convex cost function $c: \mathbb{R}_{+}^{N} \rightarrow \mathbb{R}, c^{*}(p)=\max _{q \in \mathbb{R}_{+}^{N}}\left\{p^{\top} q-c(q)\right\}$ is the indirect profit function, and $\partial c^{*}(p)$ is the subdifferential of $c^{*}$ at $\left.p\right\urcorner \square$

$$
\mathbf{Q}^{-1}(q)=\arg \max _{p \in \mathbb{R}_{+}^{N}}\left\{p^{\top} q-c^{*}(p)\right\}=\partial c(q)
$$

where $\partial c(q)$ is the subdifferential of $c$ at $q$.

We now have two routes to establishing the isotonicity in the strong set order of $\mathrm{Q}^{-1}$. Section 4.1 pursues an approach based on establishing an equivalence between the submodularity of the profit cost function $c^{*}$ and the supply correspondence $\mathrm{Q}=\partial c^{*}$ satisfying unified gross substitutes. Alternatively, we can note that the function $p^{\top} q-c^{*}(p)$ is supermodular in $p$ (given the submodularity of $c^{*}$ ) and exhibits increasing differences, and so $\mathrm{Q}^{-1}$ is increasing in the strong set order (Topkis [33, Theorem 6.1, p. 317]).[^5]

More generally, given a correspondence $\mathbf{Q}: P \rightrightarrows Q$, we can potentially exploit the existence of a function $g(p, q)$ such that the inverse correspondence $\mathrm{Q}^{-1}$ is the solution to the maximization problem

$$
\begin{equation*}
\mathbf{Q}^{-1}(q)=\arg \max _{p \in P} g(p, q) \tag{12}
\end{equation*}
$$

Topkis [33] assumes that $g$ is supermodular in $p$ and has increasing differences in $(p, q)$, which imply the following sufficient condition for his isotonicity result:

$$
\begin{equation*}
q \geq q^{\prime} \Longrightarrow g\left(p \vee p^{\prime}, q\right)-g\left(p^{\prime}, q\right) \geq g\left(p, q^{\prime}\right)-g\left(p \wedge p^{\prime}, q^{\prime}\right) \tag{13}
\end{equation*}
$$

Milgrom and Shannon's [22] weaker assumptions of quasi-supermodularity and single crossing similarly imply

$$
q \geq q^{\prime} \Longrightarrow\left\{\begin{array}{l}
g\left(p, q^{\prime}\right)-g\left(p \wedge p^{\prime}, q^{\prime}\right) \geq 0 \Longrightarrow g\left(p \vee p^{\prime}, q\right)-g\left(p^{\prime}, q\right) \geq 0  \tag{14}\\
g\left(p \vee p^{\prime}, q\right)-g\left(p^{\prime}, q\right) \leq 0 \Longrightarrow g\left(p, q^{\prime}\right)-g\left(p \wedge p^{\prime}, q^{\prime}\right) \leq 0
\end{array}\right.
$$

Both sets of assumptions lead to monotone comparative statics results. In Appendix A. 6 we give two examples showing that our (unified gross substitutes and nonreversingness) conditions for inverse isotonicity do not imply those of Topkis or Milgrom and Shannon, nor do the reverse implications hold. We thus have independent conditions for the case of optimization problems, while we can also view our results as extending the analysis beyond the purview of optimization problems.

## 4 Applications

### 4.1 Profit Maximization

In keeping with our interpretation of $Q$ as a supply correspondence, suppose a competitive multiproduct firm faces output price vector $p \in \mathbb{R}^{N}$ and convex cost function $c: \mathbb{R}^{N} \rightarrow \mathbb{R}$. Given a price $p$, the set of optimal production vectors $\mathrm{Q}(p) \subseteq \mathbb{R}^{N}$ is given by (11). The conjugate of the cost function $c$, denoted by $c^{*}(p)$, is the indirect profit function:

$$
c^{*}(p)=\max _{q \in \mathbb{R}^{N}}\left\{p^{T} q-c(q)\right\}
$$

Note that by Property 11, the arg max correspondence $\mathbf{Q}$ is nonreversing, and hence $\mathbf{Q}$ is a M0-correspondence if and only if it satisfies unified gross substitutes.

The following result, whose proof is given in Appendix A.7, relates unified gross substitutes to the submodularity of the indirect profit function. It offers a continuous counterpart to Ausubel and Milgrom's [3] Theorem 10:

Theorem 3. The following conditions are equivalent:

(i) the indirect profit function $c^{*}$ is submodular, and

(ii) the supply correspondence $\mathrm{Q}(p)=\partial c^{*}(p)$ satisfies unified gross substitutes, and

(iii) the supply correspondence $\mathrm{Q}(p)=\partial c^{*}(p)$ is an M0-correspondence.

Remark 2. We can relax the assumption of perfect competition and accommodate a more general revenue function. Consider a firm whose profit maximization problem is given by

$$
\begin{equation*}
c^{\pi}(p)=\max _{q \in \mathbb{R}^{N}}\left\{\sum_{z=1}^{N} \pi_{z}\left(p_{z}, q_{z}\right)-c(q)\right\} \tag{15}
\end{equation*}
$$

where $c: \mathbb{R}^{N} \rightarrow \mathbb{R}$ is an increasing and strictly convex cost function and each function $\pi_{z}: \mathbb{R}^{2} \rightarrow \mathbb{R}$ is a revenue function that is differentiable, increasing in $p_{z}$ and concave in $q_{z}$ and satisfies $\frac{\partial^{2} \pi_{z}\left(p_{z}, q_{z}\right)}{\partial p_{z} \partial q_{z}}>0$ and $\frac{\partial^{3} \pi_{z}\left(p_{z}, q_{z}\right)}{\partial p_{z} \partial q_{z}^{2}}>0$. The interpretation is that a firm chooses quantities $q_{1} \ldots, q_{N}$ to sell in each of $N$ markets. The total cost of production is given by $c(q)$. Revenue in each market $z$ is given by $\pi_{z}\left(p_{z}, q_{z}\right)$. Market $z$ may be perfectly competitive, in which case we can take $p_{z}$ to be the price in the market. More interestingly, market $z$ may be imperfectly competitive, in which case $p_{z}$ is a demand shifter, with higher values of $p_{z}$ indicating higher revenue and higher marginal revenue for each given quantity.

Appendix B. 4 shows that the supply correspondence $Q$ emanating from (15) satisfies unified gross substitutes if and only if the indirect profit function $c^{\pi}$ is submodular, providing an extension of Theorem 3 to revenue functions $\pi_{z}\left(p_{z}, q_{z}\right)$ that are more general than $\pi_{z}\left(p_{z}, q_{z}\right)=p_{z} q_{z}$.

Remark 3. Gul and Stacchetti 16, Theoren 1, p, 99] show that in their context of utility maximization with indivisible goods (so that an individual consumes either zero or one unit of each good and a consumption bundle is a list of which goods are consumed), gross substitutes is equivalent to each of two additional properties that they introduce, namely no complementarities and single improvement. Their nocomplementarities condition stipulates that if $X$ and $Y$ are both optimal consumption bundles and $Z \subset X \backslash Y$, then one can also obtain an optimal consumption bundle by removing the goods $Z$ from the set $X$ and adding some elements of $Y$. For the case of divisible goods, Galichon et al. 14] offer the following continuous counterpart, which requires the optimality of only one of the two bundles $8^{8}$

Definition 9 (No Complementarities). The correspondence $\mathrm{Q}(p)$ satisfies the no complementarities property if whenever $q \in Q(p)$ and $q^{\prime} \neq q$, then for each $\delta_{1}$ such that $0 \leq \delta_{1} \leq\left(q^{\prime}-q\right)^{+}$, there exists $\delta_{2}$ such that $0 \leq \delta_{2} \leq\left(q-q^{\prime}\right)^{+}$such that

$$
p^{\top}\left(q^{\prime}+\delta_{2}-\delta_{1}\right)-c\left(q^{\prime}+\delta_{2}-\delta_{1}\right) \geq p^{\top} q^{\prime}-c\left(q^{\prime}\right)
$$[^6]

When applied to the special case in which $q, q^{\prime} \in Q(p)$, the result is the functional equivalent of Gul and Stacchetti's condition, in that we begin with the optimal allocations $q$ and $q^{\prime}$, and then construct a new optimal allocation by adding to $q^{\prime}$ in some dimensions $z$ in which $q_{z}^{\prime}<q_{z}$ and subtracting from $q^{\prime}$ in some dimensions $z$ in which $q_{z}^{\prime}>q_{z}$. Galichon et al. [14] prove the following. $9^{9}$

Theorem 4. Assume $c(q)$ is convex. The correspondence $\mathrm{Q}$ defined in (11) satisfies unified gross substitutes if and only if it satisfies no complementarities.

### 4.2 Structures of Solutions

It is a familiar result that if each agent's (point-valued) demand function in an exchange economy satisfies strict gross substitutes, then that economy has a unique equilibrium (e.g., Arrow and Hahn [2, Chapter 9]). In more general settings that allow for set-valued demand and supply functions, the proximate notion of a unique equilibrium is that the set of equilibrium prices forms a lattice. Since Walras law implies nonreversingness (Property 9), we have the result that if the excess supply correspondence $\mathrm{Q}$ satisfies unified gross substitutes, then the set of equilibrium prices is a sublattice. Polterovich and Spivak [29, Corollary 1, p. 125] similarly show that the set of equilibrium prices in an exchange economy satisfying their gross substitutes condition is a lattice. Gul and Stacchetti [16, Corollary 1, p. 105] have a similar result for economies with indivisible goods.

In the point-valued case, the notion of subsolutions (a price vector $p$ such that $Q(p) \leq 0$ (or any other exogenously-specified value) and supersolutions (a price vector $p$ such that $Q(p) \geq 0$ ) play an important role. One can show in particular that if $Q$ is continuous and satisfies weak gross substitutes, then any subsolution $p$ that is not a solution, is such that there exists another subsolution $p^{\prime}$ such that $p<p^{\prime}$. As a result, if an iterative method produces a sequence of subsolutions $p_{k}$ that increases "enough," in the sense that the set of subsolutions that dominate $p_{k}$ shrinks, one may show that it converges to a solution. As our larger goal is to provide iterative methods for correspondences, we investigate set-valued extensions of these notions. Appendix B. 6 reports first steps in this broader research agenda.

### 4.3 An Equilibrium Flow Problem

Network. Consider a network $(\mathcal{Z}, \mathcal{A})$ where $\mathcal{Z}$ is a finite set of nodes and $\mathcal{A} \subseteq \mathcal{Z} \times \mathcal{Z}$ is the set of directed arcs. If $x y \in \mathcal{A}$, we say that $x y$ is the arc from $x \in \mathcal{Z}$ to $y \in \mathcal{Z}$,[^7]and we say that $x$ is the starting point of the arc, while $y$ is its end point. We assume that there is no arc in $\mathcal{A}$ whose starting point coincides with the end point. We describe the network with an $|\mathcal{A}| \times|\mathcal{Z}|$ arc-node incidence matrix matrix $\nabla$, defined by letting, for $x y \in \mathcal{A}$ and $z \in Z$

$$
\nabla_{x y, z}=\mathbf{1}_{\{z=y\}}-\mathbf{1}_{\{z=x\}}
$$

We thus have $\nabla_{x y, z}=1$ if $x y$ is an arc ending at $z$, and $\nabla_{x y, z}=-1$ if $x y$ is an arc beginning at $z$. Otherwise $\nabla_{x y, z}=0$.

Prices, connection functions. Let $p \in \mathbb{R}^{\mathcal{Z}}$ be a price vector, where we interpret $p_{z}$ as the price at node $z$. To have a concrete description, though we do not require this interpretation, one may consider a trader operating on node $x y$, who is able to purchase one unit of a commodity at node $x$, ship it along arc $x y$ toward node $y$, and resell it at node $y$. Given the resale price at node $y$, there is a certain threshold value of the price at node $x$ such that the trader is indifferent between engaging in the trade or not. This value is an increasing and continuous function of the price at node $y$, and can be expressed as $G_{x y}\left(p_{y}\right)$, where for each arc $x y \in \mathcal{A}$, the function $G_{x y}: \mathbb{R} \rightarrow \mathbb{R}$ is continuous and increasing, and called the connection function. ${ }^{10}$ Hence, if $p_{x}>G_{x y}\left(p_{y}\right)$, the purchase price at node $x$ is excessive, and the trader will not engage in the trade. On the contrary, if $p_{x}<G_{x y}\left(p_{y}\right)$, the purchase price is strictly below indifference level and positive rent can be made from the trade on the arc $x y$.

Our framework allows for any situation where the per-unit rent $\Pi_{x y}\left(p_{x}, p_{y}\right)$ of the trade on arc $x y$ is a continuous and possibly nonlinear function of $p_{x}$ and $p_{y}$, increasing in the resale price $p_{y}$ and decreasing in the purchase price $p_{x}$. In that case, $G_{x y}\left(p_{y}\right)$ is implicitly defined from $\Pi_{x y}$ by $G_{x y}\left(p_{y}\right)=\Pi_{x y}\left(., p_{y}\right)^{-1}(0)$, or equivalently, $\Pi_{x y}\left(G_{x y}\left(p_{y}\right), p_{y}\right)=0$

Example 1 (Additive case). A simple example of connection function assumes linear surplus for the trader, in which case the per-unit profit of the trader on arc $x y$ is $p_{y}-p_{x}-c_{x y}$ where $c_{x y}$ is the unit shipping cost from $x$ to $y$, and the indifference price at $\operatorname{arc} x$ is

$$
\begin{equation*}
G_{x y}\left(p_{y}\right)=p_{y}-c_{x y} \tag{16}
\end{equation*}
$$

We refer to this as the additive case.

Exiting flow, internal flow, mass balance. Let $q \in \mathbb{R}^{\mathcal{Z}}$ with $\sum_{z \in \mathcal{Z}} q_{z}=0$ attach a net flow to each node $z \in \mathcal{Z}$. If $q_{z}>0$, then the net quantity $\left|q_{z}\right|$ must flow into node $z$, while $q_{z}<0$ indicates that the net quantity $\left|q_{z}\right|$ must flow away from node $z$. Hence, we call $q$ the vector of exiting flows. We let $\mu \in \mathbb{R}_{+}^{\mathcal{A}}$ be the vector of internal flows along arcs, so that $\mu_{x y}$ is the flow through arc $x y$. The feasibility condition[^8]connecting these notions is that, for any $z \in \mathcal{Z}_{0}$, the total internal flow that arrives at $z$ minus the total internal flow that leaves $z$ equals the exiting flow at $z$, that is

$$
\sum_{x: x z \in \mathcal{A}} \mu_{x z}-\sum_{y: z y \in \mathcal{A}} \mu_{z y}=q_{z}
$$

which we call the mass balance equation, and which can be rewritten as

$$
\begin{equation*}
\nabla^{\top} \mu=q \tag{17}
\end{equation*}
$$

The interpretation of these flows will depend on the application of the equilibrium flow problem. The flows may represent quantities of commodities, volumes of traffic, assignments of objects, matches of individuals, and so on.

Equilibrium flow. The triple $(q, \mu, p) \in \mathbb{R}^{\mathcal{Z}} \times \mathbb{R}_{+}^{\mathcal{A}} \times \mathbb{R}^{\mathcal{Z}}$ is an equilibrium flow outcome if it satisfies three conditions. The first condition is the conservation of the flow given by the mass balance equation (17). The second condition is that there there is no positive rent on any arc, that is:

$$
p_{x} \geq G_{x y}\left(p_{y}\right) \quad \forall x y \in \mathcal{A}
$$

Our third condition is that arcs with negative rents carry no flow. Hence $\mu_{x y}>$ $0 \Longrightarrow p_{x} \leq G_{x y}\left(p_{y}\right)$, which combines with no-positive-rent requirement to yield $\mu_{x y}>0 \Longrightarrow p_{x}=G_{x y}(p)$. This is a complementary slackness condition, which can be written

$$
\sum_{x y \in \mathcal{A}} \mu_{x y}\left(p_{x}-G_{x y}\left(p_{y}\right)\right)=0
$$

The interpretation of these rent conditions will again depend on the application. In some cases, they will be the counterparts of zero-profit conditions in markets with entry, while in other cases they will play the role of incentive constraints.

In summary, we define:

Definition 10 (Equilibrium Flow Outcome). The triple $(q, \mu, p) \in \mathbb{R}^{\mathcal{Z}} \times \mathbb{R}_{+}^{\mathcal{A}} \times \mathbb{R}^{\mathcal{Z}}$ is an equilibrium flow outcome when the following conditions are met:

$$
\begin{aligned}
& \text { (i) } \nabla^{\top} \mu=q \\
& \text { (ii) } p_{x} \geq G_{x y}\left(p_{y}\right) \quad \forall x y \in \mathcal{A} \\
& \text { (iii) } \sum_{x y \in \mathcal{A}} \mu_{x y}\left(p_{x}-G_{x y}\left(p_{y}\right)\right)=0
\end{aligned}
$$

The first condition implies $\sum_{z \in \mathcal{Z}} q_{z}=0$. Notice that if $p$ satisfies condition (ii), then setting $q=0$ and $\mu=0$ ensures that the remaining conditions are satisfied. Indeed, if $(q, \mu, p)$ is a equilibrium flow outcome, then so is $(\lambda q, \lambda \mu, p)$ for any nonnegative scalar $\lambda$. Hence, there will either be no equilibrium flow outcome (if there is no $p$ satisfying condition (ii)) or there will be multiple equilibrium flows outcomes. Figure 2 presents a simple example of an equilibrium flow outcome.

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-23.jpg?height=461&width=770&top_left_y=293&top_left_x=683)

Figure 2: A simple example of equilibrium flow outcome. The three equilibrium conditions are satisfied as (i) the flow balance condition is satisfied at each node of the network (ii) there is no arbitrage on the network (iii) when there is a trade on an arc ( $\mu$ larger than zero on this arc), rent on this arc is nonnegative.

Example 1 (continued). Consider the network $(\mathcal{Z}, \mathcal{A})$, with the node-arc incidence matrix $\nabla$ and the additive rent function $G_{x y}\left(p_{y}\right)=p_{y}-c_{x y}$. In this additive case, the no-positive-rent condition rewrites as $p_{y}-p_{x} \leq c_{x y} \forall x y \in \mathcal{A}$. Let $q$ be a vector of exit flows. A triple $(q, \mu, p)$ is then an equilibrium flow outcome if

(i) $\quad \nabla^{T} \mu=q$

(ii) $\quad(\nabla p)_{a} \leq c_{a} \quad \forall a \in \mathcal{A}$

(iii) $\mu_{a}>0 \Longrightarrow(\nabla p)_{a}=c_{a} \quad \forall a \in \mathcal{A}$.

These conditions are exactly the optimality conditions associated with the linear programming problem which consists of minimizing $\mu^{\top} c$ subject to $\mu \geq 0$ and $\nabla^{\top} \mu=q$, which has dual $\max _{p}\left\{p^{\top} q: \nabla p \leq c\right\}$. This problem is well-known as the minimumcost flow problem (see e.g. Ahuja, Magnanti and Orlin [1). We can interpret the problem as one in which each source node $z$ contains an amount $-q_{z}$ of material (soil, in the original incarnation of the problem by Monge [23]), with the objective being to minimize the cost of transporting $q_{\tilde{z}}$ of this material to each destination $\tilde{z}$.

Example 2 (Nonadditive shortest path problem). Our setting allows for a natural extension of the well-known (additive) shortest path problem of Bellman [4]. The shortest path problem is an instance of the minimum-cost flow problem described in the example above, with a single origin or source node $o \in \mathcal{Z}$ and a single destination node $d \in \mathcal{Z}$, and $q_{z}=1_{\{z=d\}}-1_{\{z=o\}}$. In that case, the additive shortest path problem consists of looking for the path from $o$ to $d$ through the network with the smallest sum of arc costs.

We introduce our nonadditive extension by assuming that $p_{z}$ measures the time of passage at node $z$. Fixing $p_{d}$, which is the arrival time at the destination node $d$, one seeks the latest departure from the origin node $o$ consistent with arriving at the destination at no later than time $p_{d}$. The innovation allowed by the equilibrium flow
formulation is that we can allow the duration of the travel though arc $a$ to depend on the tine the arc is reached, which we can interpret as reflecting the state of traffic, or discrete times of passage of the means of transportation, and so on.

More formally, if a traveler on arc $x y$ aims at arriving at node $y$ at time $p_{y}$, then she must leave node $x$ no later than time $p_{x}=G_{x y}\left(p_{y}\right)$. To avoid time travel, we assume throughout that the various functions $G_{x y}: \mathbb{R} \rightarrow \mathbb{R}$ are increasing and satisfy $G_{x y}\left(p_{y}\right)<p_{y}$. As one can arrive at node $y$ at time $p_{y}$ by leaving no sooner than $p_{x}$, the equilibrium should satisfy the condition

$$
p_{x} \geq G_{x y}\left(p_{y}\right)
$$

At equilibrium, we have

$$
\mu_{x y}>0 \quad \Longrightarrow \quad p_{x}=G_{x y}\left(p_{y}\right)
$$

which ensures that if arc $x y$ is visited, the time of departure is consistent with the date of arrival.

Equilibrium flow correspondence. Given an equilibrium flow problem, let the equilibrium flow correspondence be the correspondence between prices $p$ and quantities $q$ that appear in an equilibrium flow. More formally:

Definition 11 (Equilibrium flow correspondence). The equilibrium flow correspondence is the correspondence $\mathbf{Q}: P \rightrightarrows \mathbb{R}^{\mathcal{Z}}$ defined by the fact that for $p \in P, \mathbb{Q}(p)$ is the set of $q \in \mathbb{R}^{\mathcal{Z}}$ such that there is a flow $\mu$ such that $(q, \mu, p)$ is an equilibrium flow outcome.

Appendix A. 8 proves:

Theorem 5. The equilibrium flow correspondence $\mathrm{Q}: \mathbb{R}^{\mathcal{Z}} \rightrightarrows \mathbb{R}^{\mathcal{Z}}$ satisfies unified gross substitutes.

It is immediate that the correspondence $\mathbf{Q}$ is nonreversing, since $q \in \mathbb{Q}(p)$ implies $\sum_{z \in \mathcal{Z}} q_{z}=0$. Hence it follows from Theorem 5 , the inverse isotonicity Theorem 1. and Corollary 1 that:

Corollary 5. The equilibrium flow correspondence $\mathrm{Q}(p)$ has totally isotone inverse and the set of equilibrium prices $\mathrm{Q}^{-1}$ is a sublattice of $\mathbb{R}^{\mathcal{Z}}$.

Galichon, Samuelson and Vernet [15] provide an existence result for the equilibrium flow problem, invoking a generalization of Hall's [17] conditions and an analogue of Rochet's [30] cyclical monotonicity condition.

### 4.4 Matching with (Fully or Imperfectly) Transferable Utility

To put our equilibrium flow formulation to work, consider the following one-to-one matching market with either fully or imperfectly transferable utility. Let $\mathcal{X}$ be a set of types of workers and $\mathcal{Y}$ a set of types of firms. There are $n_{x}$ workers of each type $x \in \mathcal{X}$, and $m_{y}$ firms of each type $y \in \mathcal{Y}$. Assume the total number of workers and firms is the same, or

$$
\sum_{x \in \mathcal{X}} n_{x}=\sum_{y \in \mathcal{Y}} m_{y}
$$

A match between worker type $x$ and firm type $y$ is characterized by a wage $w_{x y}$, in which case it gives rise to the utilities $\mathcal{U}_{x y}\left(w_{x y}\right)$ for the worker and $\mathcal{V}_{x y}\left(w_{x y}\right)$ for the firm.

A matching is a pair $(\mu, w)$, where $w$ is a vector specifying the wage $w_{x y}$ attached to each pair $x y \in \mathcal{X} \times \mathcal{Y}$ and $\mu$ is a vector identifying the mass $\mu_{x y}$ of matches between workers of type $x$ and firms of type $y$, for each $x y \in \mathcal{X} \times \mathcal{Y}$. The matching $(\mu, w)$ is stable if

$$
\begin{equation*}
\sum_{y \in \mathcal{Y}} \mu_{x y}=n_{x} \text { and } \sum_{x \in \mathcal{X}} \mu_{x y}=m_{y} \tag{18}
\end{equation*}
$$

and

$$
\begin{equation*}
\mu_{x y}>0 \text { implies } y \in \arg \max _{y \in \mathcal{Y}} \mathcal{U}_{x y}\left(w_{x y}\right) \text { and } x \in \arg \max _{x \in \mathcal{X}} \mathcal{V}_{x y}\left(w_{x y}\right) \tag{19}
\end{equation*}
$$

The first condition provides the feasibility condition that the number of each type of worker and firm that is matched equals the number present in the market, while the second provides the stability condition that no worker and firm can improve their utilities by matching with one another at an appropriate wage.

Now let $\mathrm{Q}$ be a correspondence identifying, for each specification of utilities, the configurations of workers and firms for which there exists a stable match exhibiting those utilities. More formally, let $\mathcal{Z}=\mathcal{X} \cup \mathcal{Y}$ and fix the utility vector $u: \mathcal{Z} \rightarrow \mathbb{R}$. Let $p \in \mathbb{R}^{\mathcal{Z}}$ be defined by $p_{z}=u_{z} \mathbf{1}_{\{z \in \mathcal{X}\}}-v_{z} \mathbf{1}_{\{z \in \mathcal{Y}\}}$, and $q_{z}=-n_{z} \mathbf{1}_{\{z \in \mathcal{X}\}}+m_{z} \mathbf{1}_{\{z \in \mathcal{Y}\}}{ }^{11}$ The stability problem then reformulates as

$$
q \in \mathbb{Q}(p)
$$

where $\mathbb{Q}(p)$ is the set of $q \in \mathbb{R}^{\mathcal{Z}}$ such that there exists $w \in \mathbb{R}^{\mathcal{X} \times \mathcal{Y}}$ and $\mu \in \mathbb{R}_{+}^{\mathcal{X}} \times \mathcal{Y}$ with $\sum_{y \in \mathcal{Y}} \mu_{x y}=-q_{x}$ for all $x \in \mathcal{X}$ and $\sum_{x \in \mathcal{X}} \mu_{x y}=q_{y}$ for all $y \in \mathcal{Y}$ and also 19)[^9]

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-26.jpg?height=365&width=537&top_left_y=300&top_left_x=794)

Figure 3: Network associated with a bipartite matching problem without singles.

is satisfied with $p_{z}=\max _{y \in \mathcal{Y}} \mathcal{U}_{x y}\left(w_{x y}\right)$ for $z \in \mathcal{X}$ and $-p_{z}=\max _{x \in \mathcal{X}} \mathcal{V}_{x y}\left(w_{x y}\right)$ for $z \in \mathcal{Y}$.

As a immediate result of the equilibrium flow formulation illustrated in Figure 3, it follows from Theorem 5 that:

Theorem 6. The correspondence that maps the vector of payoffs $p$ to the vector of populations $q$ is an M0-correspondence.

As noted in Galichon [13, Section 4.3.2], it may be paradoxical to see substituability arise in matching problems, given that the latter are meant to capture complementarity. However, the "change-of-sign" technique applied here, consisting of adding a negative sign in front of $v_{y}$ and in front of $n_{x}$, allows one to turn a problem with complementarity into a problem with substitutes. This exploits the bipartite nature of the problem. $\sqrt{12}$

Remark 4 (Equilibrium utilities constitute a lattice). Appendix A.9 generalizes this matching problem to accommodate unmatched agents, showing it is equivalent to an equilibrium flow problem. Theorem 5 again applies, and in each case Corollary 5 then implies that $\mathrm{Q}$ is an $\mathrm{M} 0$-correspondence. Hence, given a specification $q$ of buyers and sellers, the set of equilibrium utilities consistent with a stable match constitutes a lattice, providing an alternative route to the lattice result of Demange and Gale 99, Lemma 2 and Property 2].

Remark 5 (Comparative Statics). Once again, the inverse isotonicity of the equilibrium correspondence gives comparative static results. For example, as the number of firms increases, the set of equilibrium payoffs of firms decreases (in the strong set order) while set set of equilibrium payoffs of workers increases. An increase in the number of workers has the reverse effects. This result is proven in [10].

### 4.5 Matching Without Transfers

We now consider bipartite matching with non-transferable utility. We borrow the traditional language of "men" and "women" and heterosexual unions. Let $\mathcal{X}$ the set[^10]of men and $\mathcal{Y}$ be the set of women. Let $\mathcal{X}_{0}=\mathcal{X} \cup\{0\}$ be the set of marital options available to women, where 0 is being unmatched, and similarly let $\mathcal{Y}_{0}=\mathcal{Y} \cup\{0\}$ be the set of marital options available to men.

A match between a man $x \in \mathcal{X}$ and a woman $y \in \mathcal{Y}$ generates utility $\alpha_{x y}$ for the man and $\gamma_{x y}$ for the woman; if $x$ remains unmatched he receives $\alpha_{x 0}$, while if $y$ remains unmatched, she receives $\gamma_{0 y}$. As is common in the literature, we impose strict preferences:

Assumption 2. Strict preferences. $\alpha_{x y} \neq \alpha_{x y^{\prime}}$ for every $x \in \mathcal{X}$ and $y \neq y^{\prime} \in \mathcal{Y}_{0}$, and $\gamma_{x y} \neq \gamma_{x^{\prime} y}$ for every $y \in \mathcal{Y}$ and $x \neq x^{\prime} \in \mathcal{X}_{0}$.

Matchings, feasible matchings. A matching $\mu=\left(\mu_{x y}, \mu_{x 0}, \mu_{0 y}\right)$ is such that $\mu_{x y}=1$ if man $x$ and woman $y$ are matched and equals 0 otherwise, $\mu_{x 0}=1$ if man $x$ remains unmatched and 0 otherwise, and $\mu_{0 y}=1$ if woman $y$ remains unmatched, and 0 otherwise. A feasible matching is such that each individual has at most one partner, that is

$$
\sum_{y \in \mathcal{Y}_{0}} \mu_{x y}=1 \text { and } \sum_{x \in \mathcal{X}_{0}} \mu_{x y}=1
$$

Given a feasible matching $\mu$, one introduces

$$
\begin{equation*}
u_{x}^{\mu}=\sum_{y \in \mathcal{Y}_{0}} \mu_{x y} \alpha_{x y} \text { and } v_{y}^{\mu}=\sum_{x \in \mathcal{X}_{0}} \mu_{x y} \gamma_{x y} \tag{20}
\end{equation*}
$$

which are the utilities obtained by each individual under this matching.

Stable matchings. A stable matching is a feasible matching such that there is no pair $x y \in \mathcal{X} \times \mathcal{Y}$ for which $\alpha_{x y}>u_{x}^{\mu}$ and $\gamma_{x y}>v_{y}^{\mu}$ and such that $u_{x} \geq \alpha_{x 0}$ for all $x \in \mathcal{X}$ and $v_{y} \geq \gamma_{0 y}$ for all $y \in \mathcal{Y}$.

Define $Q: \mathbb{R}^{\mathcal{Y}} \rightarrow \mathbb{Z}^{\mathcal{Y}}$ by

$$
\mathbf{Q}_{y}(v):=1-\sum_{x \in \mathcal{X}} \mathbf{1}_{\left\{y \in \arg \max _{y \in \mathcal{Y}}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}, \alpha_{x 0}\right\}\right\}}-\mathbf{1}_{\left\{\gamma_{0 y} \geq v_{y}\right\}}
$$

which can be interpreted as the "excess supply" of type $y$, namely the "supply" of type $y$ (which is one) when this agent is in a relation that secures him a utility $v_{y}$, minus the the number of agents $x \in \mathcal{X}_{0}$ on the other side of the market who are willing to match with type $y$ (given $y$ 's utility requirement $v_{y}$ ). The following theorem (with proof in Appendix A.10 expresses stable matchings in terms of the function Q.

Theorem 7. Let assumption 2 hold. Then:

(i) If $\mu$ is a stable matching, then $\mathrm{Q}\left(v^{\mu}\right)=0$, with $v^{\mu}$ defined in 20.

(ii) Conversely, if $\mathrm{Q}(v)=0$, then define

$$
\begin{aligned}
& \mu_{x y}=\mathbf{1}_{\left\{y \in \arg \max _{y \in \mathcal{Y}}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}, \alpha_{x 0}\right\}\right\}} \\
& \left.\mu_{x 0}=\mathbf{1}_{\left\{0 \in \arg \max _{y \in \mathcal{Y}}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}, \alpha_{x 0}\right\}\right\}}\right\} \\
& \mu_{0 y}=\mathbf{1}_{\left\{\gamma_{0 y} \geq v_{y}\right\}},
\end{aligned}
$$

and we have that $\mu=\left(\mu_{x y}, \mu_{x 0}, \mu_{0 y}\right)$ is a stable matching.

This result is useful because we can show that $\mathrm{Q}$ is an $\mathrm{M} 0$-correspondence. Appendix A. 11 proves the following result.

Theorem 8. The map Q defined above defines a (point-valued) M0-correspondence.

This gives us an alternative route to the lattice structure of stable matchings.

### 4.6 Hedonic Pricing

The simplest models of a competitive economy assume that each of a finite number of goods is perfectly divisible and perfectly homogeneous. The hedonic pricing model, introduced by Rosen [32] and developed by Ekeland, Heckman and Nesheim [11]) and Chiappori, McCann and Nesheim [8] (among others), examines the opposite extreme, examining an economy filled with indivisible, idiosyncratic goods. To reduce the dimensionality of the prices in the latter case, one typically assumes the goods can be described by the extent to which they exhibit certain characteristics, with prices determined by these characteristics, thus giving rise to the term hedonic pricing.

Chiappori, McCann and Nesheim [8] show the the hedonic pricing problem with quasilinear utilities is equivalent to a matching problem with transferable utility, which is in turn equivalent to an optimal transport problem. They then draw on familiar results to establish that the optimal transport problem has an equilibrium, and hence so do the the associated matching and hedonic pricing problems.

We examine the hedonic pricing problem without assuming that utilities are quasilinear. Chiappori, McCann and Nesheim [8] invoke a twist condition to establish the uniqueness for equilibrium for the quasilinear case. Our counterpart of this result is to establish that for any equilibrium allocation, the set of utilities and prices supporting this equilibrium allocation is a lattice. We avoid a host of technical difficulties by working with finite sets of agents and goods.

Consumers and producers. The basic elements of the model are a set $\mathcal{X}$ of types of producers and a set $\mathcal{Y}$ of types of consumers. There are $n_{x}$ producers of each type $x \in \mathcal{X}$ and $m_{y}$ consumers of each type $y \in \mathcal{Y}$. We do not require that the total number of producers $\sum_{x \in \mathcal{X}} n_{x}$ equal the total number of consumers $\sum_{y \in \mathcal{Y}} m_{y}$.

Qualities. There is a finite set $\mathcal{W}$ of qualities, also sometimes referred to as contracts or characteristics. Each producer must choose to produce one of the qualities in $\mathcal{W}$, or to remain inactive. Each consumer must choose to consume one quality in $\mathcal{W}$ or remain inactive. We can interpret the set $\mathcal{W}$ as the set of possible (vectors of) characteristics of goods that determine prices.

Hedonic prices. Let $p: \mathcal{W} \rightarrow \mathbb{R}$ be a price vector assigning prices to qualities, with $p_{w}$ denoting the price of quality $w$. A producer of type $x$ who produces a quality $w$ that bears price $p_{w}$ earns the profit $\pi_{x w}\left(p_{w}\right)$. A consumer of type $y$ who consumes a quality $w$ bearing price $p_{w}$ reaps surplus $s_{y w}\left(p_{w}\right)$.

Indirect utilities. Given the price function $p$, a producer of type $x$ solves

$$
\max _{w \in \mathcal{W}}\left\{\pi_{x w}\left(p_{w}\right), 0\right\}=: u_{x}(p)
$$

and a consumer solves of type $y$ solves

$$
\max _{w \in \mathcal{W}}\left\{s_{y w}\left(p_{w}\right), 0\right\}=: v_{y}(p)
$$

Supply and demand allocations. Introduce $\mu_{x w}$ as the number of producers of type $x$ producing quality $w$, and $\mu_{w y}$ as the number of consumers of type $y$ consuming quality $w$. Complete this notation by introducing $\mu_{x 0}$ and $\mu_{0 y}$ as respectively the number of consumers of type $x$ and producers of type $y$ opting out. Necessarily if $\mu_{x w}>0$, it must hold that $\pi_{x w}\left(p_{w}\right)=u_{x}(p)$, that is, $w$ is produced by $x$ only if producing $w$ is optimal for $x$. Similar considerations apply for the demand allocation.

Hedonic pricing equilibrium. Given the specifications $\left\{n_{x}\right\}_{x \in \mathcal{X}}$ and $\left\{n_{y}\right\}_{y \in \mathcal{Y}}$ of producers and consumers, as well as the functions $\pi: \mathcal{X} \times \mathcal{W} \times \mathbb{R} \rightarrow \mathbb{R}$ and $s: \mathcal{Y} \times \mathcal{W} \times \mathbb{R} \rightarrow \mathbb{R}$, an equilibrium determines the price function $p$ and the specification of which good (if any) is produced by each producer and which good (if any) is consumed by each consumer. In the process, the equilibrium determines the payoff $u_{x}$ of each producer $x$ and $v_{y}$ of each consumer $y$, as well as the quantity $q_{w}$ of each quality $w$ produced.

Definition 12. A price vector $p$ and allocation $\mu$ are $a$ hedonic pricing equilibrium if the attendant utilities of producers and consumers $u_{x}$ and $v_{y}$, the prices of the qualities $p_{w}$, the numbers of producers and consumers $n_{x}$ and $m_{y}$, the excess supply of qualities $q_{w}$, the production flows $\mu_{x w}$, and the consumption flows $\mu_{w y}$ are related by the following relations:

(i) supply and demand allocations are feasible:

$$
\begin{equation*}
\sum_{w \in \mathcal{W}} \mu_{x w}+\mu_{x 0}=n_{x} \text { and } \sum_{w \in \mathcal{W}} \mu_{w y}+\mu_{0 y}=m_{y} \tag{21}
\end{equation*}
$$

(ii) markets balance holds:

$$
\begin{equation*}
q_{w}=\sum_{x \in \mathcal{X}} \mu_{x w}-\sum_{y \in \mathcal{Y}} \mu_{w y} \tag{22}
\end{equation*}
$$

(iii) rents are nonpositive and agents maximize:

$$
\left\{\begin{array}{lll}
u_{x} \geq \pi_{x w}\left(p_{w}\right) & \text { with equality if } & \mu_{x w}>0  \tag{23}\\
v_{y} \geq 0 & \text { with equality if } & \mu_{0 y}>0 \\
v_{y} \geq s_{y w}\left(p_{w}\right) & \text { with equality if } & \mu_{w y}>0 \\
u_{x} \geq 0 & \text { with equality if } & \mu_{x 0}>0
\end{array}\right.
$$

It is shown in Appendix A. 12 that:

Theorem 9. The correspondence that associates the vector $(u, p,-v)$ to the set of vectors $(-n, q, m)$ such that equations (21), (22) and (23) are satisfied for some allocation $\mu \geq 0$ is an MO-correspondence.

The proof of this result is based on a reformulation as an equilibrium flow problem, and the application of Theorem 5. This equilibrium therefore exhibits the lattice structure established in Corollary 1, and we once again obtain comparative static results.. We can again turn to Galichon, Samuelson and Vernet [15] for an existence result.

## 5 Conclusion

The concept of weak gross substitutes plays a prominent role in economic theory. We view the concept of unified gross substitutes as the natural generalization of weak gross substitutes to correspondences. It connects to the literature in multiple points, generalizing some results and unifying others.

The concept of unified gross substitutes allows one to derive the inverse isotonicity and lattice-valued-inverse properties of general correspondences, which in turn gives rise to comparative static results. This provides a tool that should be useful in two directions. First, it should be useful in extending familiar results developed under the assumption of quasilinearity to more general settings. Second, it should allow research to address a broader class of problems. In particular, there is great potential for formulating a variety of problems as special cases of the equilibrium flow problem, allowing immediate application of the implications of unified gross substitutes.

## A Appendix

## A. 1 Aggregation Preserves Unified Gross Substitutes

We prove one of the four implications in the definition of unified gross substitutes, noting that the others follow along similar lines. Fix $p$ and $p^{\prime}$ and let

$$
\begin{aligned}
& q=\lambda q^{1}+\mu q^{2}, \quad q^{1} \in \mathbb{Q}^{1}(p), \quad q^{2} \in \mathbb{Q}^{2}(p) \\
& q^{\prime}=\lambda q^{\prime 1}+\mu q^{\prime 2} \quad q^{\prime 1} \in \mathbb{Q}^{1}\left(p^{\prime}\right), \quad q^{\prime 2} \in \mathbb{Q}^{2}\left(p^{\prime}\right)
\end{aligned}
$$

Because $\mathbb{Q}^{1}$ and $\mathbf{Q}^{2}$ satisfy unified gross substitutes, there exist $q^{\vee 1} \in \mathbb{Q}^{1}\left(p \vee p^{\prime}\right)$ and $q^{\vee 2} \in \mathrm{Q}^{2}\left(p \vee p^{\prime}\right)$ with

$$
\begin{aligned}
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z}^{\vee 1} \leq q_{z}^{\prime 1} \\
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z}^{\vee 2} \leq q_{z}^{\prime 2}
\end{aligned}
$$

But then we have

$$
p_{z} \leq p_{z}^{\prime} \Longrightarrow \lambda q_{z}^{\vee 1}+\mu q_{z}^{\vee 2} \leq \lambda q_{z}^{\prime 1}+\mu q_{z}^{\prime 2}
$$

giving the condition for unified gross substitutes.

## A. 2 The Sum of Two M0-correspondences is Not Always an M0-correspondence

Let $\mathrm{Q}(p)=\{M p\}$ and $\mathrm{Q}^{\prime}(p)=\left\{M^{\top} p\right\}$ be two point-valued correspondences respectively associated with matrices $M$ and $M^{\top}$, where

$$
M=\left(\begin{array}{rr}
5 & -1 \\
-4 & 1
\end{array}\right)
$$

Because $M$ and $M^{\top}$ have positive entries on the diagonal and negative entries off the diagonal, the functions $\mathrm{Q}$ and $\mathrm{Q}^{\prime}$ both satisfy weak gross substitutes and hence unified gross substitutes (cf. Property 1). We have

$$
M^{-1}=\left(\begin{array}{ll}
1 & 1 \\
4 & 5
\end{array}\right)
$$

The inverses of $M$ and $M^{\prime}$ are both composed of positive entries, so $\mathrm{Q}$ and $\mathrm{Q}^{\prime}$ are both inverse isotone and hence nonreversing (Property 10) and hence are M0-correspondences. However,

$$
\left(M+M^{\top}\right)^{-1}=\frac{1}{10}\left(\begin{array}{cr}
-4 & -10 \\
-10 & 20
\end{array}\right)
$$

is not entrywise positive. Hence, the inverse of $Q+Q^{\prime}$ is not isotone and so $Q+Q^{\prime}$ is not an M0-correspondence (Theorem 1). Unified gross substitutes is satisfied (see Property (4) but $\mathrm{Q}+\mathrm{Q}^{\prime}$ is not nonreversing.

## A. 3 Kelso and Crawford's Substitutes Does Not Imply Unified Gross Substitutes

We show that unified gross substitutes is strictly stronger than Kelso and Crawford's notion of gross substitutes.

Let $N=4$ and consider the price vectors

$$
\begin{aligned}
p & =(1,1,2,2) & p \vee p^{\prime} & =(2,2,2,2) \\
p \wedge p^{\prime} & =(1,1,1,1) & p^{\prime} & =(2,2,1,1)
\end{aligned}
$$

Let the supply correspondence be

$$
\begin{aligned}
\mathrm{Q}(p) & =\{(1,0,1,1),(0,1,1,0)\} & \mathrm{Q}\left(p \vee p^{\prime}\right) & =\{(1,1,1,0),(0,1,1,1)\} \\
\mathrm{Q}\left(p \wedge p^{\prime}\right) & =\{(1,0,0,0),(0,0,0,1)\} & \mathrm{Q}\left(p^{\prime}\right) & =\{(1,1,0,1),(0,1,1,0)\}
\end{aligned}
$$

Then Kelso and Crawford's condition holds, but unified gross substitutes fails. The difficulty is that unified gross substitutes requires the allocations $q^{\vee}$ and $q^{\wedge}$ that appear in the two parts of Definition 1 to be identical, while Kelso and Crawford's definition has no counterpart of this requirement.

Note also that $\mathrm{Q}$ is nonreversing, but Kelso and Crawford's condition is not strong enough to ensure total inverse isotonicity, as $(0,1,1,0) \in Q(p)$ and $(0,1,1,0) \in$ $Q\left(p^{\prime}\right)$, yet $(0,1,1,0) \notin Q\left(p \wedge p^{\prime}\right)$.

## A. 4 Unified Gross Substitutes and Polterovich and Spivak's Property Are Independent

The following example shows that Polterovich and Spivak's definition of gross substitutes does not imply unified gross substitutes.

Let $N=4$ and

$$
\begin{aligned}
p & =(1,1,2,2) & p \vee p^{\prime} & =(2,2,2,2) \\
p \wedge p^{\prime} & =(1,1,1,1) & p^{\prime} & =(2,2,1,1)
\end{aligned}
$$

and let the supply correspondence be

$$
\begin{aligned}
\mathrm{Q}(p) & =(0,1,2,1) & \mathrm{Q}\left(p \vee p^{\prime}\right) & =(0,2,2,0) \\
\mathrm{Q}\left(p \wedge p^{\prime}\right) & =(1,0,2,1) & \mathrm{Q}\left(p^{\prime}\right) & =(1,2,2,0)
\end{aligned}
$$

Then Polterovich and Spivak's [29] notion of gross substitutability is satisfied. For each of the four relevant increasing-price comparisons ( $p \wedge p^{\prime}$ to $p, p \wedge p^{\prime}$ to $p^{\prime}, p$ to $p \vee p^{\prime}$ and $p^{\prime}$ to $p \vee p^{\prime}$ ), among the prices that remain constant, there is at least one dimension on which the allocation decreases. However, unified gross substitutes fails. We have $p_{2}<p_{2}^{\prime}$, but $q_{2} \leq q_{2}^{\wedge}$ fails. Similarly, $p_{4}^{\prime}<p_{4}$, but $q_{4}^{\vee} \leq q_{4}^{\prime}$ fails.

We next show that one can have unified gross substitutes without having Peltorovich and Spivak's notion of gross substitutability. Let $N=2$ and

$$
p=(1,1) \quad p^{\prime}=(1,2)
$$

and let the supply correspondence be

$$
\mathbf{Q}(p)=\{(1,0),(3,0)\} \quad \mathbf{Q}\left(p^{\prime}\right)=\{(0,0),(2,0)\}
$$

Then Polterovich and Spivak's [29] notion of gross substitutes fails-as we move from $p$ to $p^{\prime}$, the price of good 2 increases while that of good 1 remains constant, but some
allocations in $\mathrm{Q}\left(p^{\prime}\right)$ supply more good 1 than do some allocations in $\mathrm{Q}(p)$. Unified gross substitutes is satisfied-for every allocation in $\mathrm{Q}\left(p^{\prime}\right)$, there is an allocation in $\mathrm{Q}(p)$ that supplies less good 1 , and for every allocation in $\mathrm{Q}(p)$, there is an allocation in $\mathrm{Q}\left(p^{\prime}\right)$ that supplies more good 1 , which in this simple case exhausts the implications of unified gross substitutes.

## A. 5 Outside Goods and Weighted Monotonicity

Given a correspondence $\mathrm{Q}: P \rightrightarrows Q$, we can introduce a fictitious good 0 with price $p_{0}$ and constants $k \in \mathbb{R}_{++}^{N}$, and define the extended correspondence $\tilde{\mathbb{Q}}: P \times P_{0} \rightrightarrows Q \times \mathbb{R}$ by letting

$$
\tilde{\mathbb{Q}}\left(p, p_{0}\right)=\left\{\left(q, q_{0}\right) \in Q \times \mathbb{R}: q \in E(p), q_{0}=p_{0}-\sum_{z=1}^{N} k_{z} q_{z}\right\}
$$

The obvious candidates for extended correspondences will set $P_{0}=\{1\}$ and each of the constants $k_{z}=1$.

We then have:

Lemma 1. If the extended correspondence $\tilde{Q}$ satisfies unified gross substitutes, then the correspondence $\mathrm{Q}$ satisfies unified gross substitutes and weighted monotonicity.

Proof. Let $\tilde{Q}$, derived from $\mathrm{Q}$ via the constants $k \in \mathbb{R}_{++}^{N}$, satisfy unified gross substitutes. The conditions for $\mathrm{Q}$ to satisfy unified gross substitutes are a subset of the conditions for $\tilde{Q}$ to do so, and hence it is immediate that $\mathrm{Q}$ satisfies unified gross substitutes. Next, fix the price vectors $\left(p, p_{0}\right)$ and $\left(p^{\prime}, p_{0}^{\prime}\right)$. Then applying unified gross substitutes to $\tilde{Q}$, we have

$$
p_{0}<p_{0}^{\prime} \Longrightarrow q_{0} \leq q_{0}^{\wedge} \quad \text { and } q_{0}^{\vee} \leq q_{0}^{\prime}
$$

We then note that $p_{0}=p_{0}^{\wedge}$ and $p_{0}^{\prime}=p_{0}^{\vee}$, and hence

$$
\begin{gathered}
p_{0}-q_{0} \geq p_{0}^{\wedge}-q_{0}^{\wedge} \\
p_{0}^{\prime}-q_{0}^{\prime} \leq p_{0}^{\vee}-q_{0}^{\vee}
\end{gathered}
$$

Applying the definition of the extended correspondence gives

$$
\begin{aligned}
& p_{0}-q_{0} \geq p_{0}^{\wedge}-q_{0}^{\wedge} \quad \Longrightarrow \quad \sum_{z=1}^{N} k_{z} q_{z} \geq \sum_{z=1}^{N} k_{z} q_{z}^{\wedge} \\
& p_{0}^{\prime}-q_{0}^{\prime} \leq p_{0}^{\vee}-q_{0}^{\vee} \quad \Longrightarrow \quad \sum_{z=1}^{N} k_{z} q_{z}^{\vee} \geq \sum_{z=1}^{N} k_{z} q_{z}^{\prime}
\end{aligned}
$$

giving the weighted monotonicity of $\mathrm{Q}$.

## A. 6 Connections with Monotone Comparative Statics

We first present an example in which the correspondence $\mathrm{Q}$ fails unified gross substitutes, but satisfies (12) for a function $g(p, q)$ satisfying (13) and hence Topkis' assumptions, and hence $\mathrm{Q}^{-1}$ is isotone.

Let $P=S=\mathbb{R}^{3}$ and let $\mathrm{Q}(p)=\{Y p\}$ where $Y$ is the matrix

$$
\frac{1}{28}\left[\begin{array}{ccc}
63 & -28 & -28 \\
-28 & 16 & 12 \\
-28 & 12 & 16
\end{array}\right]
$$

It is easy to see that the correspondence $\mathrm{Q}$ is a function that fails weak gross substitutes (because $Y$ has some positive off-diagonal terms), and hence fails unified gross substitutes (cf. Property 1). The inverse is the point-valued correspondence $\mathrm{Q}^{-1}=\{X q\}$ where $X$ is the inverse of $Y$, given by

$$
\left[\begin{array}{lll}
4 & 4 & 4 \\
4 & 8 & 1 \\
4 & 1 & 8
\end{array}\right]
$$

Since $X$ has strictly positive terms, it is immediate that $\mathrm{Q}^{-1}$ is isotone. The function $\mathrm{Q}^{-1}$ is the solution to the maximization problem ${ }^{13}$

$$
\max _{p \in \mathbb{R}^{3}} g(p, q)=\max _{p \in \mathbb{R}^{3}} p X q-\frac{1}{2} p_{1}^{2}-\frac{1}{2} p_{2}^{2}-\frac{1}{2} p_{3}^{2}
$$

The function $g(p, q)=p X q-\frac{1}{2} p_{1}^{2}-\frac{1}{2} p_{2}^{2}-\frac{1}{2} p_{3}^{2}$ is strictly concave and satisfies Topkis' assumptions given in 13 ).

We next present an equilibrium correspondence that satisfies unified gross substitutes and aggregate monotonicity, and hence has an isotone inverse, but for which the corresponding function $g$ satisfying (12) fails the formulation of Milgrom and Shannon's conditions given by (14) (and hence, fails those of Topkis).

Let $P=Q=\mathbb{R}_{+}^{2}$ and let the correspondence $\mathrm{Q}$ be given by

$$
\begin{aligned}
& q_{1}(p)=p_{2} \\
& q_{2}(p)=p_{1}
\end{aligned}
$$

Clearly $\mathrm{Q}$ is point-valued, and satisfies unified gross substitutes and aggregate monotonicity. Let $g(p, q)=1$ if $q=\left(p_{2}, p_{1}\right)$ and $g(p, q)=0$ otherwise, and note that (12) holds. Consider the second implication in (14), namely

$$
g\left(p \vee p^{\prime}, q\right)-g\left(p^{\prime}, q\right) \leq 0 \Longrightarrow g\left(p, q^{\prime}\right)-g\left(p \wedge p^{\prime}, q^{\prime}\right) \leq 0
$$[^11]

## Letting

$$
\begin{aligned}
p=(3,3) & q=(5,2) \\
p^{\prime}=(2,5) & q^{\prime}=(4,1)
\end{aligned}
$$

gives us a violation.

## A. 7 Proof of Theorem 3

We present a proof of Theorem 3 that establishes the equivalence between unified gross substitute of $\partial c^{*}$ and the submodularity of $c$. In order to do this, we prove a series of lemmas regarding convex functions and how to characterize their submodularity. Let $f$ be a convex function. Our interpretation will be that $f$ is an indirect profit function $f=c^{*}$ associated with a cost function $c(q)$, but we will not use that interpretation in the lemmas.

The first result is a well-known result in convex analysis (Theorem 23.4 in Rockafellar [31]), recalled here for convenience, which essentially asserts that the support function of the subdifferential of a convex function coincides with the directional derivatives.

Lemma 2. Let $f: \mathbb{R}^{N} \rightarrow \mathbb{R}$ be a convex function. We have

$$
\partial f(p)=\left\{q \in \mathbb{R}^{N}: q^{\top} b \leq\left.\frac{d}{d t} f(p+t b)\right|_{0^{+}}, \forall b \in \mathbb{R}^{N}\right\}
$$

Proof of Lemma 2. By definition, one has that $\partial f(p)$ is the set of $q \in \mathbb{R}^{N}$ such that the quantity $q^{\top} p^{\prime}-f\left(p^{\prime}\right)$ is maximal for $p^{\prime}=p$. Because $f$ is convex, the function $p^{\prime} \rightarrow q^{\top} p^{\prime}-f\left(p^{\prime}\right)$ is maximal at $p$ if and only if all the directional derivatives at $p$ are nonpositive, thus for all $b \in \mathbb{R}^{N}$,

$$
\left.\frac{d}{d t}\left\{q^{\top}(p+t b)-f(p+t b)\right\}\right|_{0^{+}} \leq 0
$$

or equivalently,

$$
q^{\top} b \leq\left.\frac{d}{d t} c^{*}(p+t b)\right|_{0^{+}}
$$

For $X \subseteq \mathbb{R}^{N}$, define $\tilde{X}$ as the set of vectors of $\mathbb{R}^{N}$ that are dominated by some vector in $X$, or more formally:

$$
\begin{equation*}
\tilde{X}=\left\{\tilde{q} \in \mathbb{R}^{N}: \exists q \in X \text { s.t. } \tilde{q} \leq q\right\} \tag{24}
\end{equation*}
$$

and define the support function of $X$ as

$$
\begin{equation*}
h_{X}(b)=\sup _{q \in X}\left\{q^{\top} b:\right\} \tag{25}
\end{equation*}
$$

Let $\operatorname{cch}(X)$ be the convex closure of $X$, which is the closure of the convex hull of $X$. It is well-known that $c c h(X)$ is the set of elements $x \in \mathbb{R}^{N}$ such that $x^{\top} b \leq h_{X}(b)$ for all $b \in \mathbb{R}^{N}$.

The next result states that the support function of $\tilde{C}$ is the support function of $C$ whose domain has been restricted to nonnegative coordinates.

Lemma 3. If $C$ is a closed convex set of $\mathbb{R}^{N}$, then $\tilde{C}$ as defined in expression (24) can be expressed as

$$
\tilde{C}=\left\{q: q^{\top} b \leq h_{C}(b), \forall b \in \mathbb{R}_{+}^{N}\right\}
$$

where $h_{C}$ has been defined in (25).

Proof of Lemma 3. By the supporting hyperplane theorem, for any convex set $C$ and any boundary point $q_{0}=\arg \max _{q \in C} q^{\top} b$ of the boundary of $C$ there exists a supporting hyperplane for $C$ at $q_{0}$. Therefore one has

$$
C=\left\{q: q^{\top} b \leq h(b), \forall b \in \mathbb{R}^{N}\right\}
$$

Further, note that $\hat{C}=\left\{\hat{q}: \hat{q}^{\top} b \leq \hat{h}(b), \forall b \in \mathbb{R}^{N}\right\}$, where $\hat{h}(b)=h(b)$ if $b \in \mathbb{R}_{+}^{N}$ and $\hat{h}(b)=+\infty$ otherwise, and thus

$$
\hat{h}(b)=\max _{\hat{q} \in \hat{C}} \hat{q}^{\top} b
$$

Now compute $\tilde{h}(b)=\max _{\tilde{q} \in \tilde{C}} \tilde{q}^{\top} b$. One has $\tilde{C}=\left\{q-\delta: q \in C, \delta \in \mathbb{R}_{+}^{N}\right\}$, and so

$$
\tilde{h}(b)=\max _{q \in C} \max _{\delta \geq 0}(q-\delta)^{\top} b
$$

Thus, if $b \in \mathbb{R}_{+}^{N}$, one has $\tilde{h}(b)=\max _{q \in C} q^{\top} b=h(b)$. Now if $b_{z}<0$ for some $z$, one has clearly $\tilde{h}(b)=+\infty$. Hence

$$
\tilde{h}(b)=\hat{h}(b)=h(b)+\iota_{\mathbb{R}_{+}^{N}}(b)
$$

where $\iota_{K}(b)=0$ if $b \in K$ and $\iota_{K}(b)=+\infty$ otherwise. This implies that $\hat{C}$ and $\tilde{C}$ have the same support function, and thus coincide.

From Lemma 3, it follows that:

Lemma 4. The inequality $b^{\top} x \leq h_{X}(b)$ holds for all $b \in \mathbb{R}_{+}^{N}$ if and only if there is $\tilde{x} \in \operatorname{cch}(X)$ with $x \leq \tilde{x}$.

Proof of Lemma 4. First, we assume $b^{\top} x \leq h_{X}(b)$ for all $b \geq 0$, and show that $x \in Y$ where $Y=\left\{x^{\prime}: \exists \tilde{x} \in \operatorname{cch}(X): x^{\prime} \leq \tilde{x}\right\}$. One has $X \subseteq Y$. Consider $h_{Y}(b)$ for $b \in R^{Z}$. First, if $b_{z}<0$ for some $z$, then $h_{Y}(b)=+\infty$. Next, if $b \geq 0$, then $h_{Y}(b)=h_{X}(b)$. Indeed, one has $h_{X}(b) \leq \iota_{Y}^{*}(b)$, but taking $y \in Y$ such that $b^{\top} y$ attains $h_{Y}(b)$, we have
$\iota_{Y}^{*}(b)=b^{\top} y$ and by definition of $y \in Y$, there is $\tilde{x} \in \operatorname{cch}(X)$ such that $y \leq \tilde{x}$. Hence as $b \geq 0, b^{\top} y \leq b^{\top} \tilde{x}$, and as $\tilde{x} \in \operatorname{cch}(X)$, we get $b^{\top} \tilde{x} \leq h_{X}(b)$, thus $h_{Y}(b) \leq h_{X}(b)$. As a result $h_{Y}(b)=h_{X}(b)$ as soon as $b \geq 0$, and we have that

$$
b^{\top} x \leq h_{Y}(b) \text { for all } b \in R^{Z}
$$

and therefore, given that $Y$ is a closed convex set, this implies that $x \in Y$.

Conversely, assume there is $\tilde{x} \in \operatorname{cch}(X)$ with $x \leq \tilde{x}$. Then $\tilde{x}=\int_{0}^{1} x_{t} d \mu(t)$ where $\mu$ is a probability measure on $[0,1]$ and $x_{t} \in X$. Then we have $x_{t}^{\top} b \leq h_{X}(b)$ and thus $x^{\top} b \leq \tilde{x}^{\top} b=\int_{0}^{1} x_{t}^{\top} b d \mu(t) \leq \int_{0}^{1} h_{X}(b) d \mu(t)=h_{X}(b)$.

By combining Lemma 2 and Lemma 3 , we get:

Lemma 5. For a convex function $f: \mathbb{R}^{N} \rightarrow \mathbb{R}$, one has

$$
\begin{equation*}
\left\{\tilde{q} \in \mathbb{R}^{N}: \exists q \in \partial f(p) \text { s.t. } \tilde{q} \leq q\right\}=\left\{q \in \mathbb{R}^{N}: q^{\top} b \leq\left.\frac{d}{d t} f(p+t b)\right|_{0^{+}}, \forall b \in \mathbb{R}_{+}^{N}\right\} \tag{26}
\end{equation*}
$$

and both these values coincide with $\widetilde{\partial f(p)}$.

Proof of Lemma 5. Let the function $h$ in the specification of $\hat{C}$ be given by $h(b)=$ $\left.\frac{d}{d t} f(p+t b)\right|_{0^{+}}$. From Claim 1, we then have $h(b)=\max _{q \in a f(p)} q^{\top} b$ and hence can take $C=\partial f(p)$ in the specification of $\tilde{C}$. The equality of $\hat{C}$ and $\tilde{C}$ established in Lemma 3 then gives the required identity (26).

In the sequel, we shall consider a pair of prices $p$ and $p^{\prime}$ in $\mathbb{R}^{N}$, and for a vector $b \in \mathbb{R}^{N}$, we define two vectors $b^{>}$and $b^{\leq}$in $\mathbb{R}^{N}$ such that

$$
\begin{equation*}
b_{z}^{\leq}=b_{z} 1_{\left\{p_{z} \leq p_{z}^{\prime}\right\}} \text { and } b_{z}^{>}=b_{z} 1_{\left\{p_{z}>p_{z}^{\prime}\right\}} \tag{27}
\end{equation*}
$$

Lemma 6. A function $f: \mathbb{R}^{N} \rightarrow \mathbb{R}$ is submodular if and only if for any $p, p^{\prime}$ in $\mathbb{R}^{N}$, $b \in R_{+}^{N}$ such that $b^{>} \leq\left(p-p^{\prime}\right)^{+}$, one has

$$
f\left(p+b^{\leq}\right)+f\left(p^{\prime}+b^{>}\right)+f\left(p \wedge p^{\prime}\right) \leq f(p)+f\left(p^{\prime}\right)+f\left(p \wedge p^{\prime}+b\right)
$$

Proof of Lemma 6. Suppose $f$ is submodular. Then we have, by the submodularity of $f$,

$$
f(p)+f\left(p \wedge p^{\prime}+b\right) \geq f\left(p \wedge\left(p \wedge p^{\prime}+b\right)\right)+f\left(p \vee\left(p \wedge p^{\prime}+b\right)\right)
$$

However, $p \wedge\left(p \wedge p^{\prime}+b\right)=p \wedge p^{\prime}+b^{>}$and $p \vee\left(p \wedge p^{\prime}+b\right)=p+b^{\leq}$, and so

$$
f(p)+f\left(p \wedge p^{\prime}+b\right) \geq f\left(p \wedge p^{\prime}+b^{>}\right)+f\left(p+b^{\leq}\right)
$$

This implies

$$
f(p)+f\left(p^{\prime}\right)+f\left(p \wedge p^{\prime}+b\right) \geq f\left(p \wedge p^{\prime}+b^{>}\right)+f\left(p^{\prime}\right)+f\left(p+b^{\leq}\right)
$$

Again by the submodularity of $f$, we have

$$
f\left(p \wedge p^{\prime}+b^{>}\right)+f\left(p^{\prime}\right) \geq f\left(\left(p \wedge p^{\prime}+b^{>}\right) \wedge p^{\prime}\right)+f\left(\left(p \wedge p^{\prime}+b^{>}\right) \vee p^{\prime}\right)
$$

and hence

$$
\begin{align*}
& f(p)+f\left(p^{\prime}\right)+f\left(p \wedge p^{\prime}+b\right)  \tag{28}\\
\geq & f\left(\left(p \wedge p^{\prime}+b^{>}\right) \wedge p^{\prime}\right)+f\left(\left(p \wedge p^{\prime}+b^{>}\right) \vee p^{\prime}\right)+f\left(p+b^{\leq}\right)
\end{align*}
$$

But $\left(p \wedge p^{\prime}+b^{>}\right) \wedge p^{\prime}=p \wedge p^{\prime}$ and $\left(p \wedge p^{\prime}+b^{>}\right) \vee p^{\prime}=p^{\prime}+b^{>}$, and therefore (28) becomes

$$
f(p)+f\left(p^{\prime}\right)+f\left(p \wedge p^{\prime}+b\right) \geq f\left(p \wedge p^{\prime}\right)+f\left(p^{\prime}+b^{>}\right)+f\left(p+b^{\leq}\right)
$$

giving the required result.

Conversely, assume we have for all $p, p^{\prime}$ and $b \geq 0$ that

$$
f(p)+f\left(p^{\prime}\right)+f\left(p \wedge p^{\prime}+b\right) \geq f\left(p+b^{\leq}\right)+f\left(p^{\prime}+b^{>}\right)+f\left(p \wedge p^{\prime}\right)
$$

Choose $b$ to be specified by $b^{\leq}=\left(p^{\prime}-p\right)^{+}$and $b^{>}=0$. We have

$$
\begin{aligned}
p \wedge p^{\prime}+b & =p^{\prime} \\
p+b^{\leq} & =p \vee p^{\prime}
\end{aligned}
$$

and thus

$$
f(p)+f\left(p^{\prime}\right) \geq f\left(p \vee p^{\prime}\right)+f\left(p \wedge p^{\prime}\right)
$$

giving the submodularity of $f$.

Lemma 7. A convex function $f: \mathbb{R}^{N} \rightarrow \mathbb{R}$ is submodular if and only if for any $b \in \mathbb{R}_{+}^{N}$

$$
\begin{equation*}
\left.\frac{d}{d t} f\left(p+t b^{\leq}\right)\right|_{0^{+}}+\left.\frac{d}{d t} f\left(p^{\prime}+t b^{>}\right)\right|_{0^{+}} \leq\left.\frac{d}{d t} f\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}} \tag{29}
\end{equation*}
$$

where $b \leq$ and $b^{>}$are defined in equation 27).

Proof of Lemma 7. Applying Lemma 6, if $f$ is submodular it follows that for $t \geq 0$, we have

$$
f\left(p+t b^{\leq}\right)-f(p)+f\left(p^{\prime}+t b^{>}\right)-f\left(p^{\prime}\right) \leq f\left(p \wedge p^{\prime}+t b\right)-f\left(p \wedge p^{\prime}\right)
$$

and thus, using the convexity of $f$, it follows that

$$
\left.\frac{d}{d t} f\left(p+t b^{\leq}\right)\right|_{0^{+}}+\left.\frac{d}{d t} f\left(p^{\prime}+t b^{>}\right)\right|_{0^{+}} \leq\left.\frac{d}{d t} f\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}}
$$

The converse holds by integration over $t \in[0,1]$.

Theorem 3, direct implication. If $f$ is submodular then $\partial f(p)$ exhibits unified gross substitutes.

Proof of the direct implication of Theorem 3. Assume $f$ is submodular. Take $q \in$ $\partial f(p)$ and $q^{\prime} \in \partial f\left(p^{\prime}\right)$. We want to show that there exists $q^{\wedge} \in \partial f\left(p \wedge p^{\prime}\right)$ such that

$$
\begin{aligned}
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z} \leq q_{z}^{\wedge} \\
& p_{z}>p_{z}^{\prime} \quad \Longrightarrow \quad q_{z}^{\prime} \leq q_{z}^{\wedge}
\end{aligned}
$$

To show this, we need to show that $q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}}>\leq q^{\wedge}$, i. e, we need to show that $q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}}>\in \widetilde{\partial f}\left(p \wedge p^{\prime}\right)$, where the tilde notation $\widetilde{\partial f}$ was introduced in (24). By Lemma 5, it suffices to show that

$$
\forall b \in \mathbb{R}_{+}^{N}:\left(q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}}>\right)^{\top} b \leq\left.\frac{d}{d t} f\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}}
$$

In order to do this, take $b \in \mathbb{R}_{+}^{N}$ and express that $q \in \partial f(p)$ and $q^{\prime} \in \partial f\left(p^{\prime}\right)$ by writing

$$
q^{\top} b^{\leq} \leq\left.\frac{d}{d t} f\left(p+t b^{\leq}\right)\right|_{0^{+}} \text {and } q^{\prime \top} b^{>} \leq\left.\frac{d}{d t} f\left(p^{\prime}+t b^{>}\right)\right|_{0^{+}}
$$

and then note that, by summation of these two inequalities we get

$$
\left(q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}>}\right)^{\top} b \leq\left.\frac{d}{d t} f\left(p+t b^{\leq}\right)\right|_{0^{+}}+\left.\frac{d}{d t} f\left(p^{\prime}+t b^{>}\right)\right|_{0^{+}}
$$

and so by Lemma 7, we have

$$
\forall b \in \mathbb{R}_{+}^{N}:\left(q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}>}\right)^{\top} b \leq\left.\frac{d}{d t} f\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}}
$$

and hence (again, by Lemma 5$) q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}>} \in \widetilde{\partial f}\left(p \wedge p^{\prime}\right)$ as required.

We set $\hat{f}=f(-p)$, and we introduce $\hat{p}=p^{\prime}$ and $\hat{p}^{\prime}=p$. We note that $\hat{f}$ is submodular, and we apply the previous claim to $\hat{p}$ and $\hat{p}^{\prime}$ to get the existence of $q^{\vee} \in \partial f\left(p \vee p^{\prime}\right)$ such that

$$
\begin{aligned}
& p_{z} \leq p_{z}^{\prime} \quad \Longrightarrow \quad q_{z} \geq q_{z}^{\vee} \\
& p_{z}>p_{z}^{\prime} \quad \Longrightarrow \quad q_{z}^{\prime} \geq q_{z}^{\vee}
\end{aligned}
$$

Theorem 3, backward implication. The converse holds, i.e. if $\partial f(p)$ satisfies unified gross substitutes, then $f(p)$ is submodular.

Proof of the backward implication of Theorem 3. Assume unified gross substitutes holds. Then for $q \in \partial f(p)$ and $q^{\prime} \in \partial f\left(p^{\prime}\right)$, there exists $q^{\wedge} \in \partial f\left(p \wedge p^{\prime}\right)$ such that

$$
q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}>} \leq q^{\wedge}
$$

Hence $q \mathbf{1}_{\mathcal{Z} \leq}+q^{\prime} \mathbf{1}_{\mathcal{Z}>} \in \widetilde{\partial f}\left(p \wedge p^{\prime}\right)$, and therefore (using Lemma 3), for all $q \in \partial f(p)$ and $q^{\prime} \in \partial f\left(p^{\prime}\right)$

$$
\forall b \in \mathbb{R}_{+}^{Z}: q^{\top} b^{\leq}+q^{\prime \top} b^{<} \leq\left.\frac{d}{d t} f\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}}
$$

and thus, by maximizing over $q \in \partial f(p)$ and $q^{\prime} \in \partial f\left(p^{\prime}\right)$, we get

$$
\left.\frac{d}{d t} f\left(p+t b^{\leq}\right)\right|_{0^{+}}+\left.\frac{d}{d t} f\left(p^{\prime}+t b^{>}\right)\right|_{0^{+}} \leq\left.\frac{d}{d t} c^{*}\left(p \wedge p^{\prime}+t b\right)\right|_{0^{+}}
$$

for all $b \geq 0$, hence (by Lemma 7) $f$ is submodular.

## A. 8 Proof of Theorem 5

Let $q \in \mathbf{Q}(p)$ and $q^{\prime} \in \mathbf{Q}\left(p^{\prime}\right)$. Rewriting (1)-(2), it suffices for unified gross substitutes to show that there exists $q^{\vee} \in \mathbb{Q}\left(p \vee p^{\prime}\right)$ and $q^{\wedge} \in \mathrm{Q}\left(p \wedge p^{\prime}\right)$ such that for all $z \in \mathcal{Z}$,

$$
\begin{aligned}
& \mathbf{1}_{\{z \in \mathcal{Z} \leq\}} q_{z}+\mathbf{1}_{\{z \in \mathcal{Z}>\}} q_{z}^{\prime} \leq q_{z}^{\wedge} \\
& \mathbf{1}_{\{z \in \mathcal{Z} \leq\}} q_{z}^{\prime}+\mathbf{1}_{\{z \in \mathcal{Z}>\}} q_{z} \geq q_{z}^{\vee}
\end{aligned}
$$

where we have defined $\mathcal{Z} \leq=\left\{z \in \mathcal{Z}: p_{z} \leq p_{z}^{\prime}\right\}$ and $\mathcal{Z}^{>}=\left\{z \in \mathcal{Z}: p_{z}>p_{z}^{\prime}\right\}$.

First, note that $\mu_{x z}>0$ and $p_{z} \leq p_{z}^{\prime}$ implies $p_{x}^{\prime} \geq G_{x z}\left(p_{z}^{\prime}\right) \geq G_{x z}\left(p_{z}\right)=p_{x}$, which implies

$$
\begin{equation*}
\mu_{x z} \mathbf{1}_{\{z \in \mathcal{Z} \leq\}} \leq \mu_{x z} \mathbf{1}_{\{x \in \mathcal{Z} \leq\}} \tag{30}
\end{equation*}
$$

Similarly, $\mu_{x z}^{\prime}>0$ and $p_{z}>p_{z}^{\prime}$ implies $p_{x} \geq G_{x z}\left(p_{z}\right)>G_{x z}\left(p_{z}^{\prime}\right)=p_{x}^{\prime}$, thus

$$
\begin{equation*}
\mu_{x z}^{\prime} \mathbf{1}_{\{z \in \mathcal{Z}>\}} \leq \mu_{x z}^{\prime} \mathbf{1}_{\{x \in \mathcal{Z}>\}} \tag{31}
\end{equation*}
$$

Given these results, set:

$$
\begin{aligned}
\mu_{x z}^{\wedge} & =1_{\{x \in \mathcal{Z} \leq\}} \mu_{x z}+1_{\{x \in \mathcal{Z}>\}} \mu_{x z}^{\prime} \\
q_{z}^{\wedge} & =\sum_{x} \mu_{x z}^{\wedge}-\sum_{y} \mu_{z y}^{\wedge}
\end{aligned}
$$

We have $\mu_{x y}^{\wedge}>0$ implies $p_{x}=G_{x y}\left(p_{y}\right)$, and, using (30) and (31) for the inequality, we obtain

$$
\begin{aligned}
q_{z}^{\wedge} & =\sum_{x}\left(\mathbf{1}_{\{x \in \mathcal{Z} \leq\}} \mu_{x z}+\mathbf{1}_{\{x \in \mathcal{Z}>\}} \mu_{x z}^{\prime}\right)-\sum_{y}\left(\mathbf{1}_{\{z \in \mathcal{Z} \leq\}} \mu_{z y}+\mathbf{1}_{\{x \in \mathcal{Z}>\}} \mu_{z y}^{\prime}\right) \\
& \geq \sum_{x}\left(\mathbf{1}_{\{z \in \mathcal{Z} \leq\}} \mu_{x z}+\mathbf{1}_{\{z \in \mathcal{Z}>\}} \mu_{x z}^{\prime}\right)-\sum_{y}\left(\mathbf{1}_{\{z \in \mathcal{Z} \leq\}} \mu_{z y}+\mathbf{1}_{\{z \in \mathcal{Z}>\}} \mu_{z y}^{\prime}\right) \\
& =\mathbf{1}_{\{z \in \mathcal{Z} \leq\}} q_{z}+\mathbf{1}_{\{z \in \mathcal{Z}>\}} q_{z}^{\prime}
\end{aligned}
$$

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-41.jpg?height=517&width=526&top_left_y=300&top_left_x=797)

Figure 4: Network associated with a bipartite matching problem with singles.

giving the required result for $q^{\wedge}$. A similar argument shows that $\mathbb{1}_{\{z \in \mathcal{Z} \leq\}} q_{z}^{\prime}+$ $1_{\{z \in \mathcal{Z}>\}} q_{z}^{\prime} \geq q_{z}^{\vee}$.

## A. 9 Matching and Equilibrium Flows

We associate an equilibrium flow problem with this matching market, generalized to accommodate unmatched agents. See figure 4 .

$$
\begin{aligned}
\mathcal{Z} & =\mathcal{X} \cup \mathcal{Y} \cup\{0\} \\
\mathcal{A} & =((\mathcal{X} \cup\{0\}) \times(\mathcal{Y} \cup\{0\})) \backslash\{(0,0)\} \\
q_{z} & =-n_{z}, \quad z \in \mathcal{X} \\
q_{z} & =m_{z}, \quad z \in \mathcal{Y}
\end{aligned}
$$

Given a price $p$, we define the connection function

$$
\begin{aligned}
G_{x y}\left(p_{y}\right) & =\mathcal{U}_{x y} \circ \mathcal{V}_{x y}^{-1}\left(-p_{y}\right) \text { for } x \in \mathcal{X}, y \in \mathcal{Y} \\
G_{x 0}(p) & =p_{0} \text { for } x \in \mathcal{X} \\
G_{0 y}(p) & =p_{y} \text { for } y \in \mathcal{Y}
\end{aligned}
$$

As required, $G_{x y}\left(p_{y}\right)$ is increasing in $p_{y}$. We adopt the normalization $p_{0}=0$. We now establish a relationship between stable matchings of the matching market and equilibria of the equilibrium flow problem. First, let $(q, \mu, p)$ be an equilibrium of the equilibrium flow problem. To obtain a stable matching $(\mu, w)$, choose $w_{x y}$ so that $\mathcal{V}_{x y}^{-1}\left(-p_{y}\right) \leq w_{x y} \leq \mathcal{U}_{x y}^{-1}\left(p_{x}\right)$. Because we have $p_{x} \geq G_{x y}\left(p_{y}\right)$ in equilibrium, this is
possible. Then for worker $x$ we have

$$
\begin{aligned}
\mu_{x y}>0 & \Longrightarrow p_{x}=G_{x y}\left(p_{y}\right) \\
& \Longrightarrow w_{x y}=\mathcal{U}_{x y}^{-1}\left(p_{x}\right) \\
p_{x} \geq G_{x z}\left(p_{z}\right) \leq 0 & \Longrightarrow w_{x z} \leq \mathcal{U}_{x z}^{-1}\left(p_{x}\right) \\
& \Longrightarrow \mathcal{U}_{x y}\left(w_{x y}\right) \geq \mathcal{U}_{x z}\left(w_{x z}\right)
\end{aligned}
$$

which gives

$$
y \in \arg \max _{y \in \mathcal{Y}} \mathcal{U}_{x y}\left(w_{x y}\right)
$$

as needed. The argument for firms is similar, giving a stable matching.

Conversely, suppose we have a stable matching $(\mu, w)$. Define $q_{z}=-n_{x}$ for $z \in \mathcal{X}$ and $q_{z}=m_{y}$ for $z \in \mathcal{Y}$. We identify prices $p$ such that $(q, \mu, p)$ is an equilibrium of the equilibrium flow problem. Define the indirect utilities

$$
\begin{aligned}
& u_{x}=\max _{x \in \mathcal{X}}\left\{\mathcal{U}_{x y}\left(w_{x y}\right), 0\right\} \\
& v_{y}=\max _{y \in \mathcal{Y}}\left\{\mathcal{V}_{x y}\left(w_{x y}\right), 0\right\}
\end{aligned}
$$

Then define $p$ by $p_{x}=u_{x}$ if $x \in \mathcal{X}, p_{y}=-v_{y}$ if $y \in \mathcal{Y}$ and $p_{0}=0$, and define $q_{z}=-n_{x}$ for $z \in \mathcal{X}$ and $q_{z}=m_{y}$ for $z \in \mathcal{Y}$. Define the connection functions $G_{x y}$ as above. If $\mu_{x y}=0$, then it follows from the stability condition for a stable matching that $p_{x}=G_{x y}\left(p_{y}\right)$. For other pairs $(x, y)$, the stability condition implies that there is no wage $w_{x y}$ at which $x$ and $y$ can match and obtain utilities in excess of $u_{x}$ and $v_{y}$, which is equivalent to the statement that $p_{x} \geq G_{x y}\left(p_{y}\right)$. We thus have an equilibrium flow.

## A. 10 Proof of Theorem 7

Statement (i): Assume $\mu$ is a stable matching. Let $y \in \mathcal{Y}$ and let $x \in \mathcal{X}_{0}$ be the match of $y$ under $\mu$. We need to consider two cases:

First case: Let $x \in \mathcal{X}$. We have that $v_{y}^{\mu}=\gamma_{x y}$, and there cannot be another $y^{\prime} \in \mathcal{Y}$ with $\gamma_{x y^{\prime}} \geq v_{y^{\prime}}^{\mu}$ and $\alpha_{x y^{\prime}}>u_{x}^{\mu}=\alpha_{x y}$; for if this were the case, $y \neq y^{\prime}$, and hence $x$ is not matched with $y^{\prime}$, and thus $\gamma_{x y^{\prime}} \geq v_{y^{\prime}}^{\mu}$ would imply $\gamma_{x y^{\prime}}>v_{y^{\prime}}^{\mu}$. As a result,

$$
\begin{equation*}
y \in \arg \max _{y \in \mathcal{Y}}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}^{\mu}, \alpha_{x 0}\right\} \tag{32}
\end{equation*}
$$

Now assume that $y \in \arg \max _{y}\left\{\alpha_{x^{\prime} y}: \gamma_{x^{\prime} y} \geq v_{y}, \alpha_{x^{\prime} 0}\right\}$ for some $x^{\prime} \neq x$; but then $x^{\prime} y$ would be a blocking pair; further, $v_{y}^{\mu}=\gamma_{x y}>\gamma_{0 y}$. As a result, for any $x^{\prime} \in \mathcal{X} \backslash\{x\}$, we have

$$
\begin{equation*}
y \notin \arg \max _{y}\left\{\alpha_{x^{\prime} y}: \gamma_{x^{\prime} y} \geq v_{y}, \alpha_{x^{\prime} 0}\right\} \tag{33}
\end{equation*}
$$

Finally, because $\mu$ is stable and $x \neq 0$, we have

$$
\begin{equation*}
v_{y}^{\mu}=\gamma_{x y}>\gamma_{0 y} \tag{34}
\end{equation*}
$$

By putting (32), (33), and (34) together, we get that $Q_{y}\left(v^{\mu}\right)=0$.

Second case: Let $x=0$. Then $v_{y}^{\mu}=\gamma_{0 y}$ and a similar logic as above shows that for any $x^{\prime} \in \mathcal{X}$, we have

$$
y \notin \arg \max _{y}\left\{\alpha_{x^{\prime} y}: \gamma_{x^{\prime} y} \geq v_{y}, \alpha_{x^{\prime} 0}\right\}
$$

and as a result we get that $Q_{y}\left(v^{\mu}\right)=0$.

Statement (ii): Conversely, assume $Q(v)=0$. Then for $x \in \mathcal{X}$ and $y \in \mathcal{Y}$, we define

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-43.jpg?height=123&width=1029&top_left_y=833&top_left_x=537)

We have $\sum_{x \in \mathcal{X}_{0}} \mu_{x y}=1$ by assumption and it is straightforward to see that $\sum_{y \in \mathcal{Y}_{0}} \mu_{x y}=$ 1 by the strict preferences assumption.

We need to show that $\mu$ is a stable matching. First, let us show that there is no blocking pair. By contradiction, assume $x y$ is a blocking pair. Consider $x^{*} \in \mathcal{X}_{0}$, the match of $y$ under $\mu$, and $y^{*} \in \mathcal{Y}_{0}$, the match of $x$ under $\mu$. Because $x y$ is a blocking pair, we have $\gamma_{x y}>\gamma_{x^{*} y}$ and $\alpha_{x y}>\alpha_{x y^{*}}$.

We show that $\gamma_{x y}>v_{y}$. Indeed, if $x^{*} \neq 0$ we have that because $x^{*}$ is matched with $y$, then $y \in \arg \max _{y}\left\{\alpha_{x^{*} y}: \gamma_{x^{*} y} \geq v_{y}, \alpha_{x^{*} 0}\right\}$, and $\gamma_{x^{*} y} \geq v_{y}$, and thus $\gamma_{x y}>\gamma_{x^{*} y} \geq v_{y}$. Otherwise, if $x^{*}=0$, we have $\mu_{0 y}=1$, and hence $\gamma_{0 y} \geq v_{y}$; but we have $\gamma_{x y}>\gamma_{0 y}$, because $x y$ is a blocking pair, and thus $\gamma_{x y}>\gamma_{0 y} \geq v_{y}$. In either case, $\gamma_{x y}>v_{y}$ as announced.

As $\alpha_{x y^{*}}=\max _{y}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}, \alpha_{x 0}\right\}$ and $\gamma_{x y}>v_{y}$, it follows that $\alpha_{x y^{*}} \geq \alpha_{x y}$, a contradiction.

Finally, we need to show that there is no blocking individual. Assume $x y$ is a matched pair. As $\mu_{x y}=1$, we have $\alpha_{x y} \geq \alpha_{x 0}$ by definition of $\mu$. Next, we have $\mu_{0 y}=0$ therefore $\gamma_{0 y}<v_{y}$ and in particular $\gamma_{0 y} \leq v_{y}$.

## A. 11 Proof of Theorem 8

It is straightforward to verify that Q satisfies weak gross substitutes, and hence it defines a point-valued correspondence for which unified gross substitutes holds, by Property 1. Next, we show that is it a M0-correspondence by showing that it satisfies
monotone total output. We have

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-44.jpg?height=122&width=1258&top_left_y=394&top_left_x=409)

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-44.jpg?height=111&width=1044&top_left_y=514&top_left_x=622)

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-44.jpg?height=122&width=1089&top_left_y=622&top_left_x=621)

$$
\begin{aligned}
& =|Y|-|X|-\sum_{x \in X} 1_{\left\{\alpha_{x 0} \geq \max _{y \in Y}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}\right\}\right\}}-\sum_{y \in Y} 1_{\left\{\gamma_{0 y} \geq v_{y}\right\}}
\end{aligned}
$$

We then note that $\mathbb{1}_{\left\{\alpha_{x 0} \geq \max _{y \in Y}\left\{\alpha_{x y}: \gamma_{x y} \geq v_{y}\right\}\right\}}$ is nondecreasing in each $v_{y}$, and similarly $\mathbf{1}_{\left\{\gamma_{0 y} \geq v_{y}\right\}}$ is also nondecreasing in each $v_{y}$. Hence monotone total output holds, and nonreversingness follows.

## A. 12 Proof of Theorem 9

We show that the hedonic pricing problem is an equilibrium flow problem, as illustrated in Figure 5 .

![](https://cdn.mathpix.com/cropped/2024_06_04_c85bf03912cd40a810aeg-44.jpg?height=542&width=533&top_left_y=1336&top_left_x=796)

Figure 5: Network associated with a hedonic model.

Consider $\mathcal{Z}=\mathcal{X} \cup \mathcal{Y} \cup \mathcal{W}$ and $\mathcal{Z}_{0}=\mathcal{Z} \cup\{0\}$, where 0 is an additional node. Denote as well $\mathcal{W}_{0}=\mathcal{W} \cup\{0\}$. The set of arcs $\mathcal{A}$ is given by

$$
\mathcal{A}=\left(\mathcal{X} \times \mathcal{W}_{0}\right) \cup\left(\mathcal{W}_{0} \times \mathcal{Y}\right)
$$

To define the connection functions, first let $p_{x}=u_{x}$ for all $x \in \mathcal{X}, p_{w}=p_{w}$ for all $w \in \mathcal{W}$ and $p_{y}=-v_{y}$ for all $y \in \mathcal{Y}$.

Then the connections functions are given by $G_{x w}\left(p_{w}\right)=\pi_{x w}\left(p_{w}\right), G_{x 0}\left(p_{0}\right)=$ $p_{0}, G_{w y}\left(p_{y}\right)=s_{y w}^{-1}\left(-p_{y}\right)$ and $G_{0 y}\left(p_{y}\right)=p_{y}$.

The equilibrium stocks are given by $q_{w}=\sum_{x \in \mathcal{X}} \mu_{x 0}-\sum_{y \in \mathcal{Y}} \mu_{0 y}$ for all $w \in \mathcal{W}$, $q_{x}=-n_{x}$ for all $x \in \mathcal{X}, q_{w}=0$ for all $w \in \mathcal{W}$ and $q_{y}=m_{y}$ for all $y \in \mathcal{Y}$.

We can then reformulate the equilibrium conditions of Definition 12 as an equilibrium flow on this network, along with the normalization $p_{0}=0$.

## References

[1] Ravindra K. Ahuja, Thomas L. Magnanti, and James B. Orlin. Network Flows: Theory, Algorithms and Applications. Prentice Hall, Englewood Cliffs, NJ, 1993.

[2] Kenneth J. Arrow and Frank Hahn. General Competitive Analysis. Holden-Day, San Francisco, 1971.

[3] Lawrence M. Ausubel and Paul R. Milgrom. Ascending auctions with package bidding. Advances in Theoretical Economics, 1(1), 2002. Article 1.

[4] Richard Bellman. On a routing problem. Quarterly of Applied Mathematics, $16: 87-90,1958$.

[5] Steven Berry, Amit Gandhi, and Philip Haile. Connected substitutes and invertibility of demand. Econometrica, 81(5):2087-2111, 2013.

[6] J. Frédéric Bonnans and Alexander Shapiro. Perturbation analysis of optimization problems. Springer Science \& Business Media, 2013.

[7] Xin Chen and Menglong Li. S-convexity and gross substitutability. Unpublished, University of Illinois, 2020.

[8] Pierre-Andre Chiappori, Robert J. McCann, and Lars P. Nesheim. Hedonic price equilibria, stable matching, and optimal transport: Equivalence, topology and uniqueness. Economic Theory, 42(2):317-354, 2010.

[9] Gabrielle Demange and David Gale. The strategy structure of two-sided matching markets. Econometrica, 53(4):873-888, 1985.

[10] Gabrielle Demange, David Gale, and Maria Sotomayor. Multi-item auctions. Journal of Political Economy, 94(4):863-872, 1986.

[11] Ivar Ekeland, James Heckman, and Lars P. Nesheim. Identification and estimation of hedonic models. Journal of Political Economy, 112(1):S60-S109, 2004.

[12] David Gale and Hukukane Nikaido. The Jacobian matrix and global univalence of mappings. Mathematische Annalen, 159:81-93, 1965.

[13] Alfred Galichon. The unreasonable effectiveness of optimal transport in economics. arXiv preprint arXiv:2107.04700, 2021.

[14] Alfred Galichon, Yu-Wei Hiseh, and Maxime Sylvestre. Monotone comparative statics for submodular functions, with an application to aggregated deferred acceptance. Unpublished, New York University and Sciences Po, 2022.

[15] Alfred Galichon, Larry Samuelson, and Lucas Vernet. The existence of equilibrium flows. Unpublished, New York University and Sciences Po, Yale University, and Sciences Po and Banque de France, 2022.

[16] Faruk Gul and Ennio Stacchetti. Walrasian equilibrium with gross substitutes. Journal of Economic Theory, 87(1):95-124, 1999.

[17] Philip Hall. On representatives of subsets. Journal of the London Mathematical Society, 10(1):26-30, 1935.

[18] John William Hatfield and Paul R. Milgrom. Matching with contracts. American Economic Review, 95(4):913-935, 2005.

[19] Peter Howitt. Gross substitutability with multi-valued excess demand functions. Econometrica, 48(6):1567-1573, 1980.

[20] Alexander S. Kelso and Vincent P. Crawford. Job matching, coalition formation, and gross substitutes. Econometrica, 50(6):1483-1504, 1982.

[21] Andreu Mas-Colell, Michael D. Whinston, and Jerry R. Green. Microeconomic Theory. Oxford University Press, Oxford, 1995.

[22] Paul R. Milgrom and Chris Shannon. Monotone comparative statics. Econometrica, 62:157-180, 1994.

[23] Gaspard Monge. Mèmoire sur la thèorie des dèblais et des remblais. Technical report, De l'Imprimerie Royale, 1781.

[24] J. Moré and W. Rheinboldt. On P- and S-functions and related classes of $n$ dimensional nonlinear mappings. Linear Algebra and its Applications, 6:45-68, 1973.

[25] Hukukane Nikaido. Convex Structures and Economic Theory. Academic Press, New York, 1968.

[26] Georg Nöldeke and Larry Samuelson. The implementation duality. Econometrica, 86(4):1283-1384, 2018.

[27] James M. Ortega and Werner C. Rheinboldt. Iterative Solution of Nonlinear Equations in Several Variables. Society for Industrial and Applied Mathematics, 2000 .

[28] R. J. Plemmons. M-matrix characterizations I. Nonsingular M-matrices. Linear Algebra and its Applications, 18:175-188, 1977.

[29] V. M. Polterovich and V. A. Spivak. Gross substitutability of point-to-set correspondences. Journal of Mathematical Economics, 1:117-140, 1983.

[30] Jean-Charles Rochet. A necessary and sufficient condition for rationalizability in a quasi-linear context. Journal of Mathematical Economics, 16:191-200, 1987.

[31] R. Tyrrell Rockafellar. Convex Analysis. Princeton University Press, Princeton, 1997 .

[32] Shewin Rosen. Hedonic prices and implicit markets: Product differentiation in pure competition. Journal of Politcal Economy, 82(1):34-55, 1974.

[33] Donald M. Topkis. Minimizing a submodular function on a lattice. Operations Research, 26:305-321, 1978.

[34] Donald M. Topkis. Supermodularity and Complementarity. Princeton University Press, Princeton, 1998.

[35] Richard S. Varga. Matrix Iterative Analysis. Springer-Verlag, Berlin, 2000.

[36] A. Veinott. Lattice programming: Qualitative optimization and equilibria. Unpublished, Stanford University, 1992.
</end of paper 2>


<paper 3>
# Substitutability, equilibrium transport, and matching models 

Alfred Galichon, Antoine Jacquet

April 2024

## 1 Introduction

This chapter is about substitutability. Substitutability is a fundamental property of optimal transport models, although it is less recognized than convexity.

Consider the problem of computing an economic equilibrium

$$
\begin{equation*}
Q(p)=0 \tag{1}
\end{equation*}
$$

where $p$ is a vector of prices for $n$ goods, and $Q: \mathbb{R}^{n} \rightarrow \mathbb{R}^{n}$ is an excess supply function (supply minus demand for each of the $n$ goods).

Broadly speaking, there are only two categories of economic models that can be conveniently computed. The first category includes the models that rely on convexity, i.e. models where $Q=\nabla U(p)$ with $U$ a convex function. These models can be reformulated as an optimization problem (minimization of $U$ ) and descent methods, such as the standard gradient descent, will work:

$$
\begin{equation*}
p_{z}^{t+1}=p_{z}^{t}-\varepsilon Q_{z}\left(p^{t}\right), \quad \varepsilon>0 \text { small. } \tag{2}
\end{equation*}
$$

The second category comprises the models that rely on substitutability essentially the idea that $Q_{z}$ is increasing in $p_{z}$ and decreasing in $p_{x}$ for $x \neq z$. In this case, coordinate update methods, such as nonlinear Jacobi, where we set the price of good $z$ to clear the market for good $z$, will work:

$$
\begin{equation*}
Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{3}
\end{equation*}
$$

By an extraordinary coincidence, optimal transport inherits both structures. For this reason, one can compute the OT problem and its regularizations both by descent methods and by coordinate update methods (which is called Sinkhorn's algorithm).

Some matching models can be computed using optimal transport. These are called transferable utility models, and they assume that everyone's valuations are expressed in the same monetary unit. In that case, equilibrium in
matching problems is the solution to an optimization problem. However, in many other cases this assumption cannot be made. In labor economics, for instance, one dollar for the firm does not have the same value as one dollar for the employee (pre-tax or post-tax; decreasing marginal utility, etc). Similarly, in family economics partners may transfer utility by allocating public and private expenditures that can be inefficient. Lastly, in school choice problems utility is cardinal and cannot be transferred.

We will see mathematically that these models cannot be recast as optimization problems, and so the convex optimization structure is lost. They can, however, be reformulated as models with substitutability, from which we will be able to deduce a lot of structure and computational methods.

The chapter is organized as follows. We will start in section 2 by introducing Jacobi's algorithm and some of its basic properties. We will proceed with a rather detailed study of substitutability and its mathematical counterparts, $Z$ - and M-functions. There was a vibrant literature on this topic in the 1970s (Birkhoff, Rheinboldt, Ortega, More, Porsching, and some others; see in particular Ortega and Rheinboldt's 1970 book), but this literature has somehow fallen out of attention. We will unearth some of the main results from that literature regarding the convergence of Jacobi's algorithm, and provide some new ones. The section ends with a toy hedonic model as an illustration.

In section 3, we will appeal to the machinery developed in section 2 to study models of matching with transfers, departing from the assumption of perfectly transferable utility. The section will deal with the regularized and unregularized cases, and it will show the convergence of IPFP, and discuss the existence and uniqueness of an equilibrium.

In section 4 we will revisit Gale and Shapley's famous theory of "stable marriages," which is the theory of matchings without transfers, and we will reinterpret the well-known deferred acceptance algorithm as a damped version of Jacobi's algorithm. We also present Adachi's formulation of the stable matching problem, which leads to the notion of more recent notion of equilibrium matchings.

We hope this chapter will provide a solid mathematical introduction to matching models in economics and econometrics.

## 2 M-functions and Jacobi's algorithm

In this section we introduce the mathematical notions related to models with substitutability, notably Z- and M-functions, as well as Jacobi's algorithm for solving such models.

### 2.1 Jacobi's algorithm

Put simply, our goal is to solve a system of nonlinear equations

$$
\begin{equation*}
Q(p)=0 \tag{4}
\end{equation*}
$$

where $Q: \mathbb{R}^{Z} \rightarrow \mathbb{R}^{Z}$ and $|Z|=n$. We shall assume throughout:

Assumption 2.1 (Continuity). $Q$ is continuous.

In economic terms, $Q$ can be interpreted as an excess supply function. Suppose the demand for good $z$ is a function $D_{z}(p)$ which depends on all prices, and similarly the supply for good $z$ is a function $S_{z}(p)$. Then

$$
\begin{equation*}
Q_{z}(p)=S_{z}(p)-D_{z}(p) \tag{5}
\end{equation*}
$$

is the excess supply for good $z$. Solving $Q_{z}(p)=0$ for all $z$ is thus akin to finding a vector of prices $p$ which clears the markets for all $n$ goods simultaneously.

Jacobi's algorithm is a method to solve such a system. It consists of taking an initial guess $p^{0}$ and defining a sequence $\left(p^{t}\right)$ iteratively according to

$$
\begin{equation*}
p_{z}^{t+1}: \quad Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{6}
\end{equation*}
$$

Here $p_{-z}$ denotes the vector $p$ without its $z^{\text {th }}$ entry, and $\left(\pi, p_{-z}\right)$ the vector $p$ with its $z^{\text {th }}$ entry replaced by $\pi$. The mapping $T: p^{t} \mapsto p^{t+1}$ is called the coordinate update or Jacobi update operator. To ensure that this operator is well-defined, we shall assume throughout:

Assumption 2.2 (Responsiveness). For all $z$,

$$
\begin{equation*}
\inf _{\pi} Q_{z}\left(\pi, p_{-z}\right)<0<\sup _{\pi} Q_{z}\left(\pi, p_{-z}\right), \quad \forall p_{-z} \tag{7}
\end{equation*}
$$

We also remove any ambiguity in choosing $p_{z}^{t+1}$ by setting precisely

$$
\begin{equation*}
p_{z}^{t+1}=\min \left\{\pi: Q_{z}\left(\pi, p_{-z}^{t}\right)=0\right\} \tag{8}
\end{equation*}
$$

Jacobi's algorithm has an intuitive economic interpretation. Let's assume that each good $z$ has an auctioneer in charge of determining its "right" price $p_{z}$. At each period, the auctioneer for good $z$ sets $p_{z}$ in order to clear the corresponding market, but using the prices from the previous period (it is as if each auctioneer did not anticipate that other prices were being updated simultaneously). Because of this, once the simultaneous price updates are taken
into account, the price chosen by the auctioneer is in fact typically not market clearing. This process is then re-iterated until the prices converge.

As an illustration, consider the regularized optimal transport problem

$$
\begin{aligned}
\max _{\mu \geq 0} & \sum_{x y \in X \times Y} \mu_{x y} \Phi_{x y}-\sum_{x y \in X \times Y} \mu_{x y} \log \mu_{x y} \\
\text { s.t. } & \sum_{y \in Y} \mu_{x y}=n_{x}, \quad \sum_{x \in X} \mu_{x y}=m_{y}
\end{aligned}
$$

which has solutions of the form: $\mu_{x y}=\exp \left(\Phi_{x y}-u_{x}-v_{y}\right)$. A common interpretation is that of a two-sided matching market between workers $x$ and firms $y$ who respectively ask for utility $u_{x}$ and $v_{y}$. We will come back to this problem and its interpretation in section 3.

A standard procedure to solve this type of problem is Sinkhorn's algorithm, which is nothing else than Jacobi's algorithm adapted to this special case.

## Sinkhorn's algorithm

Take an initial guess for $u^{0}$ and $v^{0}$, and set for $t \geq 0$ :

$$
\left\{\begin{aligned}
u_{x}^{t+1}: & n_{x}=\sum_{y} \exp \left(\Phi_{x y}-u_{x}^{t+1}-v_{y}^{t}\right) \\
v_{y}^{t+1}: & m_{y}=\sum_{x} \exp \left(\Phi_{x y}-u_{x}^{t}-v_{y}^{t+1}\right)
\end{aligned}\right.
$$

until approximate convergence is reached. (Notice that here, $u^{2 t}$ and $v^{2 t+1}$ depend exclusively on the starting point $u^{0}$, while $u^{2 t+1}$ and $v^{2 t}$ depend exclusively on the starting point $v^{0}$.)

It is easy to see that by defining $p_{x}=-u_{x}, p_{y}=v_{y}$, as well as

$$
\begin{aligned}
& Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x} \\
& Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}
\end{aligned}
$$

we can rewrite Sinkhorn's algorithm exactly as (6).

Note that $Q_{x}$ is an antitone function with respect to $p_{-x}$ (i.e. nonincreasing with respect to the componentwise order), and similarly $Q_{y}$ is an antitone function with respect to $p_{-y}$. We will see below how this property plays an important role in Jacobi's algorithm.

One important question remains: does the Jacobi sequence $\left(p^{t}\right)$ converge? Although this is not the case in general, this sequence does converge when the model exhibits several features related to substitutability. The rest of this section will be dedicated to defining exactly what we mean by substitutability, and to studying this category of models - and notably the behavior of the Jacobi sequence.

### 2.2 Nondecreasing Jacobi sequence

The convergence of the Jacobi sequence will rely on the notion of subsolution, that we define as follows:

Definition 2.1. We say that $p$ is a subsolution if $Q(p) \leq 0$, and that $p$ is a supersolution if $Q(p) \geq 0$.

Broadly speaking, we expect to interpret a subsolution as "prices are too low," and a supersolution as "prices are too high." We shall develop this intuition below.

Let $p^{t}$ be a subsolution and assume $p^{t+1}$ exists, so that

$$
\begin{equation*}
Q_{z}\left(p_{z}^{t}, p_{-z}^{t}\right) \leq 0, \quad Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{9}
\end{equation*}
$$

Then we can guarantee that $p^{t} \leq p^{t+1}$ using:

Assumption 2.3 (Diagonal isotonicity). $Q_{z}(p)$ is nondecreasing in $p_{z}$.

We state this result formally:

Proposition 2.1. Assume $Q$ is diagonal isotone. If $p^{t}$ is a subsolution, then $p^{t} \leq p^{t+1}$.

Proof. $Q_{z}\left(p_{z}^{t}, p_{-z}^{t}\right) \leq 0=Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)$ and $Q_{z}$ is increasing in $p_{z}$.

Next, we can guarantee that $p^{t+1}$ is still a subsolution with:

Assumption 2.4 (Z-function). $Q_{z}\left(p_{z}, p_{-z}\right)$ is antitone with respect to $p_{-z}$, i.e. $p_{-z} \leq p_{-z}^{\prime}$ implies $Q_{z}\left(p_{z}, p_{-z}\right) \geq Q_{z}\left(p_{z}, p_{-z}^{\prime}\right)$.

In economic terms, $Q$ being a Z-function means that when the price of any other good increases, the excess supply for good $z$ should decrease. This can be explained by a standard substitution pattern: if all prices but $p_{z}$ increase, then producers should supply less good $z$, while consumers should demand more good $z$. For this reason, we also say that $Q$ has the substitutes property.

With the Z-function assumption we have:

Proposition 2.2. Assume $Q$ is a diagonal isotone $Z$-function. If $p^{t}$ is a subsolution, then $p^{t+1}$ is also a subsolution.

Proof. We have $p^{t} \leq p^{t+1}$ by diagonal isotonicity, so in particular $p_{-z}^{t} \leq p_{-z}^{t+1}$ for any $z$. Hence, since $Q_{z}$ is antitone with respect to $p_{-z}, Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t+1}\right) \leq$ $Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0$.

The immediate consequence of propositions 2.1 and 2.2 is that, with $Q$ satisfying the assumptions above, any Jacobi sequence starting from a subsolution will be nondecreasing. Yet, as the following example shows, this is still not sufficient to ensure convergence.

Example 2.1. Consider a linear $Q(p)$ given by

$$
Q(p)=\left(\begin{array}{cc}
1 & -2 \\
-2 & 1
\end{array}\right) p
$$

The Jacobi sequence starting from $p^{0}$ can be written explicitly as

$$
\left\{\begin{array}{l}
p_{1}^{t}=2^{t} p_{2}^{0} \\
p_{2}^{t}=2^{t} p_{1}^{0}
\end{array}\right.
$$

Even though $p^{0}=(1,1)$ is a subsolution, and $Q$ is a continuous diagonal isotone Z-function, the associated Jacobi sequence does not converge to the unique solution $(0,0)$. In fact, it is clear from the expressions of $p_{1}^{t}$ and $p_{2}^{t}$ that any Jacobi sequence starting from a vector other than $(0,0)$ will diverge.

### 2.3 M- and $\mathrm{M}_{0}$-functions

Example 2.1 shows what went wrong: the function $Q$ allowed for an inversion by allowing the subsolution $(1,1)$ to be above the solution $(0,0)$. Recall that we expect subsolution to mean "prices are too low" and supersolution "prices are too high," and therefore we wish to rule out such inversions. We do so using the following notions, defined in Galichon, Samuelson and Vernet (2022):

Definition 2.2. Consider $Q: \mathbb{R}^{n} \rightarrow \mathbb{R}^{n}$. We say that:

(i) $Q$ is strongly nonreversing if

$$
\left\{\begin{array}{l}
p \geq p^{\prime}  \tag{10}\\
Q(p) \leq Q\left(p^{\prime}\right)
\end{array} \quad \text { implies } p=p^{\prime}\right.
$$

(ii) $Q$ is weakly nonreversing if

$$
\left\{\begin{array}{l}
p \geq p^{\prime}  \tag{11}\\
Q(p) \leq Q\left(p^{\prime}\right) \quad \text { implies } Q(p)=Q\left(p^{\prime}\right)
\end{array}\right.
$$

Economically speaking, $Q$ being nonreversing means that when prices increase, the excess supply cannot decrease for all goods. In other words, it ensures that the price effect remains stronger than the substitution effect.

Example 2.2. Consider $Q(p)=Q p$ with $Q$ an $n \times n$ matrix. If $Q$ is weakly (column) diagonally dominant (i.e. $1^{\top} Q \geq 0$ ), then $Q$ is weakly nonreversing. If it is strictly (column) diagonally dominant (i.e. if $1^{\top} Q>0$ ), then $Q$ is strongly nonreversing.

Example 2.3. Consider $Q$ such that $1^{\top} Q(p)$ is weakly isotone in $p$. Then it is weakly nonreversing. In particular, this is the case of $Q: \mathbb{R}^{X \cup Y} \rightarrow \mathbb{R}^{X \cup Y}$ given by

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x}, \quad x \in X  \tag{12}\\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}, \quad y \in Y
\end{array}\right.
$$

Example 2.4. Consider $Q$ such that $1^{\top} Q(p) \leq 1^{\top} Q\left(p^{\prime}\right)$ and $p \geq p^{\prime}$ together imply $p=p^{\prime}$. Then it is strongly nonreversing. In particular, this is the case of $Q: \mathbb{R}^{X \cup Y} \rightarrow \mathbb{R}^{X \cup Y}$ given by

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+\exp \left(p_{x}\right)-n_{x}, \quad x \in X \\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-\exp \left(-p_{y}\right)+m_{y}, \quad y \in Y
\end{array}\right.
$$

Next we define M- and $\mathrm{M}_{0}$-functions as Z-functions which are also nonreversing:

Definition 2.3. An M-function is a Z-function which is strongly nonreversing. An $M_{0}$-function is a $Z$-function which is weakly nonreversing.

Clearly, M-functions constitute a subset of $\mathrm{M}_{0}$-functions since strong nonreversingness implies weak nonreversingness. In economic terms, M- and $\mathrm{M}_{0}$ functions exhibit both the substitutes property (which they inherit from Zfunctions), and the property of having a price effect stronger than the substitution effect.

The combination of these two properties implies that $\mathrm{M}_{0}$-functions (and therefore M-functions also) are diagonal isotone, so that M- and $\mathrm{M}_{0}$-functions satisfy assumptions 2.3 and 2.4 .

Proposition 2.3. Assume $Q$ is an $M_{0}$-function, then it is diagonal isotone.

Proof. Let $p$ and $p^{\prime}$ such that $p_{z} \leq p_{z}^{\prime}$ and $p_{-z}=p_{-z}^{\prime}$. Looking for a contradiction, suppose that $Q_{z}(p)>Q_{z}\left(p^{\prime}\right)$.

For any $\tilde{z} \neq z$ we have $p_{\tilde{z}}=p_{\tilde{z}}^{\prime}$ and $p_{-\tilde{z}} \leq p_{-\tilde{z}}^{\prime}$, so since $Q$ is a Z-function,

$$
Q_{\tilde{z}}(p)=Q_{\tilde{z}}\left(p_{\tilde{z}}, p_{-\tilde{z}}\right) \geq Q_{\tilde{z}}\left(p_{\tilde{z}}, p_{-\tilde{z}}^{\prime}\right)=Q_{\tilde{z}}\left(p^{\prime}\right)
$$

Hence $p \leq p^{\prime}$ and $Q(p) \geq Q\left(p^{\prime}\right)$, therefore $Q(p)=Q\left(p^{\prime}\right)$ by weak nonreversingness. We have a contradiction: in fact $Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)$.

## Galichon, Samuelson and Vernet (2022) characterize M-functions using:

Theorem 2.1 (Inverse isotonicity theorems). Consider $Q$ a Z-function. Then:

(i) $Q$ is an $M$-function if and only if it is inverse isotone, i.e.

$$
Q(p) \leq Q\left(p^{\prime}\right) \text { implies } p \leq p^{\prime}
$$

(ii) $Q$ is an $M_{0}$-function if and only if the set-valued map $Q^{-1}$ is isotone in the strong set order, i.e.

$$
Q(p) \leq Q\left(p^{\prime}\right) \text { implies }\left\{\begin{array}{l}
Q(p)=Q\left(p \wedge p^{\prime}\right) \\
Q\left(p^{\prime}\right)=Q\left(p \vee p^{\prime}\right)
\end{array}\right.
$$

We recall that $p \wedge p^{\prime}$ denotes the join (componentwise minimum) of two vectors $p$ and $p^{\prime}$, while $p \vee p^{\prime}$ denotes their meet (componentwise maximum).

Proof. (i) Assume $Q$ is an M-function and $Q(p) \leq Q\left(p^{\prime}\right)$. Then $p \vee p^{\prime} \geq p^{\prime}$ and

$$
Q_{z}\left(p \vee p^{\prime}\right) \leq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)
$$

therefore we conclude that $p^{\prime}=p \vee p^{\prime}$, and thus $p \leq p^{\prime}$. Conversely, assume $Q$ is inverse isotone. To show it is strongly nonreversing, assume $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. By inverse isotonicity $p \leq p^{\prime}$, hence $p=p^{\prime}$.

(ii) Assume $Q$ is an $\mathrm{M}_{0}$-function and $Q(p) \leq Q\left(p^{\prime}\right)$. Then $p \vee p^{\prime} \geq p^{\prime}$ and

$$
Q_{z}\left(p \vee p^{\prime}\right) \leq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)
$$

therefore we conclude that $Q\left(p \vee p^{\prime}\right)=Q\left(p^{\prime}\right)$. Similarly, $p \geq p \wedge p^{\prime}$ and

$$
Q_{z}\left(p \wedge p^{\prime}\right) \geq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}(p)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right) \geq Q_{z}(p)
$$

thus $Q\left(p \wedge p^{\prime}\right)=Q(p)$. Conversely, assume $Q^{-1}$ is isotone in the strong set order. To show that $Q$ is weakly nonreversing, assume $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. The former implies $p \wedge p^{\prime}=p^{\prime}$, and the latter $Q(p)=Q\left(p \wedge p^{\prime}\right)$.

Corollary. Assume $Q$ is an $M_{0}$-function, then the set of solutions is stable by the join and meet operations $\wedge$ and $\vee$.

### 2.4 Convergence of the Jacobi sequence

When $Q$ is an $\mathrm{M}$ - or $\mathrm{M}_{0}$-function, inversions such as the one we saw in example 2.1 are ruled out. In this case, as long as a sub- and a supersolution exist, we can find a Jacobi sequence which converges towards a solution.

Ortega and Rheinboldt (1970) prove the two following results for M-functions.

Theorem 2.2. Assume $Q$ is a continuous responsive $M$-function, and that both a sub- and a supersolution exist. Then a solution exists and it is unique, and any Jacobi sequence starting from a sub- or supersolution converges to this unique solution.

Proof. The proof consists in considering two Jacobi sequences $\left(\hat{p}^{t}\right)$ and $\left(\check{p}^{t}\right)$ starting from respectively a sub- and a supersolution. ( $\left.\hat{p}^{t}\right)$ is an increasing sequence of subsolutions, $\left(\check{p}^{t}\right)$ is a decreasing sequence of supersolutions, and by inverse isotonicity, one has $\hat{p}^{t} \leq \check{p}^{t}$, and therefore they both converge to respectively $p$ and $p^{\prime} . Q(p)=Q\left(p^{\prime}\right)=0$ and inverse isotonicity applied twice yields $p=p^{\prime}$.

If $Q$ is surjective, then we need not even start from a sub- or supersolution.

Theorem 2.3. Assume $Q$ is also surjective. Then any Jacobi sequence converges to the unique solution.

Proof. Let $\left(p^{t}\right)$ be the Jacobi sequence starting from a vector $p^{0}$. Since $Q$ is surjective, there exist $\hat{p}^{0}$ such that $Q\left(\hat{p}^{0}\right)=Q\left(p^{0}\right) \wedge 0$, and $\check{p}^{0}$ such that $Q\left(\check{p}^{0}\right)=Q\left(p^{0}\right) \vee 0$. Then $\hat{p}^{0}$ is a subsolution, $\check{p}^{0}$ is a supersolution, and the Jacobi sequences $\left(\hat{p}^{t}\right)$ and $\left(\check{p}^{t}\right)$ starting from these respective vectors are such that

$$
\hat{p}^{t} \leq p^{t} \leq \check{p}^{t}
$$

with $\left(\hat{p}^{t}\right)$ increasing and $\left(\check{p}^{t}\right)$ decreasing. As a result, all three sequences converge, and their limits are solutions.

Finally, Galichon and Léger (2023) obtain the following result for $\mathrm{M}_{0}$-functions.

Theorem 2.4. Assume $Q$ is an $M_{0}$-function, and that both a sub- and a supersolution exist. Then a solution exists and can be obtained as the limit of the Jacobi sequence starting from the meet (or the join) of a subsolution and a supersolution.

Proof. Let $\check{p}$ be a subsolution and $\hat{p}$ a supersolution. Then $Q(\check{p}) \leq Q(\hat{p})$, therefore the inverse isotonicity characterization of $\mathrm{M}_{0}$-functions implies $Q(\check{p} \wedge \hat{p})=$ $Q(\check{p})$ and $Q(\check{p} \vee \hat{p})=Q(\hat{p})$. Hence $\check{p} \wedge \hat{p}$ is a subsolution and $\check{p} \vee \hat{p}$ is a supersolution. Consider $\left(\underline{p}^{t}\right)$ and $\left(\bar{p}^{t}\right)$ the Jacobi sequences starting respectively from $\underline{p}^{0}=\check{p} \wedge \hat{p}$ and $\bar{p}^{0}=\check{p} \vee \hat{p}$, so that $\underline{p}^{0} \leq \bar{p}^{0}$. We show by induction that $\underline{p}^{t} \leq \bar{p}^{t}$. Looking for a contradiction, assume that $\underline{p}_{z}^{t+1}>\bar{p}_{z}^{t+1}$ for some $z$. Then

$$
0=Q_{z}\left(\underline{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right) \geq Q_{z}\left(\bar{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right) \geq Q_{z}\left(\bar{p}_{z}^{t+1}, \bar{p}_{-z}^{t}\right)=0
$$

by diagonal isotonicity and the Z-function property. Hence $Q_{z}\left(\underline{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right)=$ $Q_{z}\left(\bar{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right)=0$ but $\underline{p}_{z}^{t+1}>\bar{p}_{z}^{t+1}$, which contradicts the definition (8) of $\underline{p}_{z}^{t+1}$ as the smallest solution to $Q_{z}\left(\pi, \underline{p}_{-z}^{t}\right)=0$. Thus $\left(\underline{p}^{t}\right)$ is increasing, $\left(\bar{p}^{\bar{t}}\right)$ is decreasing, and $\underline{p}^{t} \leq \bar{p}^{t}$, therefore both sequences are bounded and have a limit. Hence a solution exists.

We now consider some examples around constant aggregates, i.e. the property that $1^{\top} Q(p)=\sum_{z} Q_{z}(p)$ is constant for all $p$.

Proposition 2.4. Assume $Q$ is a continuous $Z$-function with $1^{\top} Q(p)=0$, and that there is a $0 \in Z$ such that the restriction and corestriction of $Q$ to $\mathbb{R}^{Z \backslash\{0\}}$ with the normalization $p_{0}=\pi$, denoted $Q_{-0}: \mathbb{R}^{Z \backslash\{0\}} \rightarrow \mathbb{R}^{Z \backslash\{0\}}$, is a surjective $M$-function. Then, denoting $p(\pi)$ the unique solution to $Q_{-0}(p)=0$, one has that $\pi \leq \pi^{\prime}$ implies $p(\pi) \leq p\left(\pi^{\prime}\right)$.

Example 2.5. Consider the case of regularized optimal transport:

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x} \\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}
\end{array}\right.
$$

so that $1^{\top} Q(p)=\sum_{y} m_{y}-\sum_{x} n_{x}$ is constant. It is easy to see that $Q$ is a Z-function. In addition, because of constant aggregates, $Q(p) \leq Q\left(p^{\prime}\right)$ implies $Q(p)=Q\left(p^{\prime}\right)$ so $Q$ is weakly nonreversing, thus it is an $M_{0}$-function. However, $Q$ is not an $M$-function: take for instance $p=p^{\prime}+1_{Z}$, then we have $p \geq p^{\prime}$ and $Q(p)=Q\left(p^{\prime}\right)$, but $p \neq p^{\prime}$ so $Q$ is not strongly nonreversing.

Example 2.6. Consider a linear $Q(p)=(\Delta-A) p$ where $\Delta$ is a diagonal matrix with positive entries, A has a zero diagonal and positive off-diagonal entries, and

$$
1^{\top}(\Delta-A)=0
$$

so that the function $Q$ has constant aggregates. Then the matrix $\Delta^{-1} A$ is nonnegative and irreducible (it is strongly connected), and the Perron-Frobenius theorem applies. Letting $\delta=\Delta 1$, we have $\delta \geq 0$ and $\delta^{\top}=1^{\top} A=\delta^{\top} \Delta^{-1} A$, so $\delta$ must be the left Perron eigenvector of $\Delta^{-1} A$, and it is associated to the Perron eigenvalue 1. Thus there is also a right Perron eigenvector $v \geq 0$ such that $\Delta^{-1} A v=v$, i.e. $Q(v)=(\Delta-A) v=0$.

### 2.5 Application: a toy hedonic model

Consider a surge pricing problem in an Uber-like environment. We have partitioned the city in a finite number of locations (say, blocks). Let $x \in X$ denote the location of the driver, $y \in Y$ the location of the passenger, and $z \in Z$ the pickup location. Assume that for a driver at $x$, the cost of picking up a passenger at $z$ is $c_{x z}$. If the price of the ride at $z$ is $p_{z}$, the utility of the driver is $p_{z}-c_{x z}+\varepsilon_{z}$, where the vector $\left(\varepsilon_{z}\right)$ is random. If the driver does not pick up anyone, the utility is normalized to $\varepsilon_{0}$. Assume that $\left(\varepsilon_{z}\right)$ is i.i.d. Gumbel. Then the probability that a driver at $x$ will demand a ride $z$ is

$$
\begin{equation*}
\frac{\exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z^{\prime}} \exp \left(p_{z^{\prime}}-c_{x z^{\prime}}\right)} \tag{13}
\end{equation*}
$$

Now assume there are $n_{x}$ drivers in area $x$, therefore the supply for rides at $z$ is

$$
\begin{equation*}
S_{z}(p)=\sum_{x \in X} n_{x} \frac{\exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z^{\prime}} \exp \left(p_{z^{\prime}}-c_{x z^{\prime}}\right)} \tag{14}
\end{equation*}
$$

It is easy to see that $S_{z}(p)$ is decreasing with respect to $p_{z^{\prime}}$ for $z^{\prime} \neq z$.

Now let's focus on demand. This is the same as before, except for the fact that the utility of a passenger at $y$ seeking a ride at location $z$ is now $a_{y z}-p_{z}+\eta_{z}$, and the utility of the outside option is $\eta_{0}$, where $\left(\eta_{z}\right)$ is i.i.d. Gumbel. Assuming there are $m_{y}$ passengers in area $y$, the induced demand is

$$
\begin{equation*}
D_{z}(p)=\sum_{y \in Y} m_{y} \frac{\exp \left(a_{y z}-p_{z}\right)}{1+\sum_{z^{\prime}} \exp \left(a_{y z^{\prime}}-p_{z^{\prime}}\right)} \tag{15}
\end{equation*}
$$

and we see that $-D_{z}(p)$ is also decreasing with respect to $p_{z^{\prime}}$ for $z^{\prime} \neq z$.

The excess supply function $Q$ is defined with

$$
Q_{z}(p)=S_{z}(p)-D_{z}(p)
$$

It is clearly continuous, and it is a Z-function as the sum of two Z-functions. Let's show that it is also strongly nonreversing, and therefore an M-function. The aggregates of $Q(p)$ are

$$
\sum_{z} Q_{z}(p)=\sum_{x \in X} n_{x} \frac{\sum_{z} \exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z} \exp \left(p_{z}-c_{x y}\right)}-\sum_{y \in Y} m_{y} \frac{\sum_{z} \exp \left(a_{y z}-p_{z}\right)}{1+\sum_{z} \exp \left(a_{y z}-p_{z}\right)}
$$

which we see are strictly isotone in $p: p \geq p^{\prime}$ implies $\sum_{z} Q_{z}(p) \geq \sum_{z} Q_{z}\left(p^{\prime}\right)$, and if $p \neq p^{\prime}$ then the inequality is strict. Suppose then that we have $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. Because aggregates are isotone, we must have $Q(p)=Q\left(p^{\prime}\right)$. Furthermore, if we had $p \neq p^{\prime}$, then we would have $\sum_{z} Q_{z}(p)>\sum_{z} Q_{z}\left(p^{\prime}\right)$. But this contradicts $Q(p)=Q\left(p^{\prime}\right)$, hence actually $p=p^{\prime}$.

Finally, note that when all $p_{z}=k$ and $k \rightarrow+\infty, Q_{z}(p) \geq 0$; while when all $p_{z}=k$ and $k \rightarrow-\infty$ we have $Q_{z}(p) \leq 0$. As a result both a super- and a subsolution exist, and therefore theorem 2.2 guarantees that the problem has a unique solution which can be reached as the limit of a Jacobi sequence starting from any sub- or supersolution.

### 2.6 References and notes

This section draws upon the book by Ortega and Rheinboldt $(1970)$, the papers by Berry, Gandhi and Haile (2013) and Galichon. Kominers and Weber (2019). It also builds on the working papers by Galichon, Samuelson and Vernet (2022), Galichon and Léger (2023), and Chen. Choo. Galichon and Weber (2021).

## 3 Models of matching with transfers

In this section we shall look specifically at models which formulate as

$$
\left\{\begin{array}{l}
\sum_{y \in Y} M_{x y}\left(a_{x}, b_{y}\right)+M_{x 0}\left(a_{x}\right)=n_{x} \\
\sum_{x \in X} M_{x y}\left(a_{x}, b_{y}\right)+M_{0 y}\left(b_{y}\right)=m_{y}
\end{array}\right.
$$

where $M_{x y}\left(a_{x}, b_{y}\right)$ is continuous and increasing in $a_{x}$ and $b_{y}$, and will stand for the number of matches between types $x$ and $y$; and $M_{x 0}\left(a_{x}\right)$ and $M_{0 y}\left(b_{y}\right)$ are also continuous and will stand for the number of unmatched agents of type $x$ and $y$, respectively.

At the end of this section we will show how this framework extends to the full assignment case, i.e. when $M_{x 0}\left(a_{x}\right)=M_{0 y}\left(b_{y}\right)=0$. Optimal transport falls into this category, as seen with Sinkhorn's algorithm in section 2.

### 3.1 Microfoundation of the matching model

We will consider as illustration a matching model between workers (CEOs) and firms with taxes. There are $n_{x}$ workers of type $x \in X$ and $m_{y}$ firms of type $y \in Y$. Assume that firms pay their worker a gross wage $w$, from which the worker receives the net wage $N(w)$. In typical progressive taxation fashion, $N$ is increasing, concave, and piecewise affine. We can thus represent it as

$$
\begin{equation*}
N(w)=\min _{k=0, \ldots, K}\left(1-\tau_{k}\right)\left(w-w_{k}\right) \tag{16}
\end{equation*}
$$

where $\tau_{k}$ is the marginal tax rate in the $k^{\text {th }}$ tax bracket: $\tau_{0}=0<\tau_{1}<\cdots<\tau_{K}$. If there are no taxes, then we simply have $N(w)=w$.

If matched with a firm $y$, a worker $x$ gets utility

$$
\alpha_{x y}+N\left(w_{x y}\right)+\sigma \varepsilon_{y}
$$

where $\alpha_{x y}$ is worker $x$ 's monetary valuation of job $y$ 's amenities; $N\left(w_{x y}\right)$ is the net wage of worker $x$ working for firm $y$; and $\varepsilon_{y}$ is a random utility. If unmatched, a worker $x$ gets utility $\sigma \varepsilon_{0}$. Hence worker $x$ 's problem is to choose a firm $y$ with

$$
\max _{y \in Y}\left\{\alpha_{x y}+N\left(w_{x y}\right)+\sigma \varepsilon_{y}, \sigma \varepsilon_{0}\right\}
$$

We assume that $\left(\varepsilon_{y}\right)$ is i.i.d. Gumbel. As a result, the expected indirect utility of a worker of type $x$ is

$$
u_{x}=\sigma \log \left(1+\sum_{y} \exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)}{\sigma}\right)\right)
$$

and the probability that worker $x$ picks firm $y$ is

$$
\begin{equation*}
\frac{\mu_{x y}}{n_{x}}=\frac{\exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)}{\sigma}\right)}{1+\sum_{y^{\prime}} \exp \left(\frac{\alpha_{x y^{\prime}}+N\left(w_{x y}^{\prime}\right)}{\sigma}\right)}=\exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)-u_{x}}{\sigma}\right) \tag{17}
\end{equation*}
$$

On firm $y$ 's side, the problem is to choose a worker $x$ with

$$
\max _{x \in X}\left\{\gamma_{x y}-w_{x y}+\sigma \eta_{x}, \sigma \eta_{0}\right\}
$$

where $\gamma_{x y}$ is the value of worker $x$ for firm $y$, and $\eta_{x}$ is the random utility. We assume that $\left(\eta_{x}\right)$ is also i.i.d. Gumbel, so that the expected indirect utility of a firm of type $y$ is

$$
v_{y}=\sigma \log \left(1+\sum_{x} \exp \left(\frac{\gamma_{x y}-w_{x y}}{\sigma}\right)\right)
$$

and the probability that firm $y$ picks worker $x$ is

$$
\begin{equation*}
\frac{\mu_{x y}}{m_{y}}=\exp \left(\frac{\gamma_{x y}-w_{x y}-v_{y}}{\sigma}\right) \tag{18}
\end{equation*}
$$

Lastly, the probabilities that worker $x$ or firm $y$ remains unmatched are respectively:

$$
\begin{equation*}
\frac{\mu_{x 0}}{n_{x}}=\exp \left(-\frac{u_{x}}{\sigma}\right), \quad \frac{\mu_{0 y}}{m_{y}}=\exp \left(-\frac{v_{y}}{\sigma}\right) \tag{19}
\end{equation*}
$$

Equations (17), (18) and (19), together with the feasibility conditions

$$
\begin{equation*}
\sum_{y \in Y} \mu_{x y}+\mu_{x 0}=n_{x}, \quad \sum_{x \in X} \mu_{x y}+\mu_{0 y}=m_{y} \tag{20}
\end{equation*}
$$

form a system of equations with unknowns $\mu_{x y}, \mu_{x 0}, \mu_{0 y}, u_{x}, v_{y}$ and $w_{x y}$. Our strategy to solve this system will consist of three steps. First, we will eliminate $w_{x y}$ in order to express $\mu_{x y}$ as a function of $u_{x}$ and $v_{y}$ only, using the distanceto-frontier function. Second, we will solve for $u_{x}$ and $v_{y}$ with Jacobi's algorithm. Finally, we will recover $\mu_{x y}, \mu_{x 0}, \mu_{0 y}$ and $w_{x y}$ from $u_{x}$ and $v_{y}$.

### 3.2 Distance-to-frontier function

The wage $w_{x y}$ is a way to transfer systematic utility from one partner to the other. After transfer, the systematic utilities of both partners in a match $x y$ are

$$
\begin{cases}\text { for } x, & U_{x y}=\alpha_{x y}+N\left(w_{x y}\right) \\ \text { for } y, & V_{x y}=\gamma_{x y}-w_{x y}\end{cases}
$$

More generally, we will consider models in which $(U, V)$ belongs to a feasible set $\mathcal{F}_{x y}$, and we shall make two assumptions on $\mathcal{F}_{x y}$. The first one, free disposal, means that agents can dispose of utility at will.

Assumption 3.1 (Free disposal). If $(U, V) \in \mathcal{F}_{x y}$, then for any $U^{\prime} \leq U$ and $V^{\prime} \leq V$ we have $\left(U^{\prime}, V^{\prime}\right) \in \mathcal{F}_{x y}$.

The second one, scarcity, means that one partner cannot have an arbitrarily large level of utility without a negative effect on the utility of the other partner.

Assumption 3.2 (Scarcity). If $\left(U^{n}\right)$ and $\left(V^{n}\right)$ are two sequences such that $U^{n} \rightarrow+\infty$ and $V^{n}$ is bounded below, then for $N$ large enough $\left(U^{n}, V^{n}\right) \notin \mathcal{F}_{x y}$ for $n \geq N$; and similarly for $U^{n}$ bounded below and $V^{n} \rightarrow+\infty$.

We will describe the feasible set $\mathcal{F}_{x y}$ using the distance-to-frontier function:

$$
\begin{equation*}
D_{x y}(U, V)=\min \left\{t \in \mathbb{R}:(U-t, V-t) \in \mathcal{F}_{x y}\right\} \tag{21}
\end{equation*}
$$

This function encodes the feasible set in the following sense. If the utility profile $(U, V)$ is outside the feasible set, then the distance is positive: $D_{x y}(U, V)>0$. Conversely, if $(U, V)$ is in the interior of the feasible set, then the distance is negative: $D_{x y}(U, V)<0$. Only when $(U, V)$ is exactly on the frontier is the distance zero.

We mention two other useful properties of the distance-to-frontier function, before looking at this function on two examples.

## Proposition 3.1.

(i) For $F_{1}$ and $F_{2}$ two elementary sets,

$$
D_{F_{1} \cap F_{2}}=\max \left\{D_{F_{1}}, D_{F_{2}}\right\} \quad \text { and } \quad D_{F_{1} \cup F_{2}}=\min \left\{D_{F_{1}}, D_{F_{2}}\right\}
$$

(ii) Translation invariance: $D(U+t, V+t)=t+D(U, V)$.

Example 3.1 (Transferable utility). In this case

$$
\mathcal{F}_{x y}=\left\{(U, V) \in \mathbb{R}^{2}: U+V \leq \Phi_{x y}\right\}
$$

so the minimum $t$ such that $(U-t, V-t) \in \mathcal{F}_{x y}$ verifies $(U-t)+(V-t)=\Phi_{x y}$, hence

$$
D_{x y}(U, V)=\frac{U+V-\Phi_{x y}}{2}
$$

Example 3.2 (Piecewise linear taxes). In this case $U \leq \alpha_{x y}+N\left(w_{x y}\right)$ and $V \leq \gamma_{x y}-w_{x y}$, so that

$$
\begin{aligned}
\mathcal{F}_{x y} & =\left\{(U, V) \in \mathbb{R}^{2}: N\left(\gamma_{x y}-V\right) \geq U-\alpha_{x y}\right\} \\
& =\left\{(U, V): \min _{k=0, \ldots, K}\left(1-\tau_{k}\right)\left(\gamma_{x y}-V-w_{k}\right) \geq U-\alpha_{x y}\right\} \\
& =\bigcap_{k}\left\{(U, V):\left(1-\tau_{k}\right)\left(\gamma_{x y}-V-w_{k}\right) \geq U-\alpha_{x y}\right\}
\end{aligned}
$$

Hence $D_{x y}(U, V)=\max _{k} D_{x y}^{k}(U, V)$, where

$$
D_{x y}^{k}(U, V)=\frac{U-\alpha_{x y}+\left(1-\tau_{k}\right)\left(V-\gamma_{x y}+w_{k}\right)}{2-\tau_{k}}
$$

### 3.3 Matching equilibrium

Now back to the matching model, recall that we had

$$
\frac{\mu_{x y}}{n_{x}}=\exp \left(\frac{U_{x y}-u_{x}}{\sigma}\right), \quad \frac{\mu_{x y}}{m_{y}}=\exp \left(\frac{V_{x y}-v_{y}}{\sigma}\right)
$$

where $U_{x y}$ and $V_{x y}$ denote the systematic parts of utility in a match $x y$. Solving for $U_{x y}$ and $V_{x y}$ yields

$$
U_{x y}=u_{x}+\sigma \log \frac{\mu_{x y}}{n_{x}}, \quad V_{x y}=v_{y}+\sigma \log \frac{\mu_{x y}}{m_{y}}
$$

We assume that the market is large, so that every type of match $x y$ must be occurring. Then $D_{x y}\left(U_{x y}, V_{x y}\right)=0$ for all $x y$. Replacing $U_{x y}$ and $V_{x y}$ by their expressions above, we get

$$
D_{x y}\left(u_{x}+\sigma \log \frac{\mu_{x y}}{n_{x}}, v_{y}+\sigma \log \frac{\mu_{x y}}{m_{y}}\right)=0
$$

The translation invariance property yields

$$
\sigma \log \mu_{x y}+D_{x y}\left(u_{x}-\sigma \log n_{x}, v_{y}-\sigma \log m_{y}\right)=0
$$

Thus we have eliminated $w_{x y}$ by combining equations (17) and (18), and we are able to express $\mu_{x y}, \mu_{x 0}$ and $\mu_{0 y}$ as functions of $u_{x}$ and $v_{y}$ only:

$$
\begin{gathered}
\mu_{x y}=\exp \left(-\frac{D_{x y}\left(u_{x}-\sigma \log n_{x}, v_{y}-\sigma \log m_{y}\right)}{\sigma}\right) \\
\mu_{x 0}=\exp \left(-\frac{u_{x}-\sigma \log n_{x}}{\sigma}\right), \quad \mu_{0 y}=\exp \left(-\frac{v_{y}-\sigma \log m_{y}}{\sigma}\right)
\end{gathered}
$$

Next we want to solve for $u_{x}$ and $v_{y}$ using Jacobi's algorithm. Introduce $p_{x}=-\left(u_{x}-\sigma \log n_{x}\right)$ and $p_{y}=v_{y}-\sigma \log m_{y}$, and substitute the expressions of $\mu_{x y}, \mu_{x 0}$ and $\mu_{0 y}$ above in the feasibility conditions (20) to obtain the system:

$$
\left\{\begin{array}{l}
\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(p_{x} / \sigma\right)=n_{x}  \tag{22}\\
\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(-p_{y} / \sigma\right)=m_{y}
\end{array}\right.
$$

We define the function $Q$ using

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(p_{x} / \sigma\right)-n_{x} \\
Q_{y}(p)=-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)-\exp \left(-p_{y} / \sigma\right)+m_{y}
\end{array}\right.
$$

so that the system (22) rewrites as $Q(p)=0$. One can then check that $Q$ is a continuous M-function (it is a Z-function with strictly isotone aggregates).

We also have:

Proposition 3.2. The problem $Q(p)=0$ has a sub- and a supersolution.

Proof. To get a supersolution, first set $p_{x}$ such that $\exp \left(p_{x} / \sigma\right) \geq n_{x}$, so that $Q_{x}\left(p_{x}, p_{-x}\right) \geq 0$ for all $p_{-x}$. Second, we show that for all $x y$ we must have $D_{x y}\left(-p_{x}, p_{y}\right) \rightarrow+\infty$ when $p_{y} \rightarrow+\infty$. Suppose this is not the case: then there exists an increasing sequence $\left(p_{y}^{n}\right)$ such that $p_{y}^{n} \rightarrow+\infty$ but $D_{x y}\left(-p_{x}, p_{y}^{n}\right) \leq K$ for some constant $K$. By translation invariance, $D_{x y}\left(-p_{x}-K, p_{y}^{n}-K\right) \leq 0$, i.e. $\left(-p_{x}-K, p_{y}^{n}-K\right) \in \mathcal{F}_{x y}$ for all $n$. But since $-p_{x}-K$ is constant (so bounded below) and $p_{y}^{n}-K \rightarrow+\infty$, this contradicts the scarcity assumption. Hence for $p_{y}$ large enough, $\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(-p_{y} / \sigma\right) \leq m_{y}$, i.e. $Q_{y}(p) \geq 0$. A subsolution can be found in a similar manner.

Hence by theorem 2.2. the problem has a unique solution. Finally, since the problem has a solution for any $n_{x}$ and $m_{y}$ the function $Q$ must be surjective, and therefore any Jacobi sequence converges towards the solution according to theorem 2.3 .

We conclude this discussion with a comment on the the optimization structure. If $Q$ were a gradient, one could write $Q_{z}=\partial F / \partial p_{z}$ for some function $F$ and thus

$$
\frac{\partial Q_{y}}{\partial p_{x}}=\frac{\partial^{2} F}{\partial p_{x} \partial p_{y}}=\frac{\partial Q_{x}}{\partial p_{y}}
$$

But we have

$$
\begin{aligned}
& \frac{\partial Q_{x}(p)}{\partial p_{y}}=-\exp \left(-\frac{D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}\right) \frac{\partial_{V} D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma} \\
& \frac{\partial Q_{y}(p)}{\partial p_{x}}=-\exp \left(-\frac{D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}\right) \frac{\partial_{U} D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}
\end{aligned}
$$

which is not symmetric unless

$$
\partial_{U} D_{x y}(U, V)=\partial_{V} D_{x y}(U, V)
$$

This only happens in the optimal transport case, when $D_{x y}(U, V)=(U+V-$ $\left.\Phi_{x y}\right) / 2$.

### 3.4 Full assignment case

Here we assume that $\sum_{x} n_{x}=\sum_{y} m_{y}$. In the previous setting, define the map $Q: \mathbb{R}^{X \cup Y \backslash\left\{y_{0}\right\}} \rightarrow \mathbb{R}^{X \cup Y \backslash\left\{y_{0}\right\}}$ by

$$
\begin{cases}Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)-n_{x}, & x \in X \\ Q_{y}(p)=-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)+m_{y}, & y \in Y \backslash\left\{y_{0}\right\}\end{cases}
$$

where we have normalized $p_{y_{0}}=\pi$. To ensure that $Q$ is responsive in this setting (and therefore that Jacobi updates are well-defined) we will make an additional assumption on the feasible sets $\mathcal{F}_{x y}$ :

Assumption 3.3 (Strong transferability). For all $U$ there exists $V$ such that $(U, V) \in \mathcal{F}_{x y} ;$ and conversely, for all $V$ there exists $U$ such that $(U, V) \in \mathcal{F}_{x y}$.

Under this assumption, any arbitrarily high level of utility is attainable for a partner within a match, as long as the other partner is willing to give up enough utility.

Chen. Choo. Galichon and Weber (2021) show:

Theorem 3.1. The equation $Q(p)=0$ has a solution.

Proof. The proof is constructive and is done in three steps. First, we look for a supersolution to initialize Jacobi's algorithm. Second, we show that Jacobi updates are well-defined. Finally, we show that the Jacobi sequence cannot diverge.

Step 1. Look for a supersolution $p^{0}$. We have

$$
Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)-n_{x} \geq \exp \left(-D_{x y_{0}}\left(-p_{x}, \pi\right)\right)-n_{x}
$$

By strong transferability, there exists $U_{x}$ such that $\left(U_{x}, \pi+\log n_{x}\right) \in \mathcal{F}_{x y}$, i.e. $D_{x y}\left(U_{x}, \pi+\log n_{x}\right) \leq 0$. Taking $p_{x}^{0}=\log n_{x}-U_{x}$, we have $0 \geq D_{x y}\left(-p_{x}^{0}+\right.$ $\left.\log n_{x}, \pi+\log n_{x}\right)=D_{x y}\left(-p_{x}^{0}, \pi\right)+\log n_{x}$, i.e. $\exp \left(-D_{x y}\left(-p_{x}^{0}, \pi\right)\right) \geq n_{x}$, and therefore $Q_{x}\left(p_{x}^{0}, p_{-x}\right) \geq 0$ for all $p_{-x}$. Next, by scarcity we have $D_{x y}\left(-p_{x}^{0}, p_{y}\right) \rightarrow$ $+\infty$ as $p_{y} \rightarrow+\infty$ (see the argument in the proof of proposition 3.2) so we can set $p_{y}^{0}$ large enough such that

$$
\sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{0}, p_{y}^{0}\right)\right) \leq m_{y}
$$

hence $Q_{y}\left(p^{0}\right) \geq 0$ as well, so we have a supersolution.

Step 2. We now show that the Jacobi update from a supersolution is welldefined. The function $p_{x} \mapsto \sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}^{0}\right)\right)-n_{x}$ is continuous, nonnegative for $p_{x}=p_{x}^{0}$, and by scarcity it converges to $-n_{x}<0$ when $p_{x} \rightarrow-\infty$, hence $p_{x}^{1}$ is well-defined.

Now consider the function $p_{y} \mapsto-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{0}, p_{y}\right)\right)+m_{y}$. It is continuous, and nonnegative for $p_{y}=p_{y}^{0}$. Choose an $x$ arbitrarily, then by strong transferability, there exists $V_{y}$ such that $\left(-p_{x}^{0}+\log m_{y}, V_{y}\right) \in \mathcal{F}_{x y}$. We have $0 \geq D_{x y}\left(-p_{x}^{0}+\log m_{y}, V_{y}\right)=D_{x y}\left(-p_{x}^{0}, V_{y}-\log m_{y}\right)+\log m_{y}$, thus $\exp \left(-D_{x y}\left(-p_{x}^{0}, V_{y}-\log m_{y}\right)\right) \geq m_{y}$, and therefore the function above is negative for $p_{y}=V_{y}-\log m_{y}$, hence $p_{y}^{1}$ is also well-defined.

By induction, $p^{t+1}$ is well-defined for all $t$ since $p^{t}$ is also a supersolution.

$\underline{\text { Step 3. Let us show that the Jacobi sequence initialized at the supersolution }}$ $p^{0}$ cannot diverge. $Q$ is a Z-function with isotone aggregates, therefore it is an $\mathrm{M}_{0}$-function, and thus the Jacobi sequence $\left(p^{t}\right)$ starting from $p^{0}$ is a decreasing sequence of supersolutions. Hence, either it converges to a solution, or it is unbounded.

However, because $p^{t}$ is a supersolution, we have

$$
\sum_{x} \exp \left(-D_{x y_{0}}\left(-p_{x}^{t}, \pi\right)\right)-m_{y_{0}}=\sum_{z \in X \cup Y \backslash\left\{y_{0}\right\}} Q_{z}\left(p^{t}\right) \geq 0
$$

thus all the $p_{x}^{t}$ cannot go to $-\infty$. Letting $x^{*}$ be such that $p_{x^{*}}^{t} \rightarrow p_{x^{*}}^{\infty}>-\infty$, we have

$$
\exp \left(-D_{x^{*} y}\left(-p_{x^{*}}^{t}, p_{y}^{t}\right)\right) \leq \sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{t}, p_{y}^{t}\right)\right) \leq m_{y}
$$

thus all $p_{y}^{t}$ remain bounded below as well. Finally, we have

$$
\sum_{y} \exp \left(-D_{x y}\left(-p_{x}^{t}, p_{y}^{t}\right)\right) \geq n_{x}
$$

and thus all the $p_{x}^{t}$ remain bounded below too. Hence the sequence converges.

Uniqueness of the solution is not guaranteed under the strong transferability assumption, because then $Q$ is a $\mathrm{M}_{0}$-function. To obtain uniqueness, one may ask an additional requirement on the feasible sets, which ensures that $Q$ is a M-function and therefore that theorem 2.2 applies. For instance:

Assumption 3.4 (Strong local transferability). For any $(U, V) \in \mathcal{F}_{x y}$ and any $\varepsilon>0$, the open ball of center $(U, V)$ and of radius $\varepsilon$ contains both a point $\left(U^{\prime}, V^{\prime}\right)$ such that $U^{\prime}>U$, and a point $\left(U^{\prime \prime}, V^{\prime \prime}\right) \in \mathcal{F}_{x y}$ such that $V^{\prime \prime}>V$.

This assumption rules out horizontal or vertical slopes on the frontier of $\mathcal{F}_{x y}$, which ensures that $Q$ is an M-function.

## References and notes

This section draws upon Galichon. Kominers and Weber (2019). The case with full assignment is covered in Chen, Choo, Galichon and Weber (2021).
</end of paper 3>


